THREE.PlaneGeometry2=function(a,b,c,d){THREE.Geometry.call(this);for(var e=a/2,f=b/2,c=c||1,d=d||1,g=c+1,h=d+1,j=a/c,l=b/d,k=new THREE.Vector3(0,0,1),a=0;a<h;a++)for(b=0;b<g;b++)this.vertices.push(new THREE.Vector3(b*j-e,-(a*l-f),0));for(a=0;a<d;a++)for(b=0;b<c;b++)e=new THREE.Face4(b+g*a,b+g*(a+1),b+1+g*(a+1),b+1+g*a),e.normal.copy(k),e.vertexNormals.push(k.clone(),k.clone(),k.clone(),k.clone()),this.faces.push(e),this.faceVertexUvs[0].push([new THREE.UV(b/c,a/d),new THREE.UV(b/c,(a+1)/d),new THREE.UV((b+
1)/c,(a+1)/d),new THREE.UV((b+1)/c,a/d)]);this.computeCentroids()};THREE.PlaneGeometry2.prototype=new THREE.Geometry;THREE.PlaneGeometry2.prototype.constructor=THREE.PlaneGeometry;THREE.WedgeGeometry=function(a,b,c,d,e,f,g){function h(a,b,c,d,e,f,g){var h,j,n=c/2,m=d/2,q=k.vertices.length;for(j=0;2>j;j++)for(h=0;2>h;h++){var p=new THREE.Vector3;p.x=-1==a&&0==h&&0==j?(h*c-n-f)*a:1==a&&1==h&&0==j?(h*c-n+f)*a:(h*c-n)*a;p.y=(j*d-m)*b;p.z=e;k.vertices.push(p)}l(q,g)}function j(a,b,c,d,e,f,g,h,j){var n,m,q,p=e/2,r=f/2,L=k.vertices.length;if("x"==a&&"y"==b||"y"==a&&"x"==b)n="z";else if("x"==a&&"z"==b||"z"==a&&"x"==b)n="y";else if("z"==a&&"y"==b||"y"==a&&"z"==b)n="x";for(q=0;2>q;q++)for(m=
0;2>m;m++){var F=new THREE.Vector3;F[a]=1==m&&"x"===a&&"z"===b&&1===d?(m*e-p+h)*c:(m*e-p)*c;F[b]=(q*f-r)*d;F[n]=g;k.vertices.push(F)}l(L,j)}function l(a,b){k.faces.push(new THREE.Face4(0+a,2+a,3+a,1+a,null,null,b));k.faceVertexUvs[0].push([new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,1),new THREE.UV(1,0)])}THREE.Geometry.call(this);var k=this,m=a/2,n=b/2,q=c/2,f=f?-1:1;if(void 0!==e)if(e instanceof Array)this.materials=e;else{this.materials=[];for(var r=0;6>r;r++)this.materials.push([e])}else this.materials=
[];this.sides={px:!0,nx:!0,py:!0,ny:!0,pz:!0,nz:!0};if(void 0!=g)for(var s in g)void 0!=this.sides[s]&&(this.sides[s]=g[s]);this.sides.px&&j("z","y",1*f,-1,c,b,-m,d,this.materials[0]);if(this.sides.nx){for(var e=-1*f,g=this.materials[1],w=c/2,p=b/2,u=k.vertices.length,r=0;2>r;r++)for(s=0;2>s;s++){var x=new THREE.Vector3;x.z=(s*c-w)*e;x.y=-1*(r*b-p);x.x=0===r?m+d:m;k.vertices.push(x)}l(u,g)}this.sides.py&&j("x","z",1*f,1,a,c,n,d,this.materials[2]);this.sides.ny&&j("x","z",1*f,-1,a,c,-n,d,this.materials[3]);
this.sides.pz&&h(1*f,-1,a,b,q,d,this.materials[4]);this.sides.nz&&h(-1*f,-1,a,b,-q,d,this.materials[5]);a=[];b=[];c=0;for(d=k.vertices.length;c<d;c++){m=k.vertices[c];n=!1;q=0;for(f=a.length;q<f;q++)if(e=a[q],m.x==e.x&&m.y==e.y&&m.z==e.z){b[c]=q;n=!0;break}n||(b[c]=a.length,a.push(m.clone()))}c=0;for(d=k.faces.length;c<d;c++)m=k.faces[c],m.a=b[m.a],m.b=b[m.b],m.c=b[m.c],m.d=b[m.d];k.vertices=a;this.computeCentroids();this.computeFaceNormals()};THREE.WedgeGeometry.prototype=new THREE.Geometry;
THREE.WedgeGeometry.prototype.constructor=THREE.WedgeGeometry;THREE.EllipseGeometry=function(a,b,c,d){THREE.Geometry.call(this);var a=a||20,b=b||10,c=c||0,d=(d||360)-c,d=0>d?d+360:d,e=e||20;this.vertices.push(new THREE.Vector3(0,0,0));for(var f=0;f<=e;f++){var g=f/e*d,h=a*Math.cos((c+g)/180*Math.PI),g=b*Math.sin((c+g)/180*Math.PI);this.vertices.push(new THREE.Vector3(h,g,0));0<f&&this.faces.push(new THREE.Face3(0,this.vertices.length-2,this.vertices.length-1))}this.computeCentroids();this.computeFaceNormals()};THREE.EllipseGeometry.prototype=new THREE.Geometry;
THREE.EllipseGeometry.prototype.constructor=THREE.EllipseGeometry;THREE.PipeGeometry=function(a,b){THREE.Geometry.call(this);var c,d,e=new THREE.Vector3(Math.random(),Math.random(),Math.random());for(d=0;d<b.length-1;d++){var f=[],g=[],h=d,j=b[d],l=b[d+1];c=(new THREE.Vector3).sub(l,j);var k=(new THREE.Vector3).cross(c,e).normalize(),m=(new THREE.Vector3).cross(c,k).normalize();for(c=0;5>=c;c++){var n=c/5;Math.cos(2*n*Math.PI);Math.sin(n*Math.PI);Math.cos(2*n*Math.PI);Math.sin(n*Math.PI);Math.cos(2*n*Math.PI);Math.sin(n*Math.PI);var q=new THREE.Vector3(j.x+k.x*
Math.cos(2*n*Math.PI)+m.x*Math.sin(2*n*Math.PI),j.y+k.y*Math.cos(2*n*Math.PI)+m.y*Math.sin(2*n*Math.PI),j.z+k.z*Math.cos(2*n*Math.PI)+m.z*Math.sin(2*n*Math.PI));this.vertices.push(q);f.push(this.vertices.length-1);g.push(new THREE.UV(n,h));n=c/5;Math.cos(2*n*Math.PI);Math.sin(n*Math.PI);Math.cos(2*n*Math.PI);Math.sin(n*Math.PI);Math.cos(2*n*Math.PI);Math.sin(n*Math.PI);q=new THREE.Vector3(l.x+k.x*Math.cos(2*n*Math.PI)+m.x*Math.sin(2*n*Math.PI),l.y+k.y*Math.cos(2*n*Math.PI)+m.y*Math.sin(2*n*Math.PI),
l.z+k.z*Math.cos(2*n*Math.PI)+m.z*Math.sin(2*n*Math.PI));this.vertices.push(q);f.push(this.vertices.length-1);g.push(new THREE.UV(n,h))}for(c=0;5>c;c++){var h=f[2*c],j=f[2*c+1],l=f[2*c+3],k=f[2*c+2],m=this.vertices[h].clone().setY(0).normalize(),n=this.vertices[j].clone().setY(0).normalize(),q=this.vertices[l].clone().setY(0).normalize(),r=this.vertices[k].clone().setY(0).normalize(),s=g[2*c].clone(),w=g[2*c+1].clone(),p=g[2*c+3].clone(),u=g[2*c+2].clone();this.faces.push(new THREE.Face4(h,j,l,k,
[m,n,q,r]));this.faceVertexUvs[0].push([s,w,p,u])}}this.computeCentroids();this.computeFaceNormals()};THREE.PipeGeometry.prototype=new THREE.Geometry;THREE.PipeGeometry.prototype.constructor=THREE.PipeGeometry;var SS=SS||{};SS.Spinner=function(){var a=0;this.show=function(){0==a&&(0==$("#progress-container").children().size()&&$("#progress-container").append('<div id="progress"><img src="/static/images/progress-spinner.gif" alt="in progress"/></div>'),$("#progress").show());++a};this.hide=function(){--a;0==a&&$("#progress").hide()}};SS.spinner=new SS.Spinner;SS.withSpinner=function(a){SS.spinner.show();try{a()}catch(b){console.error(b)}SS.spinner.hide()};SS=SS||{};
(function(){var a=function(a,c){var d=$('<span class="delete-button"></span>'),e=$('<li class="'+c+'">'+a+"</li>");e.append(d);$("#messages-container ol").append(e);d.click(function(){e.remove()});e.delay("info"===c?2E3:4E3).fadeOut(500,function(){e.remove()})};SS.renderInfoMessage=function(b){a(b,"info")};SS.renderErrorMessage=function(b){try{if(b=JSON.parse(b),$("tr.field").removeClass("validation-error"),b.validation)for(var c in b.validation)$("#"+c).parents("tr.field").addClass("validation-error")}catch(d){b={exception:d}}if(b.validation){c=
[];for(key in b.validation)c.push(key+":"+b.validation[key]);a(c.join(", "),"error");console.log(b)}else b.string?a(b.string,"error"):b.error?a(b.error,"error"):a("Sorry. An unknown problem occurred","error")}})();function Stack(){var a=[];this.push=function(b){a.push(b)};this.peek=function(){return 0==a.length?void 0:a[a.length-1]};this.pop=function(){if(0==a.length)throw"empty";return a.pop()}};SS=SS||{};function Command(a,b,c){this.execute=function(){a()};this.undo=function(){b()};this.redo=function(){c()}}
SS.CommandStack=function(){var a,b,c=new Stack,d=new Stack;_.extend(this,Backbone.Events);this.commit=function(){b.fromCommit=SS.session.commit;SS.commit()};this.pop=function(a){this.trigger("beforePop");if(c.peek()&&c.peek().fromCommit===a)return console.info("UNDO: "+c.peek().fromCommit),this.undo(),!0;if(d.peek()&&d.peek().toCommit===a)return console.info("REDO: "+d.peek().toCommit),this.redo(),!0};this.execute=function(d){a=function(){d.toCommit=SS.session.commit;c.push(d)};SS.spinner.show();
b=d;d.execute()};this.undo=function(){if(!this.canUndo())throw"Nothing to undo";SS.spinner.show();a=function(){d.push(c.pop())};c.peek().undo()};this.redo=function(){if(!this.canRedo())throw"Nothing to redo";SS.spinner.show();a=function(){c.push(d.pop())};d.peek().redo()};this.canUndo=function(){return void 0!==c.peek()};this.canRedo=function(){return void 0!==d.peek()};this.success=function(){a();SS.spinner.hide()};this.error=function(a){SS.renderErrorMessage(a);SS.spinner.hide()}};SS=SS||{};function Transform(a){if(!a.type)throw Error("type is not defined");this.editing=a.editing;this.type=a.type;this.origin=a.origin;this.parameters=a.parameters}Transform.prototype.editableCopy=function(){var a={};for(key in this.parameters)a[key]=this.parameters[key];return new Transform({type:this.type,origin:this.origin,parameters:a,editing:this.editing})};Transform.prototype.json=function(){return JSON.stringify({type:this.type,origin:this.origin,parameters:this.parameters})};
SS.createNextGeomNodeCounter=function(){var a=0;return function(){++a;return a}};SS.nextGeomCounter=SS.createNextGeomNodeCounter();SS.resetGeomCounter=function(){SS.nextGeomCounter=SS.createNextGeomNodeCounter()};
function GeomNode(a,b){var c=this;this.setSHA=function(a){c.sha=a;c.id=SS.nextGeomCounter()+"_"+c.sha};if(!a.type)throw Error("type is not defined");this.editing=a.editing||!1;this.type=a.type;this.sha=a.sha;this.id=SS.nextGeomCounter()+"_"+this.sha;this.origin=a.origin;this.contents=a.contents;this.parameters=SS.copyObj(a.parameters);this.mesh=a.mesh;this.children=[];this.workplane=a.workplane?new SS.WorkplaneNode(a.workplane):new SS.WorkplaneNode;this.transforms=(a.transforms||[]).map(function(a){return new Transform(a)});
if(b){if("object"==!typeof b)throw Error("Children must be array");for(var d in b)this.children.push(b[d])}}GeomNode.prototype.isPreview=function(){return void 0===this.sha};
GeomNode.prototype.editableCopy=function(){var a=null;if(this.origin)for(key in a={},this.origin)a[key]=this.origin[key];var b=SS.copyObj(this.workplane),c=SS.copyObj(this.parameters),d=this.transforms.map(function(a){return a.editableCopy()});return new GeomNode({type:this.type,contents:this.contents,origin:a,parameters:c,workplane:b,transforms:d,mesh:this.mesh},this.children)};
GeomNode.prototype.toShallowJson=function(){var a={type:this.type,parameters:this.parameters,contents:this.contents,children:this.children.map(function(a){return a.sha}),transforms:this.transforms.map(function(a){return JSON.parse(a.json())})};(new SS.WorkplaneNode(this.workplane)).isGlobalXY()||(a.workplane=this.workplane.serializableSubset());this.origin&&(a.origin=this.origin);return JSON.stringify(a)};
GeomNode.fromDeepJson=function(a){var b=a.geometry,c=a.geometry.children;a.geometry.children&&delete a.geometry.children;b.sha=a.sha;a=new GeomNode(b);c&&0<c.length&&(a.children=c.map(function(a){return GeomNode.fromDeepJson(a)}));return a};GeomNode.prototype.isTransformEditing=function(){return 0<=_.pluck(this.transforms,"editing").indexOf(!0)};GeomNode.prototype.isEditingOrTransformEditing=function(){return this.editing||this.isTransformEditing()};SS=SS||{};SS.WorkplaneNode=function(a){this.origin=a&&a.origin||{x:0,y:0,z:0};this.axis=a&&a.axis||{x:0,y:0,z:1};this.angle=a&&a.angle||0;this.type="workplane"};SS.WorkplaneNode.prototype.editableCopy=function(){var a={},b=this;["origin","axis","extents"].map(function(c){a[c]={};for(key in b[c])a[c][key]=b[c][key]});a.angle=b.angle;a.boundary=b.boundary;return new SS.WorkplaneNode(a)};
SS.WorkplaneNode.prototype.serializableSubset=function(){var a=SS.copyObj(this);delete a.extents;delete a.boundary;return a};SS.WorkplaneNode.prototype.isGlobalXY=function(){return 0===this.origin.x&&0===this.origin.y&&0===this.origin.z&&0===this.axis.x&&0===this.axis.y&&1===this.axis.z&&0===this.angle};
SS.WorkplaneNode.prototype.isEqual=function(a){return this.origin.x===a.origin.x&&this.origin.y===a.origin.y&&this.origin.z===a.origin.z&&this.axis.x===a.axis.x&&this.axis.y===a.axis.y&&this.axis.z===a.axis.z&&this.angle===a.angle};function GeomDocument(){_.extend(this,Backbone.Events);this.rootNodes=[];this.isRoot=function(a){return-1<this.rootNodes.indexOf(a)};this.add=function(a){this.rootNodes=[a].concat(this.rootNodes);this.trigger("add",a)};this.removeAll=function(){for(index in this.rootNodes)this.trigger("remove",this.rootNodes[index]);this.rootNodes=[]};this.remove=function(a){this.trigger("beforeRemove",a);var b=this.rootNodes.indexOf(a);-1!==b&&(this.rootNodes.splice(b,1),this.trigger("remove",a))};this.replace=function(a,
b){this.trigger("beforeReplace",a,b);var c=function(d){var e=d.indexOf(a);if(-1!==e)d.splice(e,1,b);else for(i in d)c(d[i].children)};c(this.rootNodes);this.trigger("replace",a,b)};this.removeById=function(a){var b=[],c;for(c in this.rootNodes)this.rootNodes[c].id==a&&b.push(this.rootNodes[c]);for(c in b)this.remove(b[c])};this.findById=function(a){var b=function(c){if(c.id==a)return c;for(var d in c.children){var g=b(c.children[d]);if(g)return g}return null},c;for(c in this.rootNodes){var d=b(this.rootNodes[c]);
if(d)return d}return null};this.ancestors=function(a){var b=function(d,f){if(d==a)return f;var g=f.slice();g.push(d);for(c in d.children){var h=b(d.children[c],g);if(h)return h}return null},c;for(c in this.rootNodes){var d=b(this.rootNodes[c],[]);if(d)return d.reverse()}throw Error("node not found");}};SS=SS||{};SS.schemas={};SS.schemas.vectorSchema={type:"object",properties:{x:{type:"number"},y:{type:"number"},z:{type:"number"}}};SS.schemas.workplane={description:"Workplane",type:"object",properties:{origin:SS.schemas.vectorSchema,axis:SS.schemas.vectorSchema,angle:{type:"number"}}};SS.schemas.cuboid={description:"Cuboid",type:"object",properties:{workplane:SS.schemas.workplane,origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{u:{type:"number"},v:{type:"number"},w:{type:"number"}}}}};
SS.schemas.sphere={description:"Sphere",type:"object",properties:{workplane:SS.schemas.workplane,origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{r:{type:"number"}}}}};SS.schemas.cylinder={description:"Cylinder",type:"object",properties:{workplane:SS.schemas.workplane,origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{r:{type:"number"},h:{type:"number"}}}}};
SS.schemas.cone={description:"Cone",type:"object",properties:{workplane:SS.schemas.workplane,origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{r1:{type:"number"},h:{type:"number"},r2:{type:"number"}}}}};SS.schemas.wedge={description:"Wedge",type:"object",properties:{workplane:SS.schemas.workplane,origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{u1:{type:"number"},u2:{type:"number"},v:{type:"number"},w:{type:"number"}}}}};
SS.schemas.torus={description:"Torus",type:"object",properties:{origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{r1:{type:"number"},r2:{type:"number"}}}}};SS.schemas.ellipse2d={description:"Ellipse2D",type:"object",properties:{workplane:SS.schemas.workplane,origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{r1:{type:"number"},r2:{type:"number"},from_angle:{type:"number"},to_angle:{type:"number"}}}}};
SS.schemas.ellipse1d={description:"Ellipse1D",type:"object",properties:{workplane:SS.schemas.workplane,origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{r1:{type:"number"},r2:{type:"number"},from_angle:{type:"number"},to_angle:{type:"number"}}}}};SS.schemas.rectangle2d={description:"Rectangle2D",type:"object",properties:{workplane:SS.schemas.workplane,origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{u:{type:"number"},v:{type:"number"}}}}};
SS.schemas.triangle2d={description:"Triangle2D",type:"object",properties:{workplane:SS.schemas.workplane,origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{vertices:{type:"array",items:{type:"object",properties:{u:{type:"number"},v:{type:"number"},w:{type:"number"}}},minItems:3,maxItems:3}}}}};
SS.schemas.polyline={description:"Polyline",type:"object",properties:{workplane:SS.schemas.workplane,origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{vertices:{type:"array",items:{type:"object",properties:{u:{type:"number"},v:{type:"number"},w:{type:"number"}}},minItems:2}}}}};
SS.schemas.bezier={description:"Bezier",type:"object",properties:{workplane:SS.schemas.workplane,origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{vertices:{type:"array",items:{type:"object",properties:{u:{type:"number"},v:{type:"number"},w:{type:"number"}}},minItems:4,maxItems:4}}}}};
SS.schemas.text2d={description:"Text2D",type:"object",properties:{workplane:SS.schemas.workplane,origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{font:{type:"string","enum":["OpenSans","DroidSerif","Inconsolata","Lobster"]},text:{type:"string"}}}}};SS.schemas.prism={description:"Prism",type:"object",properties:{workplane:SS.schemas.workplane,origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{u:{type:"number"},v:{type:"number"},w:{type:"number"}}}}};
SS.schemas.fillet={description:"Fillet",type:"object",properties:{parameters:{type:"object",properties:{r:{type:"number"}}}}};SS.schemas.revolve={description:"Revolve",type:"object",properties:{workplane:SS.schemas.workplane,origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{u:{type:"number"},v:{type:"number"},w:{type:"number"},angle:{type:"number"}}}}};SS.schemas.intersect={description:"Intersect",type:"object",properties:{workplane:SS.schemas.workplane}};
SS.schemas.union={description:"Intersect",type:"object",properties:{workplane:SS.schemas.workplane}};SS.schemas.subtract={description:"Intersect",type:"object",properties:{workplane:SS.schemas.workplane}};SS.schemas.make_face={description:"Make Face",type:"object",properties:{}};SS.schemas.make_solid={description:"Make Solid",type:"object",properties:{}};SS.schemas.loft={description:"Loft",type:"object",properties:{}};
SS.schemas.translate={description:"Translate",type:"object",properties:{origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{u:{type:"number"},v:{type:"number"},w:{type:"number"},n:{type:"integer",minimum:0}}}}};SS.schemas.scale={description:"Scale",type:"object",properties:{origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{factor:{type:"number"}}}}};
SS.schemas.rotate={description:"Rotate",type:"object",properties:{origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{u:{type:"number"},v:{type:"number"},w:{type:"number"},angle:{type:"number"},n:{type:"integer",minimum:0}}}}};SS.schemas.mirror={description:"Mirror",type:"object",properties:{origin:SS.schemas.vectorSchema,parameters:{type:"object",properties:{u:{type:"number"},v:{type:"number"},w:{type:"number"},n:{type:"integer",minimum:0}}}}};
SS.schemas.import_stl={description:"STL",type:"object",properties:{}};SS.schemas.axis_mirror=SS.schemas.mirror;SS.schemas.plane_mirror=SS.schemas.mirror;SS=SS||{};SS.colors={};SS.colors.white=16777215;SS.colors.red=16711680;SS.colors.green=65280;SS.colors.blue=255;SS.colors.xAxis=SS.colors.blue;SS.colors.yAxis=SS.colors.green;SS.colors.zAxis=SS.colors.red;SS.colors.fadingGrid=6726098;SS.materials={};SS.materials.lineColor=6726098;SS.materials.faceColor=745381;SS.materials.faceMaterial=new THREE.MeshBasicMaterial({color:SS.materials.faceColor,transparent:!0,opacity:0.2});SS.materials.solidFaceMaterial=new THREE.MeshBasicMaterial({color:SS.materials.faceColor});
SS.materials.lineMaterial=new THREE.LineBasicMaterial({color:SS.materials.lineColor,wireframe:!0,linewidth:1});SS.materials.wireframeMaterial=new THREE.MeshBasicMaterial({color:SS.materials.lineColor,wireframe:!0});SS.materials.anchorGeometry=new THREE.CubeGeometry(1,1,1);SS.materials.anchorMaterial=new THREE.MeshBasicMaterial({color:6726097,opacity:0.8,wireframe:!1});SS.materials.constructionLineMaterial=new THREE.LineBasicMaterial({color:7829367,wireframe:!0,linewidth:1});
SS.materials.gridMajor=new THREE.LineBasicMaterial({color:6726098,opacity:0.2,transparent:!0});SS.materials.gridMinor=new THREE.LineBasicMaterial({color:6726098,opacity:0.02,transparent:!0});SS.materials.globalXYPlane=[new THREE.MeshBasicMaterial({color:3355443,wireframe:!0})];SS=SS||{};
(function(){SS.createGeometry=function(a){if(a.mesh){var c=56576,d=1,e=a.editing;for(index in a.transforms)a.transforms[index].editing&&(e=!0);e&&(c=14540032,d=0.5);var f={geomNodeId:a.id};e=a.mesh.faces;if(0===e.positions.length)e=[];else{for(var g=new THREE.Geometry,h=0;h<e.positions.length/3;++h){var j=new THREE.Vector3(e.positions[3*h],e.positions[3*h+1],e.positions[3*h+2]);g.vertices.push(j)}for(h=0;h<e.indices.length/3;++h){var j=e.indices[3*h],l=e.indices[3*h+1],k=e.indices[3*h+2],m=new THREE.Face3(j,
l,k);m.vertexNormals=[new THREE.Vector3(e.normals[3*j],e.normals[3*j+1],e.normals[3*j+2]),new THREE.Vector3(e.normals[3*l],e.normals[3*l+1],e.normals[3*l+2]),new THREE.Vector3(e.normals[3*k],e.normals[3*k+1],e.normals[3*k+2])];g.faces.push(m)}g.computeCentroids();g.computeFaceNormals();g.mergeVertices();g.dynamic=!0;e=[g]}var n=new THREE.MeshPhongMaterial({ambient:c,color:c,opacity:d,specular:c,shininess:50,shading:THREE.SmoothShading,transparent:!0}),q=new THREE.Object3D;e.map(function(a){a=new THREE.Mesh(a,
n);a.doubleSided=!0;a.name=f;q.add(a)});q.name=f;var r=a.mesh.edges,s=Math.pow(10,4),w=function(a){return[Math.round(a.x*s),Math.round(a.y*s),Math.round(a.z*s)].join("_")},p={},u={},x=[];r.segments.map(function(a){for(var b=[],c=a.start;c<a.end;c+=3){var d=new THREE.Vector3(r.positions[c],r.positions[c+1],r.positions[c+2]);b.push(d)}c=b[b.length-1];a=w(b[0]);c=w(c);x.push(b);p[a]=p[a]||[];p[a].push(b);u[c]=u[c]||[];u[c].push(b)});do for(vertexKey in g=!1,p)!g&&(0<p[vertexKey].length&&u[vertexKey]&&
0<u[vertexKey].length)&&(d=u[vertexKey][0],e=p[vertexKey][0],d!==e&&(g=[].concat(d).concat(e),newSegmentStartKey=w(g[0]),newSegmentEndKey=w(g[g.length-1]),x.splice(x.indexOf(d),1),x.splice(x.indexOf(e),1),x.push(g),p[vertexKey].splice(p[vertexKey].indexOf(e),1),p[newSegmentStartKey].splice(p[newSegmentStartKey].indexOf(d),1),u[vertexKey].splice(u[vertexKey].indexOf(d),1),u[newSegmentEndKey].splice(u[newSegmentEndKey].indexOf(e),1),p[newSegmentStartKey].push(g),u[newSegmentEndKey].push(g),g=!0));while(g);
var d=x.map(function(a){var b=new THREE.Geometry;b.vertices=a;b.dynamic=!0;return b}),D=new THREE.LineBasicMaterial({color:c,opacity:1,linewidth:2,transparent:!0}),z=new THREE.Object3D;d.map(function(a){a=new THREE.Line(a,D);a.name=f;z.add(a)});z.name=f;var B=new THREE.Object3D;if(0===q.children.length){var t=a.mesh.edges;t.segments.map(function(a){for(var b=[],c=a.start;c<a.end;c+=3)b.push(new THREE.Vector3(t.positions[c],t.positions[c+1],t.positions[c+2]));return new THREE.PipeGeometry(3,b)}).map(function(a){a=
new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:0,opacity:0,transparent:!0}));a.name=f;a.doubleSided=!0;B.add(a)});B.name=f}return{faces:q,edges:z,selectionForEdges:B}}};SS.renderGeometry=function(a){var c=SS.createGeometry(a);c&&(SS.sceneView.scene.add(c.faces),SS.sceneView.scene.add(c.edges),SS.sceneView.selectionOnlyMeshes.push(c.selectionForEdges),a.sceneObjects=c)};SS.hideGeometry=function(a){if(a.sceneObjects){for(key in a.sceneObjects)if("selectionForEdges"===key){var c=SS.sceneView.selectionOnlyMeshes.indexOf(a.sceneObjects[key]);
SS.sceneView.selectionOnlyMeshes.splice(c,1)}else SS.sceneView.scene.remove(a.sceneObjects[key]);a.sceneObjects={}}};SS.highlightGeometry=function(a){for(key in a.sceneObjects){var c=a.sceneObjects[key];"selectionForEdges"!==key&&(SS.sceneView.scene.remove(c),SS.sceneView.scene.add(c))}a.sceneObjects.faces.children.map(function(a){a.material.color.setHex(14540032);a.material.ambient.setHex(14540032);a.material.specular.setHex(14540032);a.material.opacity=0.7});a.sceneObjects.edges.children.map(function(a){a.material.color.setHex(14540032);
a.material.opacity=0.7})};SS.unhighlightGeometry=function(a){SS.restoreOpacity();a.sceneObjects.faces.children.map(function(a){a.material.color.setHex(56576);a.material.ambient.setHex(56576);a.material.specular.setHex(56576);a.material.opacity=1});a.sceneObjects.edges.children.map(function(a){a.material.color.setHex(56576);a.material.opacity=1})};SS.setTransparent=function(a){for(key in a.sceneObjects)a.sceneObjects[key].children.map(function(a){1===a.material.opacity&&(a.material.opacity=0.5)})};
SS.restoreOpacity=function(){geom_doc.rootNodes.map(function(a){if(a.sceneObjects)for(key in a.sceneObjects)a.sceneObjects[key].children.map(function(a){"selectionForEdges"!==key&&1!==a.material.opacity&&(a.material.opacity=1)})})};SS.translateGeomNodeRendering=function(a,c,d){for(key in c.sceneObjects)for(var e=0;e<c.sceneObjects[key].children.length;++e){var f=a.originalSceneObjects[key].children[e].geometry,g=c.sceneObjects[key].children[e].geometry,h=SS.objToVector(a.workplane.axis),j=a.workplane.angle,
l=SS.objToVector(d);g.vertices=f.vertices.map(function(a){a=a.clone();a.addSelf(SS.rotateAroundAxis(l,h,j));return a});g.computeCentroids();g.computeFaceNormals();g.verticesNeedUpdate=!0}};SS.scaleGeomNodeRendering=function(a,c,d,e){var f=SS.objToVector(a.workplane.axis),g=SS.rotateAroundAxis(d,f,a.workplane.angle);g.addSelf(SS.objToVector(a.workplane.origin));for(key in c.sceneObjects)for(d=0;d<c.sceneObjects[key].children.length;++d)f=c.sceneObjects[key].children[d].geometry,f.vertices=a.originalSceneObjects[key].children[d].geometry.vertices.map(function(a){a=
a.clone();return(new THREE.Vector3).add(g,(new THREE.Vector3).sub(a,g).multiplyScalar(e))}),f.computeCentroids(),f.computeFaceNormals(),f.verticesNeedUpdate=!0};SS.rotateGeomNodeRendering=function(a,c,d){var e=SS.objToVector(a.workplane.origin),f=SS.objToVector(a.workplane.axis),g=a.workplane.angle,h=SS.objToVector(d.origin),j=SS.objToVector(d.parameters),l=SS.rotateAroundAxis(j,f,g),k=d.parameters.angle,m=SS.rotateAroundAxis(h,f,g);for(key in c.sceneObjects)for(d=0;d<c.sceneObjects[key].children.length;++d)f=
c.sceneObjects[key].children[d].geometry,f.vertices=a.originalSceneObjects[key].children[d].geometry.vertices.map(function(a){a=a.clone();a.subSelf(e);a.subSelf(m);a=SS.rotateAroundAxis(a,l,k);a.addSelf(m);a.addSelf(e);return a}),f.computeCentroids(),f.computeFaceNormals(),f.verticesNeedUpdate=!0};SS.axisMirrorGeomNodeRendering=function(a,c,d){var e=SS.objToVector(a.workplane.origin),f=SS.objToVector(a.workplane.axis),g=a.workplane.angle,h=SS.objToVector(d.origin),d=SS.objToVector(d.parameters),j=
SS.rotateAroundAxis(d,f,g),l=SS.rotateAroundAxis(h,f,g);for(key in c.sceneObjects)for(f=0;f<c.sceneObjects[key].children.length;++f)g=c.sceneObjects[key].children[f].geometry,g.vertices=a.originalSceneObjects[key].children[f].geometry.vertices.map(function(a){a=a.clone();a.subSelf(e);a.subSelf(l);a=SS.rotateAroundAxis(a,j,180);a.addSelf(l);a.addSelf(e);return a}),g.computeCentroids(),g.computeFaceNormals(),g.verticesNeedUpdate=!0};SS.planeMirrorGeomNodeRendering=function(a,c,d){var e=SS.objToVector(a.workplane.origin),
f=SS.objToVector(d.parameters).normalize().negate(),g=SS.objToVector(a.workplane.axis),h=a.workplane.angle,j=SS.rotateAroundAxis(f,g,h),d=SS.objToVector(d.origin),l=SS.rotateAroundAxis(d,g,h);for(key in c.sceneObjects)for(g=0;g<c.sceneObjects[key].children.length;++g)h=c.sceneObjects[key].children[g].geometry,h.vertices=a.originalSceneObjects[key].children[g].geometry.vertices.map(function(a){var a=a.clone().subSelf(e),b=(new THREE.Vector3).sub(a,l).dot(j),b=j.clone().multiplyScalar(-2*b),a=(new THREE.Vector3).add(a,
b);a.addSelf(e);return a}),h.computeCentroids(),h.computeFaceNormals(),h.verticesNeedUpdate=!0};SS.boundingBoxForSceneObject=function(a){var c=[],d=function(a){a.geometry&&(a.geometry.computeBoundingBox(),a.geometry.boundingBox&&c.push(a.geometry.boundingBox));for(f in a.children)d(a.children[f])};d(a);if(0==c.length)return{min:new THREE.Vector3(0,0,0),max:new THREE.Vector3(0,0,0)};for(var a=c[0].min,e=c[0].max,f=1;f<c.length;++f){var g=c[f];a.x=Math.min(a.x,g.min.x);a.y=Math.min(a.y,g.min.y);a.z=
Math.min(a.z,g.min.z);e.x=Math.max(e.x,g.max.x);e.y=Math.max(e.y,g.max.y);e.z=Math.max(e.z,g.max.z)}return{min:a,max:e}};var a=function(a,c){var d=[],e=function(c){(c=SS.computeNormalizedBoundingBox(a,c.geometry))&&d.push(c)};c.sceneObjects&&c.sceneObjects.edges&&c.sceneObjects.edges.children.map(e);c.sceneObjects&&c.sceneObjects.faces&&c.sceneObjects.faces.children.map(e);if(0!=d.length){for(var e=d[0].min,f=d[0].max,g=1;g<d.length;++g){var h=d[g];e.x=Math.min(e.x,h.min.x);e.y=Math.min(e.y,h.min.y);
e.z=Math.min(e.z,h.min.z);f.x=Math.max(f.x,h.max.x);f.y=Math.max(f.y,h.max.y);f.z=Math.max(f.z,h.max.z)}return{min:e,max:f}}};SS.boundingBoxForGeomNode=function(b){return a(new SS.WorkplaneNode,b)};SS.normalizedBoundingBoxForGeomNode=function(b){return a(b.workplane,b)};SS.computeNormalizedBoundingBox=function(a,c){var d={min:new THREE.Vector3,max:new THREE.Vector3},e=SS.objToVector(a.axis),f=a.angle,g=SS.objToVector(a.origin);if(0<c.vertices.length){var h=SS.rotateAroundAxis(c.vertices[0].clone().subSelf(g),
e,-f);d.min.copy(h);d.max.copy(h);for(var j=d.min,l=d.max,k=1,m=c.vertices.length;k<m;++k)h=SS.rotateAroundAxis(c.vertices[k].clone().subSelf(g),e,-f),h.x<j.x?j.x=h.x:h.x>l.x&&(l.x=h.x),h.y<j.y?j.y=h.y:h.y>l.y&&(l.y=h.y),h.z<j.z?j.z=h.z:h.z>l.z&&(l.z=h.z);return d}};SS.centerOfGeom=function(a){return(new THREE.Vector3).add(a.min,(new THREE.Vector3).sub(a.max,a.min).divideScalar(2))};SS.normalizedBoundingRadius=function(a){return(new THREE.Vector3).sub(a.max,a.min).length()/2}})();SS=SS||{};SS.renderDisplayDOM=function(a,b,c){b=SS.renderRecursiveDisplayDOM(a,b,c);return $.mustache("<table>{{#rows}}<tr><td>{{{.}}}</td></tr>{{/rows}}</table>",{rows:[a,b]})};
SS.renderRecursiveDisplayDOM=function(a,b,c){if("number"===b.type||"string"===b.type)return $.mustache('<span class="value">{{value}}</span>',{value:c});if("object"===b.type){a=[];for(key in b.properties)a.push({name:key,dom:SS.renderRecursiveDisplayDOM(key,b.properties[key],c[key])});return $.mustache("<table>{{#rows}}<tr><td>{{name}}</td><td>{{{dom}}}</td></tr>{{/rows}}</table>",{rows:a})}if("array"===b.type)return a=c.map(function(a){SS.renderRecursiveDisplayDOM(key,b.items,a)}),$.mustache("<table>{{#rows}}<tr><td>{{{.}}}</td></tr>{{/rows}}</table>",
{rows:a})};SS.renderEditingDOM=function(a,b,c,d){b=SS.renderRecursiveEditingDOM([a],a,b,c);a=[a,b];d&&a.push(d);a.push('<input class="ok" type="submit" value="Ok"/><input class="cancel" type="submit" value="Cancel"/>');return $.mustache("<table>{{#rows}}<tr><td>{{{.}}}</td></tr>{{/rows}}</table>",{rows:a})};
SS.renderRecursiveEditingDOM=function(a,b,c,d){var e=a.join("_");if("number"===c.type||"integer"===c.type)return $.mustache('<input class="field {{name}}" type="number" value="{{value}}" {{#min}}min="{{.}}"{{/min}} {{#max}}max="{{.}}"{{/max}} />',{name:b,value:d,min:c.minimum,max:c.maximum});if("string"===c.type)return c["enum"]?(b={name:b,options:c["enum"]},$.mustache('<select class="field {{name}}" name={{name}}>{{#options}}<option value="{{.}}">{{.}}</option>{{/options}}</select>',b)):$.mustache('<input class="field {{name}}" type="text" value="{{value}}"/>',
{name:b,value:d});if("object"===c.type){var f=[];for(key in c.properties)f.push({name:key,dom:SS.renderRecursiveEditingDOM(a.concat(key),key,c.properties[key],d[key])});return $.mustache('<table class="{{tableClass}}">{{#rows}}<tr><td>{{name}}</td><td>{{{dom}}}</td></tr>{{/rows}}</table>',{name:b,tableClass:e,rows:f})}if("array"===c.type)return f=d.map(function(b,d){return{row:SS.renderRecursiveEditingDOM(a.concat(d),key,c.items,b),index:d}}),$.mustache('<table class="{{tableClass}}">{{#rows}}<tr><td>{{{row}}}</td></tr>{{/rows}}</table>',
{rows:f,tableClass:e,name:b})};SS=SS||{};SS.UIMouseState=function(){this.popupShowing=this.panning=this.rotating=!1;this.isFree=function(){return!(this.rotating||this.panning||this.popupShowing)};this.free=function(){this.panning=this.rotating=!1}};
SS.UIEditingState=function(){_.extend(this,Backbone.Events);var a=!1;this.__defineGetter__("editing",function(){return a});this.__defineSetter__("editing",function(b){a!==b&&(a=b,this.trigger("change",a))});this.isEditing=function(){return this.editing};this.geomDocAdd=function(b){b.isEditingOrTransformEditing()&&!this.editing&&(a=!0,this.trigger("change",a))};this.geomDocRemove=function(b){b.isEditingOrTransformEditing()&&this.editing&&(a=!1,this.trigger("change",a))};this.geomDocReplace=function(b,
c){a!==c.isEditingOrTransformEditing()&&(a=c.isEditingOrTransformEditing(),this.trigger("change",a))};geom_doc.on("add",this.geomDocAdd,this);geom_doc.on("remove",this.geomDocRemove,this);geom_doc.on("replace",this.geomDocReplace,this)};var geom_doc=new GeomDocument;SS.UI_MOUSE_STATE=new SS.UIMouseState;SS.UI_EDITING_STATE=new SS.UIEditingState;SS=SS||{};
function renderValue(a,b,c,d,e){if("array"===e.properties[b].type){for(var c="",f=0;f<d[b].length;++f){var g=d[b][f],h=e.properties[b].items,j=[],l;for(l in g){var k="<tr><td>{{label}}</td><td>"+renderValue(a,l,g[l],g[l],h)+"</td></tr>";j.push($.mustache(k,{label:l,value:d[b][f][l],key:l+"_"+f}))}k="<table><tr><td>{{index}}</td><td><table>{{#items}}{{{.}}}{{/items}}</table></td></tr></table>";g=$.mustache(k,{index:f,items:j});c+=g}return c}return $.mustache('<span class="{{clazz}}">{{value}}</span>',{value:c,
clazz:a})}
function renderTransform(a,b){var c=a.transforms[b],d=null;if(c.origin){d=[];for(key in c.origin)d.push({key:key,value:c.origin[key],"edit-class":"edit-transform target-"+a.id+"-"+b,editing:c.editing});d=$.mustache('<table>{{#originArr}}<tr><td>{{key}}</td><td>{{^editing}}<span class="{{edit-class}}">{{value}}</span>{{/editing}}</td></tr>{{/originArr}}</table>',{originArr:d})}var e=[];for(key in c.parameters)e.push({key:key,value:c.parameters[key],"edit-class":"edit-transform target-"+a.id+"-"+b,
editing:c.editing});e=$.mustache('<table>{{#paramsArr}}<tr ><td>{{key}}</td><td>{{^editing}}<span class="{{edit-class}}">{{value}}</span>{{/editing}}</td></tr>{{/paramsArr}}</table>',{paramsArr:e});return $.mustache('{{#editing}}<div id="editing-area"></div>{{/editing}}{{^editing}}<table><tr><td><img class="show-hide-contents" src="/static/images/arrow_hidden.png"></img>{{type}}<img class="{{delete-class}}" src="/static/images/delete_button_gray_10.png" alt="delete"/></td></tr><tr style="{{contentsStyle}}"><td>{{{originTable}}}</td></tr><tr style="{{contentsStyle}}"><td>       {{{paramsTable}}}</td></tr></table>{{/editing}}',
{type:c.type,editing:c.editing,contentsStyle:c.editing?"":"display:none;","delete-class":"delete-transform target-"+a.id+"-"+b,originTable:d,paramsTable:e})}
function renderNode(a){var b=SS.schemas[a.type],c=null;if(b.properties.origin){c=[];for(key in a.origin)c.push({key:key,value:a.origin[key],clazz:"edit-geom target-"+a.id,editing:a.editing});c=$.mustache('<table>{{#originArr}}<tr {{#editing}}class="field"{{/editing}}><td>{{key}}</td><td>{{^editing}}<span class="{{clazz}}">{{value}}</span>{{/editing}}</td></tr>{{/originArr}}</table>',{originArr:c})}var d=[];if(b.properties.parameters)for(key in a.parameters)d.push({key:key,element:renderValue("edit-geom target-"+
a.id,key,a.parameters[key],a.parameters,b.properties.parameters),editing:a.editing});var b=$.mustache('<table>{{#paramsArr}}<tr {{#editing}}class="field"{{/editing}}><td>{{key}}</td><td>{{^editing}}{{{element}}}{{/editing}}</td></tr>{{/paramsArr}}</table>',{paramsArr:d}),d=[],e;for(e in a.transforms)d.push(renderTransform(a,e));e=a.children.map(renderNode);var f=geom_doc.isRoot(a)?"select-geom target-"+a.id:"target-"+a.id,g=$.mustache('<img class="copy-geom {{clazz}}" src="/static/images/copy_10.png"/>',
{clazz:"target-"+a.id}),h={isRoot:geom_doc.isRoot(a),clazz:"target-"+a.id},h=$.mustache('{{#isRoot}}<img class="toggle-geom-visibility {{clazz}} opaque" src="/static/images/eye.png"/> {{/isRoot}}',h),j=$.mustache('{{#isRoot}}<img class="delete-geom {{delete-clazz}}" src="/static/images/delete_button_gray_10.png" alt="delete"/>{{/isRoot}}',{isRoot:geom_doc.isRoot(a),"delete-clazz":"target-"+a.id});return $.mustache('{{#editing}}<div id="{{id}}"><div id="editing-area"></div></div>{{/editing}}{{^editing}}<table id="{{id}}" class="geomnode-table"><tr><td><img class="show-hide-siblings siblings-showing" src="/static/images/arrow_showing.png"></img><span class="{{clazz}}">{{type}}</span><span class="node-actions">{{{copyHtml}}}}{{{deleteGeomHtml}}}{{{eyeHtml}}</span></td></tr><tr><td>{{{originTable}}}</td></tr><tr><td>{{{paramsTable}}}</td></tr>{{#transformRows}}<tr><td>{{{.}}}</tr></td>{{/transformRows}}{{#children}}<tr><td>{{{.}}}</td></td>{{/children}}</table>{{/editing}}',
{type:a.type,editing:a.editing,id:a.id,copyHtml:g,eyeHtml:h,deleteGeomHtml:j,originTable:c,paramsTable:b,transformRows:d,clazz:f,children:e})}
SS.TreeView=function(){var a=this;this.domNodeLookup={};this.addEvents=function(b,c){var d=function(a){a.attr("src","/static/images/arrow_hidden.png");a.removeClass("siblings-showing");a.parent().parent().siblings().hide()},e,f;for(f in c.transforms)c.transforms[f].editing&&(e=c.transforms[f]);if(c.editing||e){$("#modal-ok").click(function(){var a;if(c.editing)if(a=function(a,b){b[a]="string"===SS.schemas[c.type].properties.parameters.properties[a].type?$("#"+a).val():parseFloat($("#"+a).val())},
b){for(key in c.origin)c.origin[key]=parseFloat($("#"+key).val());for(key in c.parameters)a(key,c.parameters);a=update_geom_command(b,c,c)}else{var d={};for(key in c.origin)d[key]=parseFloat($("#"+key).val());var f={};for(key in c.parameters)a(key,f);a=create_geom_command(c,{type:c.type,origin:d,parameters:f})}else{for(key in e.origin)e.origin[key]=parseFloat($("#"+key).val());for(key in e.parameters)e.parameters[key]=parseFloat($("#"+key).val());a=update_geom_command(b,c,c)}SS.commandStack.execute(a)});
var g=function(){b?geom_doc.replace(c,b):geom_doc.remove(c)};$(document).bind("keyup.editing",function(a){27==a.keyCode&&g()});$("#modal-cancel").click(function(){g()})}var h=!1;for(f in c.transforms)if(c.transforms[f].editing){h=!0;break}!c.editing&&!h&&d($("#"+c.id+" .show-hide-siblings"));$("#geom-model-doc tr:nth-child(even)").addClass("even");$("#geom-model-doc tr:nth-child(odd)").addClass("odd");$(".select-geom").unbind("click");$(".select-geom").click(function(){var a,b=/^target-(.*)$/,c=$(this).attr("class").split(" "),
d;for(d in c){var e=c[d].match(b);e&&(a=e[1])}if(!a)throw Error("id for editing could not be determined");SS.selectionManager.pick(a)});$(".edit-geom").unbind("click");$(".edit-geom").click(function(){var b,c=/^target-(.*)$/,d=$(this).attr("class").split(" "),e;for(e in d){var f=d[e].match(c);f&&(b=f[1])}if(!b)throw Error("id for editing could not be determined");a.edit(b)});$(".copy-geom").unbind("click");$(".copy-geom").click(function(){var a,b=/^target-(.*)$/,c=$(this).attr("class").split(" "),
d;for(d in c){var e=c[d].match(b);e&&(a=e[1])}if(!a)throw Error("id for editing could not be determined");a=geom_doc.findById(a);copyNode(a)});$(".edit-transform").unbind("click");$(".edit-transform").click(function(){var a,b,c=/^target-(.*)-(.*)$/,d=$(this).attr("class").split(" "),e;for(e in d){var f=d[e].match(c);f&&(a=f[1],b=f[2])}a=geom_doc.findById(a);c=a.editableCopy();c.transforms[b].editing=!0;geom_doc.replace(a,c);b=c.transforms[b];new SS.creators[b.type]({originalNode:a,editingNode:c,editingExisting:!0,
transform:b})});$(".delete-geom").unbind("click");$(".delete-geom").click(function(){var a,b=/^target-(.*)$/,c=$(this).attr("class").split(" "),d;for(d in c){var e=c[d].match(b);e&&(a=e[1])}a=geom_doc.findById(a);delete_geom_nodes([a])});$(".delete-transform").unbind("click");$(".delete-transform").click(function(){var a,b,c=/^target-(.*)-(.*)$/,d=$(this).attr("class").split(" "),e;for(e in d){var f=d[e].match(c);f&&(a=f[1],b=f[2])}a=geom_doc.findById(a);c=a.editableCopy();c.transforms.splice(b,1);
b=update_geom_command(a,a,c);SS.commandStack.execute(b)});$(".show-hide-contents").unbind("click");$(".show-hide-contents").click(function(){var a=$(this).parent().parent().parent();if($(this).hasClass("contents-showing")){$(this).attr("src","/static/images/arrow_hidden.png");$(this).removeClass("contents-showing");for(var b=1;b<a.children().length;++b)$(a.children()[b]).hide()}else{$(this).attr("src","/static/images/arrow_showing.png");$(this).addClass("contents-showing");for(b=1;b<a.children().length;++b)$(a.children()[b]).show()}return!1});
$(".toggle-geom-visibility").unbind("click");$(".toggle-geom-visibility").click(function(){var a=/^target-(.*)$/,b=$(this).attr("class").split(" "),c;for(c in b){var d=b[c].match(a);d&&(id=d[1])}if(!id)throw Error("id for editing could not be determined");-1!==$(this).attr("class").indexOf("opaque")?($(this).attr("src","/static/images/eye_hidden.png"),$(this).removeClass("opaque"),$(this).addClass("hidden"),SS.geomNodeRenderingManager.setHidden(id)):-1!==$(this).attr("class").indexOf("hidden")&&($(this).attr("src",
"/static/images/eye.png"),$(this).removeClass("hidden"),$(this).addClass("opaque"),SS.geomNodeRenderingManager.setOpaque(id))});$("#"+c.id+" .show-hide-siblings").click(function(){if($(this).hasClass("siblings-showing"))d($(this));else{var a=$(this);a.attr("src","/static/images/arrow_showing.png");a.addClass("siblings-showing");a.parent().parent().siblings().show()}return!1})};this.edit=function(a){a=geom_doc.findById(a);if(SS.creators[a.type]){var c=a.editableCopy();c.editing=!0;SS.selectionManager.deselectAll();
geom_doc.replace(a,c);new SS.creators[a.type]({editingNode:c,originalNode:a})}};this.geomDocAdd=function(a){var c=renderNode(a);this.domNodeLookup[a]=c;$("#geom-model-doc").prepend(c);this.addEvents(null,a)};this.geomDocRemove=function(a){$(document).unbind("keyup.editing");SS.materials.active&&SS.materials.disposeActive();$("#"+a.id).remove();delete this.domNodeLookup[a]};this.geomDocReplace=function(a,c){$(document).unbind("keyup.editing");SS.materials.active&&SS.materials.disposeActive();var d=
renderNode(c);$("#"+a.id).replaceWith(d);this.addEvents(a,c)};this.deselected=function(a){for(var c in a)$("#"+a[c]+" > tbody > tr:nth-child(1)").removeClass("selected")};this.selected=function(a){for(var c in a)$("#"+a[c]+" > tbody > tr:nth-child(1)").addClass("selected")};$("#advanced-geometry-checkbox").change(function(){0<$("#geom-model-doc :visible").length?$("#geom-model-doc").hide():$("#geom-model-doc").show()});$("#advanced-workplane-checkbox").change(function(){0<$("#workplane :visible").length?
$("#workplane").hide():$("#workplane").show()});geom_doc.on("add",this.geomDocAdd,this);geom_doc.on("remove",this.geomDocRemove,this);geom_doc.on("replace",this.geomDocReplace,this);SS.selectionManager.on("selected",this.selected,this);SS.selectionManager.on("deselected",this.deselected,this)};SS=SS||{};SS.workplane={};SS.workplane.gridExtents=function(a){var b={};b.minX=a.minX;b.minY=a.minY;b.maxX=a.maxX;b.maxY=a.maxY;b.fadingWidth=a.fadingWidth;b.isInsideX=function(a){return a>=b.minX&&a<=b.maxX};b.isInsideY=function(a){return a>=b.minY&&a<=b.maxY};return b};
SS.workplane.pointer=function(a){var b={},c=a.scene,d=a.gridExtents,e=new THREE.MeshBasicMaterial({color:16776960,opacity:0.7,wireframe:!1}),f=new THREE.CubeGeometry(0.5,0.5,0.5),g;b.update=function(a){SS.UI_EDITING_STATE.isEditing()?(c.remove(g),g=void 0):(g||(g=new THREE.Mesh(f,e)),d.isInsideX(a.x)&&(g.position.x=a.x),d.isInsideY(a.y)&&(g.position.y=a.y),c.add(g))};return b};
SS.workplane.grid=function(a){var b=a.gridExtents,c=new THREE.Geometry,d=new THREE.Geometry,e=new THREE.Geometry;new THREE.LineBasicMaterial({color:16777215,opacity:0.2,transparent:!0});new THREE.LineBasicMaterial({color:16777215,opacity:0.02,transparent:!0});size=2;curveSegments=6;font="helvetiker";weight="bold";style="normal";scene=a.scene;d.vertices.push(new THREE.Vector3(b.minX,0,0));d.vertices.push(new THREE.Vector3(b.maxX,0,0));e.vertices.push(new THREE.Vector3(b.minY,0,0));e.vertices.push(new THREE.Vector3(b.maxY,
0,0));c.vertices.push(new THREE.Vector3(0,0,0));c.vertices.push(new THREE.Vector3(10,0,0));return{}};
SS.Workplane=function(a){var b={},c={x:0,y:0},a=a.scene,d=SS.workplane.gridExtents({minX:-60,minY:-60,maxX:60,maxY:60,fadingWidth:50}),e=SS.workplane.pointer({scene:a,gridExtents:d}),f=SS.workplane.grid({scene:a,gridExtents:d});_.extend(b,Backbone.Events);b.node={origin:{x:0,y:0,z:0},axis:{x:0,y:0,z:1},angle:0};b.updateXYLocation=function(a,d){if(a){var f=Math.round(a.x),l=Math.round(a.y);c.x=f;c.y=l;e.update({x:f,y:l});b.trigger("workplaneXYCursorUpdated",{x:f,y:l,originalEvent:d})}};b.updateZLocation=
function(a,c){var d=Math.round(a.z);b.trigger("workplaneZCursorUpdated",{z:d,originalEvent:c})};b.getPlaneMesh=function(){return f.intersectionPlane};b.getLastMousePosition=function(){return c};return b};SS=SS||{};
SS.popupMenu=function(){var a={disposeIfShowing:function(){if(SS.UI_MOUSE_STATE.popupShowing){$("#toolWheel").hide();var a=$("#toolWheel").children().detach();$("#toolbarStaging").append(a)}SS.UI_MOUSE_STATE.popupShowing=!1},onMouseUp:function(a){2==a.button||0==a.button&&a.shiftKey?SS.UI_MOUSE_STATE.isFree()&&!SS.UI_EDITING_STATE.isEditing()&&($("#toolWheel").css("left",a.clientX),$("#toolWheel").css("top",a.clientY),0==SS.selectionManager.getSelected().length?($("#toolWheel").append($("#3Dprimitives")),$("#toolWheel").append($("#2Dprimitives")),
$("#toolWheel").append($("#1Dprimitives"))):1==SS.selectionManager.getSelected().length?($("#toolWheel").append($("#edit")),$("#toolWheel").append($("#transforms")),$("#toolWheel").append($("#modifiers"))):2<=SS.selectionManager.getSelected().length&&$("#toolWheel").append($("#boolean")),$("#toolWheel").show(),SS.UI_MOUSE_STATE.popupShowing=!0):SS.UI_MOUSE_STATE.free()},onMouseDown:function(){a.disposeIfShowing()}};return a};SS=SS||{};
(function(){var a=function(a,c,d,e){var d=new THREE.Vector3(2*(d.clientX/window.innerWidth)-1,2*-(d.clientY/window.innerHeight)+1,0.5),f=(new THREE.Projector).unprojectVector(d,c),d=new THREE.Ray(c.position,null);d.direction=f.subSelf(c.position).normalize();var g=[],h=function(a){a.constructor==THREE.Mesh&&g.push(a);a.children&&0<a.children.length&&a.children.map(h)},a=a.filter(e);h({children:a});return d.intersectObjects(g)};SS.selectGeomNodesInScene=function(b,c,d){return a(b,c,d,function(a){return void 0!==a.name.geomNodeId})};
SS.selectNonGeomNodesInScene=function(b,c,d){return a(b,c,d,function(a){return void 0===a.name.geomNodeId&&a.constructor!==THREE.Line})}})();SS=SS||{};
SS.SceneView=function(a){var b,c;function d(a){a.preventDefault();E.onMouseDown(a);mouseDownButton=a.button;p={};p.x=a.clientX;p.y=a.clientY;u=p;document.addEventListener("mouseup",h,!1);SS.UI_MOUSE_STATE.free();x=0<C.filter(function(a){return a.active}).length;var b=f(a);v.lastClickedPositionOnWorkplane=b;v.triggerMouseDownOnSceneObjectViews(a);v.updateScene=!0}function e(a){v.triggerMouseOverSceneObjectViews(a);var d={};d.x=a.clientX;d.y=a.clientY;if(p){if(SS.UI_MOUSE_STATE.isFree()&&!x&&(10<Math.abs(a.clientX-
p.x)||10<Math.abs(a.clientY-p.y)))if(!a.shiftKey&&(0===a.button&&0===mouseDownButton&&!x)&&(SS.UI_MOUSE_STATE.rotating=!0),1===a.button&&1===mouseDownButton||0===a.button&&0===mouseDownButton&&a.shiftKey)SS.UI_MOUSE_STATE.panning=!0;if(SS.UI_MOUSE_STATE.rotating){var e=Math.sqrt(t)/10;b=B.azimuth-0.005*(d.x-p.x)*e;c=B.elevation-0.005*(d.y-p.y)*e;c=c>Math.PI?Math.PI:c;c=0>c?0:c}else if(SS.UI_MOUSE_STATE.panning){var e=d.x-u.x,g=d.y-u.y,h=k.position.clone().negate().normalize(),j=new THREE.Vector3(0,
0,1),j=(new THREE.Vector3).cross(j,h),h=(new THREE.Vector3).cross(h,j),e=j.clone().multiplyScalar(e).addSelf(h.clone().multiplyScalar(g)),g=Math.sqrt(t)/50;e.multiplyScalar(g);H.addSelf(e)}}document.body.style.cursor=0<C.filter(function(a){return a.active}).length?"pointer":SS.transformerManager&&SS.transformerManager.cursor?SS.transformerManager.cursor:"default";a=f(a);a.equals(v.lastPositionOnWorkplane)||(v.lastPositionOnWorkplane=a,SS.workplaneModel.updatePointer(v.lastPositionOnWorkplane));u=
d;v.updateScene=!0}function f(a){if(!SS.workplaneModel)return new THREE.Vector3;var b=SS.objToVector(SS.workplaneModel.node.origin),c=SS.objToVector(SS.workplaneModel.node.axis),d=SS.rotateAroundAxis(new THREE.Vector3(0,0,1),c,SS.workplaneModel.node.angle),a=g(a,b,d);a.subSelf(b);b=SS.rotateAroundAxis(a,c,-SS.workplaneModel.node.angle);return new THREE.Vector3(Math.round(b.x),Math.round(b.y),Math.round(b.z))}function g(a,b,c){var a=new THREE.Vector3(2*(a.clientX/window.innerWidth)-1,2*-(a.clientY/
window.innerHeight)+1,0.5),a=(new THREE.Projector).unprojectVector(a,k),d=new THREE.Ray(k.position,null);d.direction=a.subSelf(k.position).normalize();a=d.origin;d=d.direction;b=(new THREE.Vector3).sub(b,a).dot(c)/d.dot(c);return 0===b?void 0:(new THREE.Vector3).add(a,d.clone().multiplyScalar(b))}function h(d){v.triggerMouseUpOnSceneObjectViews(d);B.azimuth=b;B.elevation=c;if(SS.UI_MOUSE_STATE.isFree()&&!SS.UI_EDITING_STATE.isEditing()&&0==d.button){var e=SS.selectGeomNodesInScene(m.children.concat(I),
k,d).filter(function(a){return a.object.name.geomNodeId});0<e.length?d.ctrlKey||d.metaKey?SS.selectionManager.shiftPick(e[0].object.name.geomNodeId):d.shiftKey||SS.selectionManager.pick(e[0].object.name.geomNodeId):SS.selectionManager.deselectAll()}E.onMouseUp(d);p=null;a.removeEventListener("mouseup",h,!1);v.updateScene=!0}function j(a){a.preventDefault();if(s){if(a.wheelDeltaY){var b=0.01*a.wheelDeltaY*Math.sqrt(t);y-=b}a.detail&&(a=0.01*60*-a.detail*Math.sqrt(t),y-=a)}return!1}function l(){requestAnimationFrame(l);
y-=0;D+=0.2*(b-D);z+=0.3*(c-z);var a=0.3*(y-t);1E3<t+a?t=y=1E3:3>t+a?t=y=3:t+=a;a=(new THREE.Vector3).sub(H,m.position).multiplyScalar(0.2);m.position.addSelf(a);w=k.position.clone();k.position.x=t*Math.sin(z)*Math.cos(D);k.position.y=t*Math.sin(z)*Math.sin(D);k.position.z=t*Math.cos(z);k.position.addSelf(m.position);var d=(new THREE.Vector3).sub(k.position,w);if(0.1<a.length()||0.1<d.length())v.trigger("cameraChange",k.position),k.lookAt(m.position),v.updateScene=!0;v.updateScene&&(n.render(m,k),
v.updateScene=!1)}this.lastPositionOnWorkplane=new THREE.Vector3(0,0,0);this.lastClickedPositionOnWorkplane=new THREE.Vector3(0,0,0);var k,m,n,q,r,s,w=new THREE.Vector3(0,0,0),p,u,x,D=-1.373,z=1.08;b=-1.373;c=1.08;var B={azimuth:b,elevation:c},t=1E3,y=300,H=new THREE.Vector3(0,0,0),I=[],E=SS.popupMenu(),v=this;_.extend(v,Backbone.Events);var G=[],C=[],A=[],J=function(a,b){return a.priority<b.priority};this.addToMouseOverAndMouseDown=function(a){[C,A].map(function(b){b.push(a);b.sort(J)})};this.registerSceneObjectView=
function(a){G.push(a)};this.deregisterSceneObjectView=function(a){[G,C,A].map(function(b){var c=b.indexOf(a);-1!==c&&b.splice(c,1)})};var K=function(a){var a=SS.selectNonGeomNodesInScene(m.children,k,a),b=function(a){return a.parent.constructor===THREE.Scene?a:b(a.parent)},c=[];_.pluck(a,"object").map(b).map(function(a){G.map(function(d){b(a)===d.sceneObject&&-1===c.indexOf(d)&&c.push(d)})});return c.sort(J)};SS.UI_MOUSE_STATE.isFree()&&(this.triggerMouseOverSceneObjectViews=function(a){var b=C.slice(0),
c=C.slice(0);C=[];K(a).map(function(d){-1===b.indexOf(d)&&d.trigger("mouseEnter",a);C.push(d);d=c.indexOf(d);-1!==d&&c.splice(d,1)});c.map(function(b){b.trigger("mouseLeave",a)});0===a.button&&(a.ctrlKey||!a.shiftKey)&&0<A.length&&A[0].trigger("mouseDrag",a)});this.triggerMouseDownOnSceneObjectViews=function(a){A=K(a);0===a.button&&0<A.length&&A[0].trigger("mouseDown",a)};this.triggerMouseUpOnSceneObjectViews=function(a){A.map(function(b){b.trigger("mouseUp",a)});A=[]};q=a.offsetWidth||window.innerWidth;
r=a.offsetHeight||window.innerHeight;m=new THREE.Scene;k=new THREE.PerspectiveCamera(30,q/r,1,1E4);k.up.x=0;k.up.y=0;k.up.z=1;m.add(k);n=new THREE.WebGLRenderer({antialias:!0});n.autoClear=!0;n.setClearColorHex(526344,0);n.setSize(q,r);n.sortObjects=!1;a.appendChild(n.domElement);a.style.color="#fff";a.style.font="13px/20px Arial, sans-serif";m.add(new THREE.AmbientLight(4210752));pointLight=new THREE.PointLight(10066329);pointLight.position.set(0,0,100);m.add(pointLight);pointLight=new THREE.PointLight(10066329);
pointLight.position.set(0,0,-100);m.add(pointLight);E=SS.popupMenu();n.domElement.style.position="absolute";a.addEventListener("mousedown",d,!1);a.addEventListener("mousewheel",j,!1);a.addEventListener("DOMMouseScroll",j,!1);a.addEventListener("mousemove",e,!1);window.addEventListener("keydown",function(a){if(s)switch(a.keyCode){case 187:case 107:var b=10*Math.sqrt(t);y-=b;a.preventDefault();break;case 189:case 109:b=10*-Math.sqrt(t),y-=b,a.preventDefault()}return!1},!1);a.addEventListener("mouseover",
function(){s=!0},!1);a.addEventListener("mouseout",function(){s=!1},!1);a.addEventListener("dblclick",function(){if(1==SS.selectionManager.size()){var a=SS.selectionManager.getSelected()[0];$("#"+a+" > tbody > tr:nth-child(1)").addClass("selected");SS.treeView.edit(a)}});window.addEventListener("resize",function(){k.aspect=window.innerWidth/window.innerHeight;k.updateProjectionMatrix();n.setSize(window.innerWidth,window.innerHeight);v.trigger("cameraChange",k.potion)},!1);this.animate=l;this.renderer=
n;this.scene=m;this.selectionOnlyMeshes=I;this.camera=k;this.determinePositionOnRay=function(a,b){var c=new THREE.Vector3(2*(a.clientX/window.innerWidth)-1,2*-(a.clientY/window.innerHeight)+1,0.5),c=(new THREE.Projector).unprojectVector(c,k),d=new THREE.Ray(k.position,null);d.direction=c.subSelf(k.position).normalize();d.origin=g(a,new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,1));if(void 0!==d.origin){var c=b.direction.clone().normalize(),e=d.direction.clone().normalize(),f=(new THREE.Vector3).sub(b.origin.clone(),
d.origin.clone()),d=c.dot(c),h=c.dot(e),j=e.dot(e),l=c.dot(f),e=e.dot(f),e=(h*e-j*l)/(d*j-h*h);return(new THREE.Vector3).add(b.origin,c.clone().multiplyScalar(e))}};this.determinePositionOnPlane2=g;this.determinePositionOnWorkplane=f;this.popupMenu=E;this.onMouseUp=h;this.onMouseMove=e;this.onMouseDown=d;return this};SS=SS||{};
SS.GeomNodeRenderingManager=function(){var a=[];this.geomDocAdd=function(a){geom_doc.isRoot(a)&&SS.renderGeometry(a);a.isEditingOrTransformEditing()&&c(a)};this.geomDocBeforeRemove=function(a){SS.selectionManager.deselectID(a.id)};this.geomDocRemove=function(c){SS.hideGeometry(c);c.isEditingOrTransformEditing()&&b();-1!==a.indexOf(c.id)&&a.splice(a.indexOf(c.id),1)};this.geomDocBeforeReplace=function(a){SS.selectionManager.deselectID(a.id)};this.geomDocReplace=function(a,e){this.geomDocRemove(a);e.isEditingOrTransformEditing()?
(e.isTransformEditing()&&this.geomDocAdd(e),c(e)):(this.geomDocAdd(e),b())};var b=function(){geom_doc.rootNodes.map(function(b){-1===a.indexOf(b.id)&&SS.restoreOpacity(b)})},c=function(b){geom_doc.rootNodes.map(function(c){b?b.id!==c.id&&-1===a.indexOf(b.id)&&SS.setTransparent(c):SS.setTransparent(c)})};this.isHiddenByUser=function(b){return-1!==a.indexOf(b.id)};this.deselected=function(b){for(var c in b){var f=b[c];-1===a.indexOf(f)&&SS.unhighlightGeometry(geom_doc.findById(f))}};this.selected=function(b){for(var e in b){var f=
b[e],g=geom_doc.findById(f);-1===a.indexOf(f)&&SS.highlightGeometry(g);c(g)}};this.clear=function(){SS.selectionManager.deselectAll()};this.setOpaque=function(b){a.splice(a.indexOf(b),1);SS.renderGeometry(geom_doc.findById(b))};this.setHidden=function(b){a.push(b);SS.hideGeometry(geom_doc.findById(b))};geom_doc.on("add",this.geomDocAdd,this);geom_doc.on("beforeRemove",this.geomDocBeforeRemove,this);geom_doc.on("remove",this.geomDocRemove,this);geom_doc.on("beforeReplace",this.geomDocBeforeReplace,
this);geom_doc.on("replace",this.geomDocReplace,this);SS.UI_EDITING_STATE.on("change",function(a){a?c():b()},this);SS.selectionManager.on("selected",this.selected,this);SS.selectionManager.on("deselected",this.deselected,this);SS.commandStack.on("beforePop",this.clear,this)};SS=SS||{};SS.NodeModel=Backbone.Model.extend({setParameters:function(a){for(var b in a)this.node.parameters[b]=a[b];this.trigger("beforeChange");this.editingNode.sceneObjects&&(this.boundingBox=SS.boundingBoxForGeomNode(this.editingNode),this.normalizedBoundingBox=SS.normalizedBoundingBoxForGeomNode(this.editingNode),this.normalizedCenter=SS.centerOfGeom(this.normalizedBoundingBox));this.trigger("change")}});
SS.NodeEditorDOMView=Backbone.View.extend({initialize:function(){Backbone.View.prototype.initialize.call(this);this.render();this.update();this.model.on("change",this.update,this)},remove:function(){Backbone.View.prototype.remove.call(this);this.model.off("change",this.update)},events:{"click .ok":"ok","click .cancel":"cancel","change .field":"fieldChanged","keyup .field":"fieldChanged","click .field":"fieldChanged"},preventRecursiveUpdate:!1,traverseSchemaAndMatchInputs:function(a,b,c){var d=this,
e=function(a,b,h){b.properties&&_.keys(b.properties).map(function(j){var l="."+a.join("_");if("array"!==b.properties[j].type){var k;k=d.$el.find(l+" .field."+j);if(1==k.length){var m=h;a.map(function(a){m=m[a]});m&&c(b.properties[j],k,m,j)}e(a.concat(j),b.properties[j],h)}else for(var n=0;;){k=l+"_"+j+"_"+n;k=d.$el.find(k);if(0===k.length)break;else e(a.concat(j).concat(""+n),b.properties[j].items,h);++n}})};e([this.model.node.type],a,b)},update:function(){this.preventRecursiveUpdate||(rootObject=
{},rootObject[this.model.node.type]=this.model.node,this.traverseSchemaAndMatchInputs(SS.schemas[this.model.node.type],rootObject,function(a,b,c,d){b.val(c[d])}))},updateFromDOM:function(){rootObject={};rootObject[this.model.node.type]=this.model.node;this.traverseSchemaAndMatchInputs(SS.schemas[this.model.node.type],rootObject,function(a,b,c,d){b=b.val();switch(a.type){case "number":b=parseFloat(b);break;case "integer":b=parseInt(b)}c[d]=b});this.model.setParameters({})},fieldChanged:function(){this.preventRecursiveUpdate=
!0;this.updateFromDOM();this.preventRecursiveUpdate=!1}});SS.NodeDOMView=SS.NodeEditorDOMView.extend({render:function(){this.$el.html(SS.renderEditingDOM(this.model.node.type,SS.schemas[this.model.node.type],this.model.node));$("#editing-area").append(this.$el);return this},ok:function(){this.model.tryCommit()},cancel:function(){this.model.cancel()}});
SS.SceneObjectView=Backbone.View.extend({initialize:function(){this.sceneObject=new THREE.Object3D;SS.sceneView.registerSceneObjectView(this);this.model.on("change",this.render,this)},remove:function(){SS.sceneView.deregisterSceneObjectView(this);SS.sceneView.scene.remove(this.sceneObject);this.model.off("change",this.render)},clear:function(){SS.sceneView.scene.remove(this.sceneObject);this.sceneObject=new THREE.Object3D},postRender:function(){var a=this.model.node&&this.model.node.workplane||this.model.originalNode&&
this.model.originalNode.workplane;if(a&&!this.dontApplyWorkplane){this.sceneObject.useQuaternion=!0;this.sceneObject.quaternion=new THREE.Quaternion;var b=new THREE.Quaternion,c=SS.objToVector(a.axis),d=a.angle/180*Math.PI;b.setFromAxisAngle(c,d);this.sceneObject.quaternion=b;this.sceneObject.position=(new THREE.Vector3).add(SS.rotateAroundAxis(this.sceneObject.position,c,a.angle),SS.objToVector(a.origin));this.model.node&&"rotate"===this.model.node.type&&(a=this.model.node,b=new THREE.Quaternion,
c=SS.objToVector(a.parameters),d=a.parameters.angle/180*Math.PI,b.setFromAxisAngle(c,d),this.sceneObject.quaternion=(new THREE.Quaternion).multiply(this.sceneObject.quaternion,b))}SS.sceneView.scene.add(this.sceneObject);SS.sceneView.updateScene=!0},priority:0});
SS.InteractiveSceneView=SS.SceneObjectView.extend({initialize:function(){SS.SceneObjectView.prototype.initialize.call(this);this.on("mouseEnter",this.enterHighlight);this.on("mouseLeave",this.leaveHighlight);this.on("mouseDown",this.downHighlight);this.on("mouseUp",this.upHighlight);this.updateCameraScale();SS.sceneView.on("cameraChange",this.cameraChange,this)},remove:function(){SS.SceneObjectView.prototype.remove.call(this);SS.sceneView.off("cameraChange",this.cameraChange,this);this.off("mouseEnter",
this.enterHighlight);this.off("mouseLeave",this.leaveHighlight);this.off("mouseDown",this.downHighlight);this.off("mouseUp",this.upHighlight)},priority:1,active:!0,cameraScale:1,recursiveHighlightFn:function(a,b){var c=function(a){a.material&&(a.material.opacity=b);a.children&&a.children.map(c)};c(a)},highlighted:!1,mouseIsDown:!1,opacity:0.5,enterHighlight:function(){this.active&&(this.recursiveHighlightFn(this.sceneObject,1),this.highlighted=!0,this.opacity=1)},leaveHighlight:function(){this.mouseIsDown||
this.upHighlight()},downHighlight:function(){this.mouseIsDown=!0},upHighlight:function(){this.highlighted&&(this.recursiveHighlightFn(this.sceneObject,0.5),this.highlighted=!1,this.opacity=0.5);this.mouseIsDown=!1},updateCameraScale:function(){var a=SS.sceneView.camera.position.length()/150;return a!==this.cameraScale?(this.cameraScale=a,!0):!1},cameraChange:function(){this.updateCameraScale()&&this.render()}});
SS.OkCancelView=Backbone.View.extend({initialize:function(){this.render();this.model.on("change",this.update,this);SS.sceneView.on("cameraChange",this.update,this);this.update()},remove:function(){Backbone.View.prototype.remove.call(this);this.model.off("change",this.update);SS.sceneView.off("cameraChange",this.update)},render:function(){this.$el.html('<table><tr><td><input class="ok" type="submit" value="Ok"/><input class="cancel" type="submit" value="Cancel"/></td></tr></table>');$("#floating-dom-view .ok-cancel").append(this.$el)},
update:function(){var a=window.innerWidth/2+10,b=window.innerHeight/2,c=this.model.getBoundingBox();if(c){this.model.node.workplane&&(c.min=SS.worldPositionFromWorkplanePosition(c.min,this.model.node.workplane),c.max=SS.worldPositionFromWorkplanePosition(c.max,this.model.node.workplane));a=new THREE.Matrix4;a.multiply(SS.sceneView.camera.projectionMatrix,SS.sceneView.camera.matrixWorldInverse);for(var b=[c.min.x,c.max.x],d=[c.min.y,c.max.y],e=[c.min.z,c.max.z],c=[new THREE.Vector3(2,2,0),new THREE.Vector3(-2,
-2,0)],f=0;2>f;f++)for(var g=0;2>g;++g)for(var h=0;2>h;++h){var j=new THREE.Vector3(b[f],d[g],e[h]);a.multiplyVector3(j);c[0].x=Math.min(c[0].x,j.x);c[0].y=Math.min(c[0].y,j.y);c[1].x=Math.max(c[1].x,j.x);c[1].y=Math.max(c[1].y,j.y)}b=(c[0].y+c[1].y)/2;a=window.innerWidth*((c[1].x+1)/2)+20;b=window.innerHeight*((-b+1)/2)+10;a=Math.min(a,window.innerWidth-100);b=Math.min(b,window.innerHeight-100);a=Math.max(a,100);b=Math.max(b,100)}$("#floating-dom-view").css("left",a);$("#floating-dom-view").css("top",
b)},events:{"click .ok":"ok","click .cancel":"cancel"},ok:function(){this.model.tryCommit()},cancel:function(){this.model.cancel()}});SS=SS||{};
SS.Creator=SS.NodeModel.extend({initialize:function(a){this.nodeDOMView=new SS.NodeDOMView({model:this});this.views=[this.nodeDOMView,new SS.OkCancelView({model:this})];a.noOriginCorner||(this.views.push(new SS.DraggableOriginCorner({model:this})),this.views.push(new SS.OriginDimensionText({model:this})));geom_doc.on("replace",this.geomDocReplace,this);geom_doc.on("remove",this.geomDocRemove,this)},destroy:function(){this.activeCornerView&&this.activeCornerView.remove();this.views.map(function(a){a.remove()});geom_doc.off("replace",
this.geomDocReplace);geom_doc.off("remove",this.geomDocRemove)},updateFromDOMView:function(){SS.NodeModel.prototype.updateFromDOMView.call(this);this.trigger("change")},activateCorner:function(a,b,c){this.activeCorner!==a&&(this.activeCornerView&&this.activeCornerView.remove(),this.activeCorner=a,b&&(this.activeCornerView=new b(c||{model:this})))},mouseDownOnOrigin:function(a){this.activateCorner(a,SS.OriginHeightCursoid)},geomDocReplace:function(){this.destroy()},geomDocRemove:function(){this.destroy()}});
SS.PrimitiveCreator=SS.Creator.extend({initialize:function(a){this.editingNode=this.node=a.editingNode;this.originalNode=a.originalNode;SS.Creator.prototype.initialize.call(this,a);this.originalNode||(this.setDefaultParamters(),this.trigger("change"))},tryCommit:function(){if(this.originalNode)var a=update_geom_command(this.originalNode,this.editingNode,this.editingNode);else a={type:this.node.type,parameters:this.node.parameters},this.node.origin&&(a.origin=this.node.origin),this.node.workplane.isGlobalXY()||
(a.workplane=this.node.workplane.serializableSubset()),a=create_geom_command(this.node,a);SS.commandStack.execute(a)},cancel:function(){this.destroy();this.originalNode?geom_doc.replace(this.editingNode,this.originalNode):geom_doc.remove(this.editingNode)}});
SS.ParentCreator=SS.Creator.extend({initialize:function(a){this.node=a.editingNode;this.childNode=a.editingNode.children[0];this.editingNode=a.editingNode;this.originalNode=a.originalNode;SS.Creator.prototype.initialize.call(this,a)},tryCommit:function(){var a=this.originalNode?update_geom_command(this.originalNode,this.editingNode,this.editingNode):update_geom_command(this.childNode,this.editingNode,this.editingNode);SS.commandStack.execute(a)},cancel:function(){this.destroy();this.originalNode?
geom_doc.replace(this.editingNode,this.originalNode):geom_doc.replace(this.editingNode,this.childNode)}});
SS.TransformCreator=SS.Creator.extend({initialize:function(a){this.node=a.transform;this.originalNode=a.originalNode;this.editingNode=a.editingNode;SS.Creator.prototype.initialize.call(this,a)},tryCommit:function(){var a=update_geom_command(this.attributes.originalNode,this.editingNode,this.editingNode);SS.commandStack.execute(a)},cancel:function(){this.destroy();geom_doc.replace(this.editingNode,this.originalNode)}});
SS.PreviewWithOrigin=SS.SceneObjectView.extend({initialize:function(){SS.SceneObjectView.prototype.initialize.call(this)},render:function(){var a=this.model.node.origin;this.sceneObject.position=new THREE.Vector3(a.x,a.y,a.z)},priority:-1});
SS.DraggableCorner=SS.InteractiveSceneView.extend({initialize:function(){SS.InteractiveSceneView.prototype.initialize.call(this);this.on("mouseDown",this.mouseDown);this.on("mouseDrag",this.drag)},remove:function(){SS.InteractiveSceneView.prototype.remove.call(this);this.model.off("mouseDown",this.mouseDown);this.off("mouseDrag",this.drag)},render:function(){this.clear();var a=1*this.cameraScale,a=new THREE.CubeGeometry(a,a,a),b=[new THREE.MeshBasicMaterial({color:SS.materials.faceColor,opacity:this.opacity,
wireframe:!1}),new THREE.MeshBasicMaterial({color:SS.materials.lineColor,wireframe:!0})],a=THREE.SceneUtils.createMultiMaterialObject(a,b),b=this.cornerPositionFromModel();a.position.x=b.x;a.position.y=b.y;a.position.z=0;this.sceneObject.add(a);this.postRender();return this},drag:function(a){a=SS.sceneView.determinePositionOnWorkplane(a);this.updateModelFromCorner(a);this.model.setParameters({})}});
SS.DraggableOriginCorner=SS.DraggableCorner.extend({initialize:function(a){SS.DraggableCorner.prototype.initialize.call(this,a);this.render()},mouseDown:function(){this.model.mouseDownOnOrigin(this)},cornerPositionFromModel:function(){var a=this.model.node.origin;return{x:a.x,y:a.y,z:a.z}},updateModelFromCorner:function(a){var b=this.model.node.origin;b.x=a.x;b.y=a.y}});
SS.HeightCursoid=SS.InteractiveSceneView.extend({initialize:function(){SS.InteractiveSceneView.prototype.initialize.call(this);this.on("mouseDrag",this.drag);this.render()},remove:function(){SS.InteractiveSceneView.prototype.remove.call(this);this.off("mouseDrag",this.drag)},render:function(){this.clear();var a=new THREE.Geometry;a.vertices.push(new THREE.Vector3(0,0,-1E3));a.vertices.push(new THREE.Vector3(0,0,1E3));var a=new THREE.Line(a,new THREE.LineBasicMaterial({color:13395558,opacity:this.opacity})),
b=new THREE.CylinderGeometry(0,0.75*this.cameraScale,1.5*this.cameraScale,3),c=[new THREE.MeshBasicMaterial({color:10040115,opacity:this.opacity,wireframe:!1}),new THREE.MeshBasicMaterial({color:13395558,wireframe:!0})],b=THREE.SceneUtils.createMultiMaterialObject(b,c),c=this.cornerPositionFromModel();a.position.x=c.x;a.position.y=c.y;b.position.x=c.x;b.position.y=c.y;b.position.z=c.z+2.5*this.cameraScale;b.rotation.x=Math.PI/2;this.sceneObject.add(a);this.sceneObject.add(b);this.postRender();return this},
drag:function(a){var b=SS.objToVector(SS.workplaneModel.node.origin),c=SS.objToVector(SS.workplaneModel.node.axis),d=SS.workplaneModel.node.angle,e=this.cornerPositionFromModel(),b=SS.rotateAroundAxis(new THREE.Vector3(e.x,e.y,0),c,d).addSelf(b),f=new THREE.Vector3(0,0,1),f=SS.rotateAroundAxis(f,c,d),f=new THREE.Ray(b,f);if(f=SS.sceneView.determinePositionOnRay(a,f))f.subSelf(b),c=SS.rotateAroundAxis(f,c,-d),e=new THREE.Vector3(e.x,e.y,c.z),a.ctrlKey||(e.z=Math.round(e.z)),this.updateModelFromCorner(e),
this.model.setParameters({})}});SS.OriginHeightCursoid=SS.HeightCursoid.extend({cornerPositionFromModel:function(){return{x:this.model.node.origin.x,y:this.model.node.origin.y,z:this.model.node.origin.z}},updateModelFromCorner:function(a){this.model.node.origin.x=a.x;this.model.node.origin.y=a.y;this.model.node.origin.z=a.z}});
SS.DimensionText=Backbone.View.extend({initialize:function(){Backbone.View.prototype.initialize.call(this);SS.sceneView.on("cameraChange",this.update,this);this.model.on("change",this.render,this);this.elements=[];this.render()},remove:function(){Backbone.View.prototype.remove.call(this);SS.sceneView.off("cameraChange",this.update,this);this.model.off("change",this.render,this);this.clear()},clear:function(){this.elements.map(function(a){a.remove()});this.elements=[]},addElement:function(a){a=$(a);
a.css("position","absolute");$("body").append(a);this.elements.push(a);a.mousemove(SS.sceneView.onMouseMove);a.mousedown(SS.sceneView.onMouseDown);a.mouseup(SS.sceneView.onMouseUp);return a},moveToScreenCoordinates:function(a,b,c,d){var e=this.model.node&&this.model.node.workplane||this.model.originalNode&&this.model.originalNode.workplane;e&&(b=SS.worldPositionFromWorkplanePosition(b,e));c=c||0;d=d||0;b=SS.toScreenCoordinates(b.clone());a.css("left",b.x-a.width()/2+c);a.css("top",b.y-a.height()/
2+d)}});
SS.OriginDimensionText=SS.DimensionText.extend({render:function(){this.clear();var a=this.model.node.origin;a.x||a.y?this.$xyz=a.z?this.addElement($.mustache('<div class="dimension">(<span class="x">{{x}}</span>,<span class="y">{{y}}</span>,<span class="z">{{z}}</span>)</div>',a)):this.addElement($.mustache('<div class="dimension">(<span class="x">{{x}}</span>,<span class="y">{{y}}</span>)</div>',a)):a.z&&(this.$xyz=this.addElement($.mustache('<div class="dimension">(<span class="z">{{z}}</span>)</div>',a)));
this.update()},update:function(){if(this.$xyz){var a=this.model.node.origin;this.moveToScreenCoordinates(this.$xyz,new THREE.Vector3(a.x,a.y,a.z),-30,10)}}});SS=SS||{};SS.NodeDisplayDOMView=Backbone.View.extend({initialize:function(){this.render();this.model.on("change",this.render,this)},remove:function(){Backbone.View.prototype.remove.call(this);this.model.off("change",this.render)},events:{"click .value":"edit"}});
SS.WorkplaneDisplayModel=Backbone.Model.extend({initialize:function(){this.node=new SS.WorkplaneNode;this.extents=this.minExtents=60;this.boundary=50;this.domView=new SS.WorkplaneDisplayDOMView({model:this});this.views=[new SS.WorkplanePointerView({model:this}),new SS.WorkplanePointerDimensionText({model:this}),new SS.WorkplaneAxesSceneView({model:this}),new SS.WorkplaneMainGridSceneView({model:this}),new SS.WorkplaneFadingGridSceneView({model:this}),new SS.WorkplaneGlobalXYPlaneView({model:this})];
this.rulers=this.addRulers();SS.selectionManager.on("selected",this.selectionChanged,this);SS.selectionManager.on("deselected",this.selectionChanged,this);geom_doc.on("add",this.updateExtents,this);geom_doc.on("remove",this.updateExtents,this);geom_doc.on("replace",this.updateExtents,this);geom_doc.on("replace",this.geomDocReplace,this)},destroy:function(){this.views.map(function(a){a.remove()});this.rulers.map(function(a){a.remove()});domView.remove();SS.selectionManager.off("selected",this.selectionChanged,
this);SS.selectionManager.off("deselected",this.selectionChanged,this);geom_doc.off("add",this.updateExtents,this);geom_doc.off("remove",this.updateExtents,this);geom_doc.off("replace",this.updateExtents,this);geom_doc.off("replace",this.geomDocReplace,this)},addRulers:function(){var a=[],b=10;100<this.extents&&(b=20);for(var c=-this.extents/b;c<=this.extents/b;++c)a.push(new SS.WorkplaneRulerText({model:this,position:new THREE.Vector3(c*b,this.extents+5,0),label:c*b,axis:"x"}));for(c=-this.extents/
b;c<=this.extents/b;++c)a.push(new SS.WorkplaneRulerText({model:this,position:new THREE.Vector3(this.extents+5,c*b,0),label:c*b,axis:"y"}));return a},persistentWorkplaneNode:void 0,pushNode:function(a){this.persistentWorkplaneNode=this.node;this.loadNode(a.workplane)},popNode:function(){void 0!==this.persistentWorkplaneNode&&(this.loadNode(this.persistentWorkplaneNode),this.persistentWorkplaneNode=void 0)},selectionChanged:function(a){this.persistentWorkplaneNode&&this.popNode();a=SS.selectionManager.getSelected();
1==a.length&&this.pushNode(geom_doc.findById(a[0]))},geomDocReplace:function(a,b){b.isEditingOrTransformEditing()?this.pushNode(b):this.popNode()},updateExtents:function(){var a=new THREE.Vector3,b=new THREE.Vector3;geom_doc.rootNodes.map(function(c){if(c=SS.normalizedBoundingBoxForGeomNode(c))a=new THREE.Vector3(Math.min(a.x,c.min.x),Math.min(a.y,c.min.y),Math.min(a.z,c.min.z)),b=new THREE.Vector3(Math.max(b.x,c.max.x),Math.max(b.y,c.max.y),Math.max(b.z,c.max.z))});var c;c=Math.max(Math.abs(a.x),
0);c=Math.max(Math.abs(b.x),c);c=Math.max(Math.abs(a.y),c);c=Math.max(Math.abs(b.y),c);var d=this.minExtents;c>this.minExtents&&(d=10*Math.round(c/10)+10);d!==this.extents&&(this.extents=d,this.rulers.map(function(a){a.remove()}),this.rulers=this.addRulers(),this.trigger("changeExtents"))},setEditing:function(){this.domView.remove();this.domView=void 0;var a=this.node.editableCopy();this.editingModel=new SS.WorkplaneEditorModel({editingNode:a,extents:this.extents})},cancelEditing:function(){this.domView=
new SS.WorkplaneDisplayDOMView({model:this});SS.UI_EDITING_STATE.editing=!1},setNewNode:function(a){var b=this.node,c=this,d=new Command(function(){c.node=a;c.trigger("change");c.domView&&c.domView.remove();c.domView=new SS.WorkplaneDisplayDOMView({model:c});SS.UI_EDITING_STATE.editing=!1;SS.commandStack.commit()},function(){c.loadNode(b);SS.commandStack.success()},function(){c.loadNode(a);SS.commandStack.success()});SS.commandStack.execute(d);return!0},loadNode:function(a){a.isEqual(this.node)||
(this.node=a,this.trigger("change"))},updatePointer:function(a){this.pointerPosition=a;this.trigger("pointerUpdated")}});SS.WorkplaneDisplayDOMView=SS.NodeDisplayDOMView.extend({render:function(){this.$el.html(SS.renderDisplayDOM("",SS.schemas.workplane,this.model.node));$("#workplane").append(this.$el)},edit:function(){SS.UI_EDITING_STATE.isEditing()||(SS.UI_EDITING_STATE.editing=!0,this.model.setEditing())}});
SS.WorkplaneDisplaySceneView=SS.SceneObjectView.extend({initialize:function(){SS.SceneObjectView.prototype.initialize.call(this);this.model.on("changeExtents",this.recreate,this);this.recreate()},remove:function(){SS.SceneObjectView.prototype.remove.call(this);this.model.off("changeExtents",this.recreate,this)},recreate:function(){this.create();this.render()},render:function(){var a=new THREE.Quaternion,b=SS.objToVector(this.model.node.axis);a.setFromAxisAngle(b,this.model.node.angle/180*Math.PI);
this.sceneObject.useQuaternion=!0;this.sceneObject.quaternion=a;this.sceneObject.position=SS.objToVector(this.model.node.origin)},postRender:function(){SS.sceneView.scene.add(this.sceneObject);SS.sceneView.updateScene=!0}});
SS.WorkplaneAxesSceneView=SS.WorkplaneDisplaySceneView.extend({create:function(){this.clear();var a=[new THREE.Geometry,new THREE.Geometry,new THREE.Geometry,new THREE.Geometry,new THREE.Geometry,new THREE.Geometry];a[0].vertices.push(new THREE.Vector3(0,0,0));a[0].vertices.push(new THREE.Vector3(5E3,0,0));a[1].vertices.push(new THREE.Vector3(0,0,0));a[1].vertices.push(new THREE.Vector3(0,5E3,0));a[2].vertices.push(new THREE.Vector3(0,0,0));a[2].vertices.push(new THREE.Vector3(0,0,5E3));a[3].vertices.push(new THREE.Vector3(0,
0,0));a[3].vertices.push(new THREE.Vector3(-5E3,0,0));a[4].vertices.push(new THREE.Vector3(0,0,0));a[4].vertices.push(new THREE.Vector3(0,-5E3,0));a[5].vertices.push(new THREE.Vector3(0,0,0));a[5].vertices.push(new THREE.Vector3(0,0,-5E3));this.sceneObject.add(new THREE.Line(a[0],new THREE.LineBasicMaterial({color:SS.colors.xAxis,opacity:0.5})));this.sceneObject.add(new THREE.Line(a[1],new THREE.LineBasicMaterial({color:SS.colors.yAxis,opacity:0.5})));this.sceneObject.add(new THREE.Line(a[2],new THREE.LineBasicMaterial({color:SS.colors.zAxis,
opacity:0.5})));this.sceneObject.add(new THREE.Line(a[3],new THREE.LineBasicMaterial({color:SS.colors.xAxis,opacity:0.2})));this.sceneObject.add(new THREE.Line(a[4],new THREE.LineBasicMaterial({color:SS.colors.yAxis,opacity:0.2})));this.sceneObject.add(new THREE.Line(a[5],new THREE.LineBasicMaterial({color:SS.colors.zAxis,opacity:0.2})));this.postRender()}});
SS.WorkplanePointerView=SS.WorkplaneDisplaySceneView.extend({initialize:function(){SS.WorkplaneDisplaySceneView.prototype.initialize.call(this);this.model.on("pointerUpdated",this.render,this)},remove:function(){SS.WorkplaneDisplaySceneView.prototype.remove.call(this);this.model.on("pointerUpdated",this.render,this)},create:function(){},render:function(){this.clear();if(!SS.UI_EDITING_STATE.isEditing()){var a=new THREE.MeshBasicMaterial({color:16776960,opacity:0.7,wireframe:!1}),b=new THREE.CubeGeometry(0.5,
0.5,0.5);this.pointer=new THREE.Mesh(b,a);this.sceneObject.add(this.pointer);this.model.pointerPosition&&(this.pointer.position=this.model.pointerPosition);SS.WorkplaneDisplaySceneView.prototype.render.call(this)}this.postRender()}});
SS.WorkplanePointerDimensionText=SS.DimensionText.extend({initialize:function(){SS.DimensionText.prototype.initialize.call(this);this.model.on("pointerUpdated",this.render,this);SS.UI_EDITING_STATE.on("change",this.render,this)},remove:function(){SS.DimensionText.prototype.remove.call(this);this.model.on("pointerUpdated",this.render,this);SS.UI_EDITING_STATE.off("change",this.render,this)},render:function(){this.clear();if(this.model.pointerPosition&&!SS.UI_EDITING_STATE.isEditing()){var a=this.model.pointerPosition;
if(a.x||a.y)this.$xyz=a.z?this.addElement($.mustache('<div class="dimension">(<span class="x">{{x}}</span>,<span class="y">{{y}}</span>,<span class="z">{{z}}</span>)</div>',a)):this.addElement($.mustache('<div class="dimension">(<span class="x">{{x}}</span>,<span class="y">{{y}}</span>)</div>',a));this.update()}},update:function(){if(this.$xyz){if(this.model.pointerPosition){var a=SS.worldPositionFromWorkplanePosition(this.model.pointerPosition,this.model.node);this.moveToScreenCoordinates(this.$xyz,
a,-30,10)}(!this.model.pointerPosition||SS.UI_EDITING_STATE.isEditing())&&this.$xyz.hide()}}});
SS.WorkplaneMainGridSceneView=SS.WorkplaneDisplaySceneView.extend({create:function(){this.clear();for(var a=-this.model.extents;a<=this.model.extents;++a)if(0!=a){var b=new THREE.Geometry;b.vertices.push(new THREE.Vector3(a,-this.model.extents,0));b.vertices.push(new THREE.Vector3(a,this.model.extents,0));var c=0==a%10?SS.materials.gridMajor:SS.materials.gridMinor,b=new THREE.Line(b,c);this.sceneObject.add(b)}for(a=-this.model.extents;a<=this.model.extents;++a)0!=a&&(b=new THREE.Geometry,b.vertices.push(new THREE.Vector3(-this.model.extents,
a,0)),b.vertices.push(new THREE.Vector3(this.model.extents,a,0)),c=0==a%10?SS.materials.gridMajor:SS.materials.gridMinor,b=new THREE.Line(b,c),this.sceneObject.add(b));this.postRender()}});
SS.WorkplaneFadingGridSceneView=SS.WorkplaneDisplaySceneView.extend({create:function(){this.clear();for(var a=-this.model.extents-this.model.boundary;a<=this.model.extents+this.model.boundary;++a)for(var b=-this.model.extents-this.model.boundary;b<=this.model.extents+this.model.boundary;++b){var c=this.isInsideX(a)&&this.isInsideY(b);0==a%10&&(0==b%10&&0!=a&&0!=b&&!c)&&this.addFadingGridTile(a,b)}this.postRender()},isInsideX:function(a){return a>=-this.model.extents&&a<=this.model.extents},isInsideY:function(a){return a>=
-this.model.extents&&a<=this.model.extents},addFadingGridTile:function(a,b){var c=new THREE.Geometry;c.vertices.push(new THREE.Vector3(0,0,0));c.vertices.push(new THREE.Vector3(10,0,0));var d=0;a<-this.model.extents?d=-this.model.extents-a:a>this.model.extents&&(d=a-this.model.extents);var e=0;b<-this.model.extents?e=-this.model.extents-b:b>this.model.extents&&(e=b-this.model.extents);d=Math.sqrt(d*d+e*e);d=new THREE.LineBasicMaterial({color:SS.colors.fadingGrid,opacity:0==d?1:1/(0.9*d)});e=new THREE.Line(c,
d);e.position.x=0<a?a-10:a;e.position.y=b;this.sceneObject.add(e);e=new THREE.Line(c,d);e.position.x=a;e.position.y=0<b?b-10:b;e.rotation.z=90*Math.PI/180;this.sceneObject.add(e)}});
SS.WorkplaneGlobalXYPlaneView=SS.SceneObjectView.extend({initialize:function(){SS.SceneObjectView.prototype.initialize.call(this);this.render()},remove:function(){SS.SceneObjectView.prototype.remove.call(this)},render:function(){this.clear();if(!this.model.node.isGlobalXY()){var a=new THREE.PlaneGeometry(2*this.model.extents,2*this.model.extents),a=THREE.SceneUtils.createMultiMaterialObject(a,SS.materials.globalXYPlane);a.rotation.x=Math.PI/2;this.sceneObject.add(a)}this.postRender()}});
SS.WorkplaneRulerText=SS.DimensionText.extend({render:function(){this.clear();this.$xy=this.addElement($.mustache('<div class="dimension ruler {{axis}}">{{label}}</div>',this.options));this.update()},updateCheckpoint:0,hidden:!1,delayedUpdate:function(a){var b=this;setTimeout(function(){if(a===b.updateCheckpoint){var c=SS.objToVector(b.model.node.origin),d=SS.objToVector(b.model.node.axis),d=SS.rotateAroundAxis(b.options.position,d,b.model.node.angle),c=(new THREE.Vector3).add(d,c);b.moveToScreenCoordinates(b.$xy,
c);b.$xy.fadeIn(100);b.hidden=!1}},500)},update:function(){this.updateCheckpoint+=1;this.hidden||this.$xy.fadeOut(100);this.delayedUpdate(this.updateCheckpoint)}});SS=SS||{};
SS.WorkplaneEditorModel=Backbone.Model.extend({initialize:function(a){this.node=a.editingNode;this.extents=a.extents;this.views=[new SS.DraggableOriginCorner({model:this}),new SS.OriginDimensionText({model:this}),new SS.WorkplaneEditorDOMView({model:this}),new SS.WorkplanePreview({model:this}),new SS.WorkplaneURotationPreview({model:this,radius:this.extents}),new SS.WorkplaneVRotationPreview({model:this,radius:this.extents}),new SS.WorkplaneWRotationPreview({model:this,radius:this.extents})]},destroy:function(){this.activeCornerView&&
this.activeCornerView.remove();this.views.map(function(a){a.remove()})},schema:SS.schemas.workplane,activateCorner:function(a,b,c){this.activeCorner!==a&&(this.activeCornerView&&this.activeCornerView.remove(),this.activeCorner=a,b&&(this.activeCornerView=new b(c||{model:this})))},setParameters:function(){this.trigger("change")},mouseDownOnOrigin:function(a){this.activateCorner(a,SS.OriginHeightCursoid)},ok:function(){SS.workplaneModel.setNewNode(this.node)&&this.destroy()},cancel:function(){SS.workplaneModel.cancelEditing();
this.destroy()},xy:function(){this.node=new SS.WorkplaneNode;this.trigger("change")},yz:function(){this.node=new SS.WorkplaneNode;this.node.axis.x=this.node.axis.y=this.node.axis.z=parseFloat(Math.tan(Math.PI/6).toFixed(4));this.node.angle=120;this.trigger("change")},zx:function(){this.node=new SS.WorkplaneNode;this.node.axis.x=this.node.axis.y=this.node.axis.z=parseFloat(-Math.tan(Math.PI/6).toFixed(4));this.node.angle=120;this.trigger("change")}});
SS.WorkplaneEditorDOMView=SS.NodeEditorDOMView.extend({render:function(){var a=$.mustache('{{#planes}}<input class="{{value}}" type="submit" value="{{value}}"/>{{/planes}}',{planes:[{value:"XY"},{value:"YZ"},{value:"ZX"}]});this.$el.html(SS.renderEditingDOM("workplane",SS.schemas.workplane,this.model.node,a));$("#workplane").append(this.$el)},events:{"click .ok":"ok","click .cancel":"cancel","click .XY":"xy","click .YZ":"yz","click .ZX":"zx","change .field":"fieldChanged","keyup .field":"fieldChanged",
"click .field":"fieldChanged"},ok:function(){this.model.ok()},cancel:function(){this.model.cancel()},xy:function(){this.model.xy()},yz:function(){this.model.yz()},zx:function(){this.model.zx()}});
SS.WorkplanePreview=SS.PreviewWithOrigin.extend({initialize:function(){SS.PreviewWithOrigin.prototype.initialize.call(this);this.render();this.model.on("change",this.render,this)},remove:function(){SS.PreviewWithOrigin.prototype.remove.call(this);this.model.off("change",this.render)},render:function(){this.clear();SS.PreviewWithOrigin.prototype.render.call(this);var a=[SS.materials.faceMaterial,SS.materials.wireframeMaterial],b=new THREE.PlaneGeometry(this.model.extents,this.model.extents),c=this;
[-c.model.extents/2,c.model.extents/2].map(function(d){[-c.model.extents/2,c.model.extents/2].map(function(e){var h=THREE.SceneUtils.createMultiMaterialObject(b,a),j=THREE.SceneUtils.createMultiMaterialObject(b,a);h.position.x=d;h.position.y=e;h.rotation.x=Math.PI/2;j.rotation.x=3*Math.PI/2;j.position.x=d;j.position.y=e;c.sceneObject.add(h);c.sceneObject.add(j)})});var d=new THREE.Quaternion,e=SS.objToVector(this.model.node.axis);d.setFromAxisAngle(e,this.model.node.angle/180*Math.PI);this.sceneObject.useQuaternion=
!0;this.sceneObject.quaternion=d;this.postRender()}});
SS.WorkplaneRotationPreview=SS.InteractiveSceneView.extend({initialize:function(){SS.InteractiveSceneView.prototype.initialize.call(this);this.on("mouseDown",this.mouseDown,this);this.on("mouseUp",this.mouseUp,this);this.on("mouseDrag",this.drag);this.relativeAngle=0;this.angleDimensionSubview=new SS.RelativeAngleDimensionText({model:this.model,parentView:this,color:this.textColor});this.updateAxis();this.render()},remove:function(){SS.InteractiveSceneView.prototype.remove.call(this);this.off("mouseDown",
this.mouseDown);this.off("mouseUp",this.mouseUp);this.off("mouseDrag",this.drag);this.angleDimensionSubview.remove()},render:function(){this.clear();SS.InteractiveSceneView.prototype.render.call(this);for(var a=this.options.radius,b=new THREE.Geometry,c=0;c<=360-this.relativeAngle;++c){var d=c/180*Math.PI,e=a*Math.cos(d),d=a*Math.sin(d);b.vertices.push(new THREE.Vector3(e,d,0))}var f=new THREE.LineBasicMaterial({color:this.arrowLineColor,wireframe:!0,linewidth:1,opacity:this.opacity}),b=new THREE.Line(b,
f),g=new THREE.Geometry;if(0!==this.relativeAngle){var c=Math.min(-this.relativeAngle,0),h=Math.max(-this.relativeAngle,0);for(c==-this.relativeAngle&&g.vertices.push(new THREE.Vector3(0,0,0));c<=h;++c)d=c/180*Math.PI,e=a*Math.cos(d),d=a*Math.sin(d),g.vertices.push(new THREE.Vector3(e,d,0));h==-this.relativeAngle&&g.vertices.push(new THREE.Vector3(0,0,0))}a=new THREE.Line(g,f);f=new THREE.CylinderGeometry(0,0.75*this.cameraScale,2*this.cameraScale,3);c=[new THREE.MeshBasicMaterial({color:this.arrowLineColor,
opacity:this.opacity,wireframe:!1}),new THREE.MeshBasicMaterial({color:this.arrowFaceColor,wireframe:!0})];f=THREE.SceneUtils.createMultiMaterialObject(f,c);f.position.x=this.options.radius;this.circleAndArrow=new THREE.Object3D;this.circleAndArrow.add(f);this.circleAndArrow.add(b);this.circleAndArrow.add(a);this.sceneObject.add(this.circleAndArrow);b=new THREE.Quaternion;d=this.getAngle()/180*Math.PI;b.setFromAxisAngle(this.getAxis(),d);this.sceneObject.useQuaternion=!0;this.sceneObject.quaternion=
b;b=SS.objToVector(this.model.node.origin);this.sceneObject.position=b;this.showDimensionAngleText?(this.angleDimensionSubview.angle=this.relativeAngle,this.angleDimensionSubview.position=this.relativeAnchorPosition,this.angleDimensionSubview.render()):(this.angleDimensionSubview.clear(),this.angleDimensionSubview.position=void 0)},getAngle:function(){return this.model.node.hasOwnProperty("angle")?this.model.node.angle:this.model.node.parameters.angle},getAxis:function(){return this.model.node.hasOwnProperty("axis")?
SS.objToVector(this.model.node.axis):SS.objToVector(this.model.node.parameters)},updateAxis:function(){this.startAxis=this.getAxis().normalize();this.startAngle=this.model.node.hasOwnProperty("angle")?this.model.node.angle:this.model.node.parameters.angle;if(this.model.originalNode){this.arrowStartPosition=SS.rotateAroundAxis(this.relativeAnchorPosition,this.startAxis,this.startAngle);this.arrowStartPosition.addSelf(SS.objToVector(this.model.node.origin));var a=SS.objToVector(this.model.originalNode.workplane.axis),
b=SS.objToVector(this.model.originalNode.workplane.origin);this.arrowStartPosition=SS.rotateAroundAxis(this.arrowStartPosition,a,this.model.originalNode.workplane.angle);this.arrowStartPosition.addSelf(b)}else this.arrowStartPosition=SS.rotateAroundAxis(this.relativeAnchorPosition,this.startAxis,this.startAngle),this.arrowStartPosition.addSelf(SS.objToVector(this.model.node.origin));this.rotationAxis=SS.rotateAroundAxis(this.relativeRotationAxis,this.startAxis,this.startAngle)},mouseDown:function(){this.updateAxis();
this.showDimensionAngleText=!0;this.model.mouseDownOnArrow&&this.model.mouseDownOnArrow(this.rotationAxis,this.options.index)},mouseUp:function(){this.relativeAngle=0;this.showDimensionAngleText=!1;this.render()},drag:function(a){if(this.model.originalNode)var b=SS.objToVector(this.model.node.origin),c=SS.objToVector(this.model.originalNode.workplane.axis),d=SS.objToVector(this.model.originalNode.workplane.origin),e=this.model.originalNode.workplane.angle,b=SS.rotateAroundAxis(b,c,e).addSelf(d),c=
SS.rotateAroundAxis(this.rotationAxis,c,e);else b=SS.objToVector(this.model.node.origin),c=this.rotationAxis;if(e=SS.sceneView.determinePositionOnPlane2(a,b,c))e=(new THREE.Vector3).sub(e,b).normalize(),d=(new THREE.Vector3).sub(this.arrowStartPosition,b).normalize(),b=(new THREE.Vector3).cross(d,e),e=parseFloat((180*(Math.acos(e.dot(d))/Math.PI)).toFixed(0)),0>c.dot(b)&&(e=-e),this.previousRelativeAngle=void 0==this.previousRelativeAngle?0:this.relativeAngle,this.relativeAngle=e,a.ctrlKey||(this.relativeAngle=
5*Math.round(this.relativeAngle/5),360===this.relativeAngle&&(this.relativeAngle=0)),this.relativeAngle!==this.previousRelativeAngle&&(a=(new THREE.Quaternion).setFromAxisAngle(this.startAxis,this.startAngle/180*Math.PI),c=(new THREE.Quaternion).setFromAxisAngle(this.relativeRotationAxis,Math.PI*this.relativeAngle/180),c=(new THREE.Quaternion).multiply(a,c),c.normalize(),a=2*Math.acos(c.w),c=new THREE.Vector3(c.x/Math.sqrt(1-c.w*c.w),c.y/Math.sqrt(1-c.w*c.w),c.z/Math.sqrt(1-c.w*c.w)),a=180*(a/Math.PI),
this.model.node.hasOwnProperty("angle")?(this.model.node.axis.x=parseFloat(c.x.toFixed(3)),this.model.node.axis.y=parseFloat(c.y.toFixed(3)),this.model.node.axis.z=parseFloat(c.z.toFixed(3)),this.model.node.angle=parseFloat(a.toFixed(2))):(this.model.node.parameters.u=parseFloat(c.x.toFixed(3)),this.model.node.parameters.v=parseFloat(c.y.toFixed(3)),this.model.node.parameters.w=parseFloat(c.z.toFixed(3)),this.model.node.parameters.angle=parseFloat(a.toFixed(2)))),this.model.trigger("beforeChange"),
this.model.trigger("change")}});
SS.WorkplaneURotationPreview=SS.WorkplaneRotationPreview.extend({initialize:function(a){this.relativeAnchorPosition=new THREE.Vector3(0,this.options.radius,0);SS.WorkplaneRotationPreview.prototype.initialize.call(this,a)},render:function(){SS.WorkplaneRotationPreview.prototype.render.call(this);this.circleAndArrow.rotation.y=Math.PI/2;this.circleAndArrow.rotation.z=Math.PI/2;this.postRender()},relativeRotationAxis:new THREE.Vector3(1,0,0),arrowLineColor:3355545,arrowFaceColor:6710988,textColor:"#6666cc"});
SS.WorkplaneVRotationPreview=SS.WorkplaneRotationPreview.extend({initialize:function(a){this.relativeAnchorPosition=new THREE.Vector3(0,0,this.options.radius);SS.WorkplaneRotationPreview.prototype.initialize.call(this,a)},render:function(){SS.WorkplaneRotationPreview.prototype.render.call(this);this.circleAndArrow.rotation.x=-Math.PI/2;this.circleAndArrow.rotation.z=-Math.PI/2;this.postRender()},relativeRotationAxis:new THREE.Vector3(0,1,0),arrowLineColor:3381555,arrowFaceColor:6736998,textColor:"#339933"});
SS.WorkplaneWRotationPreview=SS.WorkplaneRotationPreview.extend({initialize:function(a){this.relativeAnchorPosition=new THREE.Vector3(this.options.radius,0,0);SS.WorkplaneRotationPreview.prototype.initialize.call(this,a)},render:function(){SS.WorkplaneRotationPreview.prototype.render.call(this);this.postRender()},relativeRotationAxis:new THREE.Vector3(0,0,1),arrowLineColor:10040115,arrowFaceColor:13395558,textColor:"#cc6666"});
SS.RelativeAngleDimensionText=SS.DimensionText.extend({position:void 0,angle:0,initialize:function(a){this.color=a.color;this.parentView=a.parentView;SS.DimensionText.prototype.initialize.call(this)},render:function(){this.clear();this.$angle=this.addElement('<div class="dimension">'+(180<this.angle?-360+this.angle:this.angle)+"&deg;</div>");this.$angle.css("color",this.color);this.update()},update:function(){if(this.parentView.showDimensionAngleText&&this.position){var a=SS.objToVector(this.model.node.origin),
b=this.model.node.hasOwnProperty("axis")?SS.objToVector(this.model.node.axis):SS.objToVector(this.model.node.parameters),c=this.model.node.hasOwnProperty("angle")?this.model.node.angle:this.model.node.parameters.angle,b=SS.rotateAroundAxis(this.position,b,c);b.addSelf(a);this.moveToScreenCoordinates(this.$angle,b,20,-20);this.$angle.show()}else this.$angle.hide()}});SS=SS||{};
SS.DimensionArrowsView=SS.InteractiveSceneView.extend({priority:-1,active:!1,createDimArrow:function(a,b){var c=this.cameraScale,d=new THREE.Object3D,e=new THREE.Geometry;e.vertices.push(new THREE.Vector3(0,0,0));e.vertices.push(new THREE.Vector3(0,0,b.clone().length()));var e=new THREE.Line(e,SS.materials.lineMaterial),f=new THREE.CylinderGeometry(0,0.5*c,1.5*c,3),f=THREE.SceneUtils.createMultiMaterialObject(f,[SS.materials.faceMaterial,SS.materials.wireframeMaterial]);f.position.z=b.clone().length()-0.75*
c;f.rotation.x=Math.PI/2;d.add(e);d.add(f);d.lookAt(b.clone().normalize());return d}});SS=SS||{};
SS.TransformerInitiator=Backbone.Model.extend({initialize:function(a){this.originalNode=a.geomNode;this.normalizedBoundingBox=SS.normalizedBoundingBoxForGeomNode(this.originalNode);this.normalizedCenter=SS.centerOfGeom(this.normalizedBoundingBox);this.normalizedBoundingRadius=SS.normalizedBoundingRadius(this.normalizedBoundingBox);this.views=[];SS.selectionManager.on("deselected",this.deselected,this);SS.selectionManager.on("selected",this.selected,this)},selected:function(){1!==SS.selectionManager.size()&&this.destroy()},
deselected:function(a){1===a.length&&a[0]===this.originalNode.id&&this.destroy()},destroy:function(){SS.selectionManager.off("deselected",this.deselected);SS.selectionManager.off("selected",this.selected);this.views.map(function(a){a.remove()})}});
SS.Transformer=SS.NodeModel.extend({initialize:function(a){this.node=a.transform;this.originalNode=a.originalNode;this.editingNode=a.editingNode;a.editingExisting||(this.boundingBox=SS.boundingBoxForGeomNode(this.editingNode),this.normalizedBoundingBox=SS.normalizedBoundingBoxForGeomNode(this.editingNode),this.normalizedCenter=SS.centerOfGeom(this.normalizedBoundingBox),this.normalizedBoundingRadius=SS.normalizedBoundingRadius(this.normalizedBoundingBox));this.views=[new SS.NodeDOMView({model:this}),
new SS.OkCancelView({model:this})];geom_doc.on("replace",this.geomDocReplace,this);SS.commandStack.on("beforePop",this.cancel,this)},destroy:function(){this.views.map(function(a){a.remove()});geom_doc.off("replace",this.geomDocReplace);SS.commandStack.off("beforePop",this.cancel,this)},getBoundingBox:function(){return this.boundingBox},tryCommit:function(){var a=update_geom_command(this.originalNode,this.editingNode,this.editingNode);SS.commandStack.execute(a)},cancel:function(){this.destroy();geom_doc.replace(this.editingNode,
this.originalNode)},geomDocReplace:function(a){a===this.editingNode&&this.destroy()}});SS=SS||{};
SS.CuboidCreator=SS.PrimitiveCreator.extend({initialize:function(a){SS.PrimitiveCreator.prototype.initialize.call(this,a);this.views=this.views.concat([new SS.CuboidPreview({model:this}),new SS.DraggableUVCorner({model:this}),new SS.CuboidDimensionArrows({model:this}),new SS.CuboidDimensionText({model:this})]);this.trigger("change",this)},setDefaultParamters:function(){this.node.parameters.u=10;this.node.parameters.v=10;this.node.parameters.w=10},mouseDownOnUV:function(a){this.activateCorner(a,SS.UVWHeightCursoid)},
getBoundingBox:function(){var a=this.node.origin,b=this.node.parameters.u,c=this.node.parameters.v,d=this.node.parameters.w;return{min:new THREE.Vector3(a.x,a.y,a.z),max:new THREE.Vector3(a.x+b,a.y+c,a.z+d)}}});
SS.CuboidPreview=SS.PreviewWithOrigin.extend({initialize:function(){SS.PreviewWithOrigin.prototype.initialize.call(this);this.render()},render:function(){this.clear();SS.PreviewWithOrigin.prototype.render.call(this);var a=this.model.node.origin,b=this.model.node.parameters.u,c=this.model.node.parameters.v,d=this.model.node.parameters.w,e=[SS.materials.faceMaterial,SS.materials.wireframeMaterial];if(b&&c&&d){var f=new THREE.CubeGeometry(b,c,d),e=THREE.SceneUtils.createMultiMaterialObject(f,e);e.position=
new THREE.Vector3(b/2,c/2,d/2);this.sceneObject.add(e);a.z&&(d=new THREE.PlaneGeometry(b,c),d=new THREE.Mesh(d,SS.materials.wireframeMaterial),d.position=new THREE.Vector3(b/2,c/2,-a.z),d.rotation.x=Math.PI/2,this.sceneObject.add(d))}else b&&c&&(a=new THREE.PlaneGeometry(b,c),a=THREE.SceneUtils.createMultiMaterialObject(a,e),a.position=new THREE.Vector3(b/2,c/2,0),a.rotation.x=Math.PI/2,this.sceneObject.add(a));this.postRender()}});
SS.DraggableUVCorner=SS.DraggableCorner.extend({initialize:function(a){SS.DraggableCorner.prototype.initialize.call(this,a);this.uKey=a.uKey||"u";this.vKey=a.vKey||"v";this.render()},priority:1,mouseDown:function(){this.model.mouseDownOnUV(this)},cornerPositionFromModel:function(){return{x:this.model.node.origin.x+this.model.node.parameters[this.uKey],y:this.model.node.origin.y+this.model.node.parameters[this.vKey],z:0}},updateModelFromCorner:function(a){var b=a.y-this.model.node.origin.y;this.model.node.parameters[this.uKey]=
Math.round(a.x-this.model.node.origin.x);this.model.node.parameters[this.vKey]=Math.round(b)}});
SS.UVWHeightCursoid=SS.HeightCursoid.extend({initialize:function(a){SS.HeightCursoid.prototype.initialize.call(this);this.uKey=a.uKey||"u";this.render()},cornerPositionFromModel:function(){return{x:this.model.node.origin.x+this.model.node.parameters[this.uKey],y:this.model.node.origin.y+this.model.node.parameters.v,z:this.model.node.origin.z+this.model.node.parameters.w}},updateModelFromCorner:function(a){var b=this.model.node.parameters,c=this.model.node.origin;b[this.uKey]=a.x-c.x;b.v=a.y-c.y;b.w=
a.z-c.z}});
SS.CuboidDimensionArrows=SS.DimensionArrowsView.extend({render:function(){this.clear();var a=this.model.node.origin,b=this.model.node.parameters.u,c=this.model.node.parameters.v,d=this.model.node.parameters.w,e=this.createDimArrow(b,new THREE.Vector3(b,0,0)),f=this.createDimArrow(c,new THREE.Vector3(0,c,0)),d=this.createDimArrow(c,new THREE.Vector3(0,0,d));f.position=new THREE.Vector3(b,0,0);d.position=new THREE.Vector3(b,c,0);this.sceneObject.add(e);this.sceneObject.add(f);this.sceneObject.add(d);this.sceneObject.position=
new THREE.Vector3(a.x,a.y,a.z);this.postRender()}});
SS.CuboidDimensionText=SS.DimensionText.extend({render:function(){this.clear();var a=this;["u","v","w"].map(function(b){a["$"+b]=a.addElement('<div class="dimension">'+a.model.node.parameters[b]+"</div>")});this.update()},update:function(){var a=this.model.node.origin,b=this.model.node.parameters.u,c=this.model.node.parameters.v,d=this.model.node.parameters.w,a={u:new THREE.Vector3(a.x+b/2,a.y,a.z),v:new THREE.Vector3(a.x+b,a.y+c/2,a.z),w:new THREE.Vector3(a.x+b,a.y+c,a.z+d/2)};for(key in a)this.moveToScreenCoordinates(this["$"+
key],a[key])}});SS=SS||{};
SS.SphereCreator=SS.PrimitiveCreator.extend({initialize:function(a){SS.PrimitiveCreator.prototype.initialize.call(this,a);this.node.extra={angle:0};this.views=this.views.concat([new SS.SpherePreview({model:this}),new SS.DraggableRadiusCorner({model:this}),new SS.SphereDimensionArrow({model:this}),new SS.SphereDimensionText({model:this})]);this.trigger("change",this)},setDefaultParamters:function(){this.node.parameters.r=10},mouseDownOnRadius:function(a){this.activateCorner(a)},getBoundingBox:function(){var a=this.node.origin,
b=this.node.parameters.r;return{min:new THREE.Vector3(a.x-b,a.y-b,a.z-b),max:new THREE.Vector3(a.x+b,a.y+b,a.z+b)}}});
SS.SpherePreview=SS.PreviewWithOrigin.extend({initialize:function(){SS.PreviewWithOrigin.prototype.initialize.call(this);this.render()},render:function(){this.clear();SS.PreviewWithOrigin.prototype.render.call(this);var a=this.model.node.origin,b=this.model.node.parameters.r;if(b){var c=new THREE.SphereGeometry(b,50,10),c=new THREE.Mesh(c,SS.materials.faceMaterial);this.sceneObject.add(c);for(var d=new THREE.Geometry,e=0;50>=e;++e){var f=2*Math.PI*e/50,g=b*Math.cos(f),f=b*Math.sin(f);d.vertices.push(new THREE.Vector3(g,
f,0))}b=new THREE.Line(d,SS.materials.lineMaterial);this.sceneObject.add(b);b.position=c.position;a.z&&(b=new THREE.Line(d,SS.materials.lineMaterial),b.position.z=-a.z,this.sceneObject.add(b))}this.postRender()}});
SS.DraggableRadiusCorner=SS.DraggableCorner.extend({initialize:function(a){SS.DraggableCorner.prototype.initialize.call(this,a);this.key=a.key||"r";this.render()},priority:1,mouseDown:function(){this.model.mouseDownOnRadius(this)},cornerPositionFromModel:function(){var a=this.model.node.parameters[this.key],b=this.model.node.extra.angle,c=Math.cos(b)*a,a=Math.sin(b)*a;return{x:this.model.node.origin.x+c,y:this.model.node.origin.y+a,z:this.model.node.origin.z}},updateModelFromCorner:function(a){var b=
a.x-this.model.node.origin.x,c=a.y-this.model.node.origin.y,a=Math.atan2(c,b),b=Math.sqrt(b*b+c*c);this.model.node.parameters[this.key]=Math.round(b);this.model.node.extra={angle:a}}});
SS.SphereDimensionArrow=SS.DimensionArrowsView.extend({render:function(){this.clear();var a=this.model.node.origin,b=this.model.node.parameters.r,c=this.model.node.extra.angle,c=new THREE.Vector3(b*Math.cos(c),b*Math.sin(c),0),b=this.createDimArrow(b,c);this.sceneObject.add(b);this.sceneObject.position=new THREE.Vector3(a.x,a.y,a.z);this.postRender()}});
SS.SphereDimensionText=SS.DimensionText.extend({render:function(){this.clear();this.$r=this.addElement('<div class="dimension">'+this.model.node.parameters.r+"</div>");this.update()},update:function(){var a=this.model.node.origin,b=this.model.node.parameters.r,c=this.model.node.extra.angle;this.moveToScreenCoordinates(this.$r,new THREE.Vector3(a.x+b/2*Math.cos(c),a.y+b/2*Math.sin(c),a.z))}});SS=SS||{};
SS.CylinderCreator=SS.PrimitiveCreator.extend({initialize:function(a){SS.PrimitiveCreator.prototype.initialize.call(this,a);this.node.extra={angle:0};this.views=this.views.concat([new SS.CylinderPreview({model:this}),new SS.DraggableRadiusCorner({model:this}),new SS.CylinderDimensionArrows({model:this}),new SS.CylinderDimensionText({model:this})]);this.trigger("change",this)},setDefaultParamters:function(){this.node.parameters.r=10;this.node.parameters.h=10},mouseDownOnRadius:function(a){this.activateCorner(a,SS.RadiusHeightCursoid)},
getBoundingBox:function(){var a=this.node.origin,b=this.node.parameters.r,c=this.node.parameters.h;return{min:new THREE.Vector3(a.x-b,a.y-b,a.z),max:new THREE.Vector3(a.x+b,a.y+b,a.z+c)}}});
SS.CylinderPreview=SS.PreviewWithOrigin.extend({initialize:function(){SS.PreviewWithOrigin.prototype.initialize.call(this);this.render()},render:function(){this.clear();SS.PreviewWithOrigin.prototype.render.call(this);var a=this.model.node.origin,b=this.model.node.parameters.r,c=this.model.node.parameters.h;if(b){for(var d=new THREE.Geometry,e=new THREE.Geometry,f=0;50>=f;++f){var g=2*Math.PI*f/50,h=b*Math.cos(g),g=b*Math.sin(g);d.vertices.push(new THREE.Vector3(h,g,0));e.vertices.push(new THREE.Vector3(h,
g,0))}f=new THREE.Line(d,SS.materials.lineMaterial);this.sceneObject.add(f);a.z&&(d=new THREE.Line(d,SS.materials.lineMaterial),d.position.z=-a.z,this.sceneObject.add(d))}b&&c&&(a=new THREE.CylinderGeometry(b,b,c,20),a=new THREE.Mesh(a,SS.materials.faceMaterial),a.position.z=c/2,a.rotation.x=-Math.PI/2,e=new THREE.Line(e,SS.materials.lineMaterial),e.position.z=c,this.sceneObject.add(a),this.sceneObject.add(e));this.postRender()}});
SS.RadiusHeightCursoid=SS.HeightCursoid.extend({initialize:function(a){SS.HeightCursoid.prototype.initialize.call(this);this.key=a.key||"r";this.render()},priority:1,cornerPositionFromModel:function(){var a=this.model.node.parameters[this.key],b=this.model.node.parameters.h,c=this.model.node.extra.angle,d=Math.cos(c)*a,a=Math.sin(c)*a;return{x:this.model.node.origin.x+d,y:this.model.node.origin.y+a,z:this.model.node.origin.z+b}},updateModelFromCorner:function(a){var b=a.x-this.model.node.origin.x,
c=a.y-this.model.node.origin.y,d=Math.atan2(c,b),b=Math.sqrt(b*b+c*c),a=a.z-this.model.node.origin.z;this.model.node.parameters[this.key]=Math.round(b);this.model.node.parameters.h=Math.round(a);this.model.node.extra={angle:d}}});
SS.CylinderDimensionArrows=SS.DimensionArrowsView.extend({render:function(){this.clear();var a=this.model.node.origin,b=this.model.node.parameters.r,c=this.model.node.parameters.h,d=this.model.node.extra.angle,d=new THREE.Vector3(b*Math.cos(d),b*Math.sin(d),0),b=this.createDimArrow(b,d);this.sceneObject.add(b);c=this.createDimArrow(c,new THREE.Vector3(0,0,c));c.position=d;this.sceneObject.add(c);this.sceneObject.position=new THREE.Vector3(a.x,a.y,a.z);this.postRender()}});
SS.CylinderDimensionText=SS.DimensionText.extend({render:function(){this.clear();var a=this.model.node.parameters.h;this.$r=this.addElement('<div class="dimension">'+this.model.node.parameters.r+"</div>");this.$h=this.addElement('<div class="dimension">'+a+"</div>");this.update()},update:function(){var a=this.model.node.origin,b=this.model.node.parameters.r,c=this.model.node.parameters.h,d=this.model.node.extra.angle;new THREE.Vector3(b*Math.cos(d),b*Math.sin(d),0);this.moveToScreenCoordinates(this.$r,
new THREE.Vector3(a.x+b/2*Math.cos(d),a.y+b/2*Math.sin(d),a.z));this.moveToScreenCoordinates(this.$h,new THREE.Vector3(a.x+b*Math.cos(d),a.y+b*Math.sin(d),a.z+c/2))}});SS=SS||{};
SS.ConeCreator=SS.PrimitiveCreator.extend({initialize:function(a){SS.PrimitiveCreator.prototype.initialize.call(this,a);this.node.extra={angle:0};this.views=this.views.concat([new SS.ConePreview({model:this}),new SS.DraggableRadiusCorner({model:this,key:"r1"}),new SS.ConeDimensionArrows({model:this}),new SS.ConeDimensionText({model:this})]);this.trigger("change",this)},setDefaultParamters:function(){this.node.parameters.r1=10;this.node.parameters.r2=0;this.node.parameters.h=10},mouseDownOnRadius:function(a){this.activateCorner(a,SS.RadiusHeightCursoid,
{model:this,key:"r1"})},getBoundingBox:function(){var a=this.node.origin,b=this.node.parameters.r1,c=this.node.parameters.h;return{min:new THREE.Vector3(a.x-b,a.y-b,a.z),max:new THREE.Vector3(a.x+b,a.y+b,a.z+c)}}});
SS.ConePreview=SS.PreviewWithOrigin.extend({initialize:function(){SS.PreviewWithOrigin.prototype.initialize.call(this);this.render()},render:function(){this.clear();SS.PreviewWithOrigin.prototype.render.call(this);var a=this.model.node.origin,b=this.model.node.parameters.r1,c=this.model.node.parameters.r2,d=this.model.node.parameters.h;if(b&&d){var e=new THREE.CylinderGeometry(b,c||1E-6,d,20),e=new THREE.Mesh(e,SS.materials.faceMaterial);e.position.z=d/2;e.rotation.x=-Math.PI/2;this.sceneObject.add(e);
for(var f=new THREE.Geometry,e=0;50>=e;++e){var g=2*Math.PI*e/50,h=c*Math.cos(g),g=c*Math.sin(g);f.vertices.push(new THREE.Vector3(h,g,0))}c=new THREE.Line(f,SS.materials.lineMaterial);c.position.z=d;this.sceneObject.add(c)}b&&!d&&(d=new THREE.EllipseGeometry(b,b),d=new THREE.Mesh(d,SS.materials.faceMaterial),d.doubleSided=!0,this.sceneObject.add(d));if(b){d=new THREE.Geometry;for(e=0;50>=e;++e)g=2*Math.PI*e/50,h=b*Math.cos(g),g=b*Math.sin(g),d.vertices.push(new THREE.Vector3(h,g,0));b=new THREE.Line(d,
SS.materials.lineMaterial);this.sceneObject.add(b);a.z&&(b=new THREE.Line(d,SS.materials.lineMaterial),b.position.z=-a.z,this.sceneObject.add(b))}this.postRender()}});
SS.ConeDimensionArrows=SS.DimensionArrowsView.extend({render:function(){this.clear();var a=this.model.node.origin,b=this.model.node.parameters.r1,c=this.model.node.parameters.r2,d=this.model.node.parameters.h,e=this.model.node.extra.angle,f=new THREE.Vector3(b*Math.cos(e),b*Math.sin(e),0),b=this.createDimArrow(b,f);this.sceneObject.add(b);c&&(e=new THREE.Vector3(c*Math.cos(e),c*Math.sin(e),0),c=this.createDimArrow(c,e),c.position=new THREE.Vector3(0,0,d),this.sceneObject.add(c));d=this.createDimArrow(d,
new THREE.Vector3(0,0,d));this.sceneObject.add(d);this.sceneObject.position=new THREE.Vector3(a.x,a.y,a.z);this.postRender()}});
SS.ConeDimensionText=SS.DimensionText.extend({render:function(){this.clear();var a=this.model.node.parameters.r2,b=this.model.node.parameters.h;this.$r1=this.addElement('<div class="dimension">'+this.model.node.parameters.r1+"</div>");this.$h=this.addElement('<div class="dimension">'+b+"</div>");a&&(this.$r2=this.addElement('<div class="dimension">'+a+"</div>"));this.update()},update:function(){var a=this.model.node.origin,b=this.model.node.parameters.r1,c=this.model.node.parameters.r2,d=this.model.node.parameters.h,
e=this.model.node.extra.angle;new THREE.Vector3(b*Math.cos(e),b*Math.sin(e),0);this.moveToScreenCoordinates(this.$r1,new THREE.Vector3(a.x+b/2*Math.cos(e),a.y+b/2*Math.sin(e),a.z));this.$r2&&this.moveToScreenCoordinates(this.$r2,new THREE.Vector3(a.x+c/2*Math.cos(e),a.y+c/2*Math.sin(e),a.z+d));this.moveToScreenCoordinates(this.$h,new THREE.Vector3(a.x,a.y,a.z+d/2))}});SS=SS||{};
SS.WedgeCreator=SS.PrimitiveCreator.extend({initialize:function(a){SS.PrimitiveCreator.prototype.initialize.call(this,a);this.views=this.views.concat([new SS.WedgePreview({model:this}),new SS.DraggableUVCorner({model:this,uKey:"u2"}),new SS.DraggableUCorner({model:this,uKey:"u1"}),new SS.WedgeDimensionArrows({model:this}),new SS.WedgeDimensionText({model:this})]);this.trigger("change",this)},setDefaultParamters:function(){this.node.parameters.u1=10;this.node.parameters.u2=5;this.node.parameters.v=10;
this.node.parameters.w=10},mouseDownOnUV:function(a){this.activateCorner(a,SS.UVWHeightCursoid,{model:this,uKey:"u2"})},mouseDownOnU:function(a){this.activateCorner(a)},getBoundingBox:function(){var a=this.node.origin,b=this.node.parameters.u,c=this.node.parameters.v,d=this.node.parameters.w;return{min:new THREE.Vector3(a.x,a.y,a.z),max:new THREE.Vector3(a.x+b,a.y+c,a.z+d)}}});
SS.WedgePreview=SS.PreviewWithOrigin.extend({initialize:function(){SS.PreviewWithOrigin.prototype.initialize.call(this);this.render()},render:function(){this.clear();SS.PreviewWithOrigin.prototype.render.call(this);var a=this.model.node.origin,b=this.model.node.parameters.u1,c=this.model.node.parameters.u2,d=this.model.node.parameters.v,e=this.model.node.parameters.w,f=[SS.materials.faceMaterial,SS.materials.wireframeMaterial];if(b&&d&&e){var g=new THREE.WedgeGeometry(b,d,e,c-b),f=[SS.materials.faceMaterial,
SS.materials.wireframeMaterial],f=THREE.SceneUtils.createMultiMaterialObject(g,f);f.position.x=b/2;f.position.y=d/2;f.position.z=e/2;this.sceneObject.add(f)}b&&(d&&c)&&(f=new THREE.Geometry,f.vertices.push(new THREE.Vector3(0,0,0)),f.vertices.push(new THREE.Vector3(b,0,0)),f.vertices.push(new THREE.Vector3(c,d,0)),f.vertices.push(new THREE.Vector3(0,d,0)),f.vertices.push(new THREE.Vector3(0,0,0)),e||(b=new THREE.Line(f,SS.materials.lineMaterial),this.sceneObject.add(b)),a.z&&(b=new THREE.Line(f,SS.materials.lineMaterial),
b.position.z=-a.z,this.sceneObject.add(b)));this.postRender()}});
SS.DraggableUCorner=SS.DraggableCorner.extend({initialize:function(a){SS.DraggableCorner.prototype.initialize.call(this,a);this.uKey=a.uKey||"u1";this.render()},priority:2,mouseDown:function(){this.model.mouseDownOnU(this)},cornerPositionFromModel:function(){return{x:this.model.node.origin.x+this.model.node.parameters[this.uKey],y:this.model.node.origin.y+this.model.node.parameters.v,z:0}},updateModelFromCorner:function(a){this.model.node.parameters[this.uKey]=Math.round(a.x-this.model.node.origin.x)}});
SS.WedgeDimensionArrows=SS.DimensionArrowsView.extend({render:function(){this.clear();var a=this.model.node.origin,b=this.model.node.parameters.u1,c=this.model.node.parameters.u2,d=this.model.node.parameters.v,e=this.model.node.parameters.w,b=this.createDimArrow(b,new THREE.Vector3(b,0,0)),f=this.createDimArrow(c,new THREE.Vector3(c,0,0)),g=this.createDimArrow(d,new THREE.Vector3(0,d,0)),e=this.createDimArrow(d,new THREE.Vector3(0,0,e));f.position=new THREE.Vector3(0,d,0);g.position=new THREE.Vector3(0,
0,0);e.position=new THREE.Vector3(c,d,0);this.sceneObject.add(b);this.sceneObject.add(f);this.sceneObject.add(g);this.sceneObject.add(e);this.sceneObject.position=new THREE.Vector3(a.x,a.y,a.z);this.postRender()}});
SS.WedgeDimensionText=SS.DimensionText.extend({render:function(){this.clear();var a=this;["u1","u2","v","w"].map(function(b){a["$"+b]=a.addElement('<div class="dimension">'+a.model.node.parameters[b]+"</div>")});this.update()},update:function(){var a=this.model.node.origin,b=this.model.node.parameters.u2,c=this.model.node.parameters.v,d=this.model.node.parameters.w,a={u1:new THREE.Vector3(a.x+this.model.node.parameters.u1/2,a.y,a.z),u2:new THREE.Vector3(a.x+b/2,a.y+c,a.z),v:new THREE.Vector3(a.x,
a.y+c/2,a.z),w:new THREE.Vector3(a.x+b,a.y+c,a.z+d/2)};for(key in a)this.moveToScreenCoordinates(this["$"+key],a[key])}});SS=SS||{};
SS.TorusCreator=SS.PrimitiveCreator.extend({initialize:function(a){SS.PrimitiveCreator.prototype.initialize.call(this,a);this.node.extra={angle:0};this.views=this.views.concat([new SS.TorusPreview({model:this}),new SS.DraggableRadiusCorner({model:this,key:"r1"}),new SS.TorusR2Corner({model:this}),new SS.TorusDimensionArrows({model:this}),new SS.TorusDimensionText({model:this})]);this.trigger("change",this)},setDefaultParamters:function(){this.node.parameters.r1=20;this.node.parameters.r2=5},mouseDownOnRadius:function(a){this.activateCorner(a)},
getBoundingBox:function(){var a=this.node.origin,b=this.node.parameters.r1,c=this.node.parameters.r2;return{min:new THREE.Vector3(a.x-b-c,a.y-b-c,a.z-c),max:new THREE.Vector3(a.x+b+c,a.y+b+c,a.z+c)}}});
SS.TorusPreview=SS.PreviewWithOrigin.extend({initialize:function(){SS.PreviewWithOrigin.prototype.initialize.call(this);this.render()},render:function(){this.clear();SS.PreviewWithOrigin.prototype.render.call(this);var a=this.model.node.origin,b=this.model.node.parameters.r1,c=this.model.node.parameters.r2,d=this.model.node.origin.z;if(b){for(var e=new THREE.Geometry,f=0;50>=f;++f){var g=2*Math.PI*f/50,h=b*Math.cos(g),g=b*Math.sin(g);e.vertices.push(new THREE.Vector3(h,g,0))}f=new THREE.Line(e,SS.materials.lineMaterial);
this.sceneObject.add(f);0!==d&&(d=new THREE.Line(e,SS.materials.lineMaterial),d.position.z=-a.z,this.sceneObject.add(d))}if(b&&c){e=new THREE.Geometry;d=new THREE.Geometry;for(f=0;50>=f;++f){var g=2*Math.PI*f/50,h=(b+c)*Math.cos(g),j=(b+c)*Math.sin(g),l=(b-c)*Math.cos(g),g=(b-c)*Math.sin(g);e.vertices.push(new THREE.Vector3(h,j,0));d.vertices.push(new THREE.Vector3(l,g,0))}f=new THREE.Line(e,SS.materials.lineMaterial);this.sceneObject.add(f);f=new THREE.Line(d,SS.materials.lineMaterial);this.sceneObject.add(f);
b=new THREE.TorusGeometry(b,c,10,50);b=new THREE.Mesh(b,SS.materials.faceMaterial);this.sceneObject.add(b);0!==a.z&&(b=new THREE.Line(e,SS.materials.lineMaterial),b.position.z=-a.z,this.sceneObject.add(b),b=new THREE.Line(d,SS.materials.lineMaterial),this.sceneObject.add(b),b.position.z=-a.z)}this.postRender()}});
SS.TorusR2Corner=SS.DraggableCorner.extend({initialize:function(a){SS.DraggableCorner.prototype.initialize.call(this,a);this.render()},priority:2,mouseDown:function(){this.model.mouseDownOnRadius(this)},cornerPositionFromModel:function(){var a=this.model.node.parameters.r1,b=this.model.node.parameters.r2,c=this.model.node.extra.angle,d=Math.cos(c)*(a+b),a=Math.sin(c)*(a+b);return{x:this.model.node.origin.x+d,y:this.model.node.origin.y+a,z:this.model.node.origin.z}},updateModelFromCorner:function(a){var b=
a.x-this.model.node.origin.x,c=a.y-this.model.node.origin.y,a=Math.atan2(c,b),b=Math.sqrt(b*b+c*c),b=Math.abs(b-this.model.node.parameters.r1);this.model.node.parameters.r2=Math.round(b);this.model.node.extra={angle:a}}});
SS.TorusDimensionArrows=SS.DimensionArrowsView.extend({render:function(){this.clear();var a=this.model.node.origin,b=this.model.node.parameters.r1,c=this.model.node.parameters.r2,d=this.model.node.extra.angle,e=new THREE.Vector3(b*Math.cos(d),b*Math.sin(d),0),b=this.createDimArrow(b,e);this.sceneObject.add(b);d=new THREE.Vector3(c*Math.cos(d),c*Math.sin(d),0);c=this.createDimArrow(c,d);c.position=e;this.sceneObject.add(c);this.sceneObject.position=new THREE.Vector3(a.x,a.y,a.z);this.postRender()}});
SS.TorusDimensionText=SS.DimensionText.extend({render:function(){this.clear();var a=this.model.node.parameters.r2;this.$r1=this.addElement('<div class="dimension">'+this.model.node.parameters.r1+"</div>");this.$r2=this.addElement('<div class="dimension">'+a+"</div>");this.update()},update:function(){var a=this.model.node.origin,b=this.model.node.parameters.r1,c=this.model.node.parameters.r2,d=this.model.node.extra.angle;new THREE.Vector3(b*Math.cos(d),b*Math.sin(d),0);this.moveToScreenCoordinates(this.$r1,
new THREE.Vector3(a.x+b/2*Math.cos(d),a.y+b/2*Math.sin(d),a.z));this.moveToScreenCoordinates(this.$r2,new THREE.Vector3(a.x+(b+c/2)*Math.cos(d),a.y+(b+c/2)*Math.sin(d),a.z))}});SS=SS||{};
SS.Ellipse2DCreator=SS.PrimitiveCreator.extend({initialize:function(a){SS.PrimitiveCreator.prototype.initialize.call(this,a);this.views=this.views.concat([new SS.EllipsePreview({model:this,is2D:!0}),new SS.DraggableUVCorner({model:this,uKey:"r1",vKey:"r2"}),new SS.Ellipse2DDimensionArrows({model:this}),new SS.Ellipse2DDimensionText({model:this}),new SS.DraggableAngleCorner({model:this,key:"from_angle",priority:2}),new SS.DraggableAngleCorner({model:this,key:"to_angle",priority:3})]);this.trigger("change",this)},
setDefaultParamters:function(){this.node.parameters.r1=20;this.node.parameters.r2=10;this.node.parameters.from_angle=0;this.node.parameters.to_angle=360},mouseDownOnUV:function(a){this.activateCorner(a)},getBoundingBox:function(){var a=this.node.origin,b=this.node.parameters.r1,c=this.node.parameters.r2;return{min:new THREE.Vector3(a.x-b,a.y-c,a.z),max:new THREE.Vector3(a.x+b,a.y+c,a.z)}}});
SS.EllipsePreview=SS.PreviewWithOrigin.extend({initialize:function(){SS.PreviewWithOrigin.prototype.initialize.call(this);this.render()},render:function(){this.clear();SS.PreviewWithOrigin.prototype.render.call(this);var a=this.model.node.origin,b=this.model.node.parameters.r1,c=this.model.node.parameters.r2,d=this.model.node.parameters.from_angle,e=this.model.node.parameters.to_angle||360;if(this.options.is2D){var f=new THREE.EllipseGeometry(b,c,d,e),f=new THREE.Mesh(f,SS.materials.faceMaterial);
f.doubleSided=!0;this.sceneObject.add(f)}for(var f=new THREE.Geometry,e=e-d,e=0>e?e+360:e,g=0;50>=g;++g){var h=(d+e*g/50)/180*Math.PI,j=b*Math.cos(h),h=c*Math.sin(h);f.vertices.push(new THREE.Vector3(j,h,0))}b=new THREE.Line(f,SS.materials.lineMaterial);this.sceneObject.add(b);0!==a.z&&(b=new THREE.Line(f,SS.materials.lineMaterial),b.position=new THREE.Vector3(0,0,-a.z),this.sceneObject.add(b));this.postRender()}});
SS.Ellipse2DDimensionArrows=SS.DimensionArrowsView.extend({render:function(){this.clear();var a=this.model.node.origin,b=this.model.node.parameters.r1,c=this.model.node.parameters.r2,d=new THREE.Vector3(b,0,0),b=this.createDimArrow(b,d);this.sceneObject.add(b);b=new THREE.Vector3(0,c,0);c=this.createDimArrow(c,b);this.sceneObject.add(c);this.sceneObject.position=new THREE.Vector3(a.x,a.y,a.z);this.postRender()}});
SS.Ellipse2DDimensionText=SS.DimensionText.extend({render:function(){this.clear();var a=this.model.node.parameters.r2;this.$r1=this.addElement('<div class="dimension">'+this.model.node.parameters.r1+"</div>");this.$r2=this.addElement('<div class="dimension">'+a+"</div>");this.update()},update:function(){var a=this.model.node.origin,b=this.model.node.parameters.r2;this.moveToScreenCoordinates(this.$r1,new THREE.Vector3(a.x+this.model.node.parameters.r1/2,a.y,a.z));this.moveToScreenCoordinates(this.$r2,
new THREE.Vector3(a.x,a.y+b/2,a.z))}});SS=SS||{};
SS.Rectangle2DCreator=SS.PrimitiveCreator.extend({initialize:function(a){SS.PrimitiveCreator.prototype.initialize.call(this,a);this.views=this.views.concat([new SS.Rectangle2DPreview({model:this}),new SS.DraggableUVCorner({model:this}),new SS.Rectangle2DDimensionArrows({model:this}),new SS.Rectangle2DDimensionText({model:this})]);this.trigger("change",this)},setDefaultParamters:function(){this.node.parameters.u=10;this.node.parameters.v=10},mouseDownOnUV:function(a){this.activateCorner(a)},getBoundingBox:function(){var a=
this.node.origin,b=this.node.parameters.u,c=this.node.parameters.v;return{min:new THREE.Vector3(a.x,a.y,a.z),max:new THREE.Vector3(a.x+b,a.y+c,a.z)}}});
SS.Rectangle2DPreview=SS.PreviewWithOrigin.extend({initialize:function(){SS.PreviewWithOrigin.prototype.initialize.call(this);this.render()},render:function(){this.clear();SS.PreviewWithOrigin.prototype.render.call(this);var a=this.model.node.origin,b=this.model.node.parameters.u,c=this.model.node.parameters.v;if(b&&c){var d=new THREE.PlaneGeometry(b,c),e=THREE.SceneUtils.createMultiMaterialObject(d,[SS.materials.faceMaterial,SS.materials.wireframeMaterial]);e.doubleSided=!0;e.position=new THREE.Vector3(b/
2,c/2,0);e.rotation.x=Math.PI/2;this.sceneObject.add(e);0!==a.z&&(d=new THREE.Mesh(d,SS.materials.wireframeMaterial),d.position=new THREE.Vector3(b/2,c/2,-a.z),d.rotation.x=Math.PI/2,this.sceneObject.add(d))}this.postRender()}});
SS.Rectangle2DDimensionArrows=SS.DimensionArrowsView.extend({render:function(){this.clear();var a=this.model.node.origin,b=this.model.node.parameters.u,c=this.model.node.parameters.v,d=this.createDimArrow(b,new THREE.Vector3(b,0,0)),c=this.createDimArrow(c,new THREE.Vector3(0,c,0));c.position=new THREE.Vector3(b,0,0);this.sceneObject.add(d);this.sceneObject.add(c);this.sceneObject.position=new THREE.Vector3(a.x,a.y,a.z);this.postRender()}});
SS.Rectangle2DDimensionText=SS.DimensionText.extend({render:function(){this.clear();var a=this;["u","v"].map(function(b){a["$"+b]=a.addElement('<div class="dimension">'+a.model.node.parameters[b]+"</div>")});this.update()},update:function(){var a=this.model.node.origin,b=this.model.node.parameters.u,c=this.model.node.parameters.v,a={u:new THREE.Vector3(a.x+b/2,a.y,a.z),v:new THREE.Vector3(a.x+b,a.y+c/2,a.z)};for(key in a)this.moveToScreenCoordinates(this["$"+key],a[key])}});SS=SS||{};
SS.Triangle2DCreator=SS.PrimitiveCreator.extend({initialize:function(a){SS.PrimitiveCreator.prototype.initialize.call(this,a);this.views=this.views.concat([new SS.Triangle2DPreview({model:this}),new SS.DraggableVertexCorner({model:this,vertexIndex:0}),new SS.DraggableVertexCorner({model:this,vertexIndex:1}),new SS.DraggableVertexCorner({model:this,vertexIndex:2}),new SS.VertexDimensionText({model:this,vertexIndex:0}),new SS.VertexDimensionText({model:this,vertexIndex:1}),new SS.VertexDimensionText({model:this,vertexIndex:2})])},
setDefaultParamters:function(){this.node.parameters.vertices.map(function(a){a.u=10;a.v=10;a.w=0});this.node.parameters.vertices[1].u=0;this.node.parameters.vertices[2].v=0},mouseDownOnCorner:function(a){this.activateCorner(a,SS.VertexHeightCursoid,{model:this,vertexIndex:a.vertexIndex})},getBoundingBox:function(){var a=this.node.origin,b={},c={};this.node.parameters.vertices.map(function(d){var e={x:"u",y:"v",z:"w"};for(key in e){var f=a[key]+d[e[key]];b[key]=b[key]&&Math.min(f,b[key])||f;c[key]=
c[key]&&Math.max(f,c[key])||f}});return{min:new THREE.Vector3(b.x,b.y,b.z),max:new THREE.Vector3(c.x,c.y,c.z)}}});
SS.Triangle2DPreview=SS.PreviewWithOrigin.extend({initialize:function(){SS.SceneObjectView.prototype.initialize.call(this);this.render()},render:function(){this.clear();SS.PreviewWithOrigin.prototype.render.call(this);var a=new THREE.Geometry,b=this.model.node.origin,c=this.model.node.parameters.vertices;a.vertices=c.map(function(a){return new THREE.Vector3(a.u,a.v,a.w)});a.faces.push(new THREE.Face3(0,1,2));var d=new THREE.Mesh(a,SS.materials.faceMaterial);d.doubleSided=!0;a=new THREE.Mesh(a,SS.materials.wireframeMaterial);
this.sceneObject.add(d);this.sceneObject.add(a);var e=this;c.map(function(a){var b=new THREE.CubeGeometry(0.2,0.2,0.2),c=[new THREE.MeshBasicMaterial({color:13421772,opacity:0.5,wireframe:!1}),new THREE.MeshBasicMaterial({color:10066329,wireframe:!0})],b=THREE.SceneUtils.createMultiMaterialObject(b,c);b.position=new THREE.Vector3(a.u,a.v,a.w);e.sceneObject.add(b)});b.z&&(d=new THREE.Geometry,c=c.concat([c[0]]),d.vertices=c.map(function(a){return new THREE.Vector3(a.u,a.v,0)}),c=new THREE.Line(d,SS.materials.lineMaterial),
c.position.z=-b.z,this.sceneObject.add(c));this.postRender()},priority:-1});
SS.DraggableVertexCorner=SS.DraggableCorner.extend({initialize:function(a){SS.DraggableCorner.prototype.initialize.call(this,a);this.vertexIndex=a.vertexIndex;this.render()},priority:1,mouseDown:function(){this.model.mouseDownOnCorner(this)},cornerPositionFromModel:function(){var a=this.model.node.parameters.vertices[this.vertexIndex];return{x:this.model.node.origin.x+a.u,y:this.model.node.origin.y+a.v,z:this.model.node.origin.z+a.w}},updateModelFromCorner:function(a){var b=this.model.node.parameters.vertices[this.vertexIndex],
c=this.model.node.origin;b.u=a.x-c.x;b.v=a.y-c.y},priority:2});
SS.VertexHeightCursoid=SS.HeightCursoid.extend({initialize:function(a){this.vertexIndex=a.vertexIndex;SS.HeightCursoid.prototype.initialize.call(this);this.render()},cornerPositionFromModel:function(){var a=this.model.node.parameters.vertices[this.vertexIndex];return{x:this.model.node.origin.x+a.u,y:this.model.node.origin.y+a.v,z:this.model.node.origin.z+a.w}},updateModelFromCorner:function(a){var b=this.model.node.parameters.vertices[this.vertexIndex],c=this.model.node.origin;b.u=a.x-c.x;b.v=a.y-
c.y;b.w=a.z-c.z}});SS.VertexDimensionText=SS.DimensionText.extend({render:function(){this.clear();var a=this.model.node.parameters.vertices[this.options.vertexIndex],b=a.u+","+a.v;a.w&&(b=b+","+a.w);this.$uvw=this.addElement('<div class="dimension">('+b+")</div>");this.update()},update:function(){var a=this.model.node.parameters.vertices[this.options.vertexIndex],b=this.model.node.origin;this.moveToScreenCoordinates(this.$uvw,new THREE.Vector3(b.x+a.u,b.y+a.v,b.z+a.w),20,-20)}});SS=SS||{};
SS.Text2DCreator=SS.PrimitiveCreator.extend({initialize:function(a){SS.PrimitiveCreator.prototype.initialize.call(this,a);this.textPreview=new SS.Text2DPreview({model:this});this.views=this.views.concat([this.textPreview,new SS.Text2DTextView({model:this})]);this.trigger("change",this)},setDefaultParamters:function(){this.node.parameters.text="Abc";this.node.parameters.font="DroidSerif"},mouseDownOnUV:function(a){this.activateCorner(a)},getBoundingBox:function(){if(!this.textPreview)return null;var a=
SS.boundingBoxForSceneObject(this.textPreview.sceneObject),b=this.node.origin;["min","max"].map(function(c){a[c].x+=b.x;a[c].y+=b.y;a[c].z+=b.z});return a}});
SS.Text2DPreview=SS.PreviewWithOrigin.extend({initialize:function(){SS.PreviewWithOrigin.prototype.initialize.call(this);this.render()},render:function(){this.clear();SS.PreviewWithOrigin.prototype.render.call(this);var a=this.model.node.parameters.text,b=this.model.node.parameters.font,c={DroidSerif:"droid serif",OpenSans:"open sans",Lobster:"lobster 1.4",Inconsolata:"inconsolata"}[b];a&&b&&(a=new THREE.TextGeometry(a,{size:10,height:0.01,curveSegments:6,font:c,weight:"normal",style:"normal",bezelEnabled:!1}),
a=new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:SS.materials.faceColor,transparent:!0,opacity:0.5})),this.sceneObject.add(a));this.postRender()}});
SS.Text2DTextView=Backbone.View.extend({initialize:function(){this.render();this.model.on("change",this.update,this)},remove:function(){Backbone.View.prototype.remove.call(this);this.model.off("change",this.update)},render:function(){this.$el.html($.mustache('<input class="field" id="floating-text" value="{{value}}"/>',{value:this.model.node.parameters.text}));$("#floating-dom-view .params").append(this.$el)},events:{"change .field":"fieldChanged","keyup .field":"fieldChanged"},update:function(){$("#floating-text").val(this.model.node.parameters.text)},
fieldChanged:function(){this.preventUpdate=!0;this.model.setParameters({text:$("#floating-text").val()});this.preventUpdate=!1}});SS=SS||{};
SS.PrismCreator=SS.ParentCreator.extend({initialize:function(a){a.noOriginCorner=!0;SS.ParentCreator.prototype.initialize.call(this,a);this.originalNode?this.boundingBox=SS.boundingBoxForGeomNode(this.editingNode):(this.node.parameters.u=0,this.node.parameters.v=0,this.node.parameters.w=10,this.views.push(new SS.PrismGeomNodeView({model:this})),this.trigger("change:model",this));this.views=this.views.concat([new SS.PrismUVCorner({model:this}),new SS.PrismHeightCursoid({model:this}),new SS.PrismDimensionArrow({model:this}),new SS.PrismDimensionText({model:this})]);
this.trigger("change",this)},mouseDownOnUV:function(){},getBoundingBox:function(){if(this.boundingBox)return{min:this.boundingBox.min.clone(),max:this.boundingBox.max.clone()}}});
SS.PrismGeomNodeView=SS.SceneObjectView.extend({initialize:function(){SS.SceneObjectView.prototype.initialize.call(this);this.model.on("change:model",this.render,this);this.bottomMeshes=SS.createGeometry(this.model.childNode);this.changeToPreviewColor(this.bottomMeshes);this.render()},remove:function(){SS.SceneObjectView.prototype.remove.call(this);this.model.off("change:model",this.render)},dontApplyWorkplane:!0,render:function(){this.clear();this.sceneObject.add(this.bottomMeshes.faces);this.sceneObject.add(this.bottomMeshes.edges);
var a=SS.objToVector(this.model.node.workplane.axis),b=this.model.node.workplane.angle,c=SS.rotateAroundAxis(SS.objToVector(this.model.node.parameters),a,b),d=SS.createGeometry(this.model.childNode);["faces","edges"].map(function(a){for(var a=d[a],b=0;b<a.children.length;++b){var g=a.children[b].geometry;g.vertices=g.vertices.map(function(a){return a.addSelf(c)})}});this.changeToPreviewColor(d);this.model.boundingBox=SS.boundingBoxForSceneObject(this.sceneObject);this.model.center=SS.centerOfGeom(this.model.boundingBox);
this.sceneObject.add(d.faces);this.sceneObject.add(d.edges);a=this.model.node.origin;this.sceneObject.position=new THREE.Vector3(a.x,a.y,a.z);this.postRender()},changeToPreviewColor:function(a){a.faces.children.map(function(a){a.material=SS.materials.faceMaterial});a.edges.children.map(function(a){a.material=SS.materials.lineMaterial})}});
SS.PrismUVCorner=SS.DraggableCorner.extend({initialize:function(a){SS.DraggableCorner.prototype.initialize.call(this,a);this.render()},priority:1,mouseDown:function(){this.model.mouseDownOnUV(this)},cornerPositionFromModel:function(){return{x:this.model.node.origin.x+this.model.node.parameters.u,y:this.model.node.origin.y+this.model.node.parameters.v,z:this.model.node.origin.z}},updateModelFromCorner:function(a){var b=a.y-this.model.node.origin.y;this.model.node.parameters.u=Math.round(a.x-this.model.node.origin.x);
this.model.node.parameters.v=Math.round(b)}});SS.PrismHeightCursoid=SS.HeightCursoid.extend({initialize:function(){SS.HeightCursoid.prototype.initialize.call(this);this.render()},cornerPositionFromModel:function(){return{x:this.model.node.origin.x+this.model.node.parameters.u,y:this.model.node.origin.y+this.model.node.parameters.v,z:this.model.node.parameters.w}},updateModelFromCorner:function(a){this.model.node.parameters.w=a.z}});
SS.PrismDimensionArrow=SS.DimensionArrowsView.extend({render:function(){this.clear();var a=this.model.node.parameters.u,a=this.createDimArrow(a,new THREE.Vector3(a,this.model.node.parameters.v,this.model.node.parameters.w));this.sceneObject.add(a);this.sceneObject.position=new THREE.Vector3(this.model.node.origin.x,this.model.node.origin.y,0);this.postRender()}});
SS.PrismDimensionText=SS.DimensionText.extend({render:function(){this.clear();this.$uvw=this.addElement('<div class="dimension">('+this.model.node.parameters.u+","+this.model.node.parameters.v+","+this.model.node.parameters.w+")</div>");this.update()},update:function(){this.moveToScreenCoordinates(this.$uvw,new THREE.Vector3(this.model.node.origin.x+this.model.node.parameters.u/2,this.model.node.origin.y+this.model.node.parameters.v/2,this.model.node.origin.z+this.model.node.parameters.w/2))}});SS=SS||{};
SS.RevolveCreator=SS.ParentCreator.extend({initialize:function(a){a.noOriginCorner=!0;SS.ParentCreator.prototype.initialize.call(this,a);this.originalNode?this.boundingBox=SS.boundingBoxForGeomNode(this.editingNode):(this.node.parameters.u=0,this.node.parameters.v=0,this.node.parameters.w=1,this.node.parameters.angle=360,this.views.push(new SS.ParentGeomNodeView({model:this})),this.trigger("change:model",this));this.views=this.views.concat([new SS.DraggableOriginCorner({model:this}),new SS.RevolveAxisPreview({model:this}),new SS.XYZAxisChoice({model:this})]);
this.trigger("change",this)},getBoundingBox:function(){return this.boundingBox}});
SS.ParentGeomNodeView=SS.SceneObjectView.extend({initialize:function(){SS.SceneObjectView.prototype.initialize.call(this);this.model.on("change:model",this.render,this);this.meshes=SS.createGeometry(this.model.childNode);this.changeToPreviewColor(this.meshes);this.render()},remove:function(){SS.SceneObjectView.prototype.remove.call(this);this.model.off("change:model",this.render)},dontApplyWorkplane:!0,render:function(){this.clear();this.sceneObject.add(this.meshes.faces);this.sceneObject.add(this.meshes.edges);
this.postRender()},changeToPreviewColor:function(a){a.faces.children.map(function(a){a.material=SS.materials.faceMaterial});a.edges.children.map(function(a){a.material=SS.materials.lineMaterial})}});
SS.RevolveAxisPreview=SS.PreviewWithOrigin.extend({initialize:function(){SS.PreviewWithOrigin.prototype.initialize.call(this);this.render()},render:function(){this.clear();SS.PreviewWithOrigin.prototype.render.call(this);var a=(new THREE.Vector3(this.model.node.parameters.u,this.model.node.parameters.v,this.model.node.parameters.w)).normalize(),b=new THREE.Geometry;b.vertices.push(a.clone().multiplyScalar(1E3));b.vertices.push(a.clone().multiplyScalar(-1E3));a=new THREE.Line(b,SS.materials.lineMaterial);
this.sceneObject.add(a);this.postRender()}});SS=SS||{};
SS.BezierCreator=SS.PrimitiveCreator.extend({initialize:function(a){SS.PrimitiveCreator.prototype.initialize.call(this,a);this.views=this.views.concat([new SS.BezierPreview({model:this}),new SS.DraggableVertexCorner({model:this,vertexIndex:0}),new SS.DraggableVertexCorner({model:this,vertexIndex:1}),new SS.DraggableVertexCorner({model:this,vertexIndex:2}),new SS.DraggableVertexCorner({model:this,vertexIndex:3}),new SS.VertexDimensionText({model:this,vertexIndex:0}),new SS.VertexDimensionText({model:this,vertexIndex:1}),
new SS.VertexDimensionText({model:this,vertexIndex:2}),new SS.VertexDimensionText({model:this,vertexIndex:3})])},setDefaultParamters:function(){this.node.parameters.vertices.map(function(a){a.u=10;a.v=0;a.w=0});this.node.parameters.vertices[1].u=20;this.node.parameters.vertices[1].v=10;this.node.parameters.vertices[2].u=0;this.node.parameters.vertices[2].v=10;this.node.parameters.vertices[3].u=10;this.node.parameters.vertices[3].v=20},mouseDownOnCorner:function(a){this.activateCorner(a,SS.VertexHeightCursoid,
{model:this,vertexIndex:a.vertexIndex})},getBoundingBox:function(){var a=this.node.origin,b={},c={};this.node.parameters.vertices.map(function(d){var e={x:"u",y:"v",z:"w"};for(key in e){var f=a[key]+d[e[key]];b[key]=b[key]&&Math.min(f,b[key])||f;c[key]=c[key]&&Math.max(f,c[key])||f}});return{min:new THREE.Vector3(b.x,b.y,b.z),max:new THREE.Vector3(c.x,c.y,c.z)}}});
THREE.CubicBezierCurve3=THREE.Curve.create(function(a,b,c,d){this.v0=a;this.v1=b;this.v2=c;this.v3=d},function(a){var b,c;b=THREE.Shape.Utils.b3(a,this.v0.x,this.v1.x,this.v2.x,this.v3.x);c=THREE.Shape.Utils.b3(a,this.v0.y,this.v1.y,this.v2.y,this.v3.y);a=THREE.Shape.Utils.b3(a,this.v0.z,this.v1.z,this.v2.z,this.v3.z);return new THREE.Vector3(b,c,a)});
SS.BezierPreview=SS.PreviewWithOrigin.extend({initialize:function(){SS.SceneObjectView.prototype.initialize.call(this);this.render()},render:function(){this.clear();SS.PreviewWithOrigin.prototype.render.call(this);var a=this.model.node.parameters.vertices.map(function(a){return new THREE.Vector3(a.u,a.v,a.w)}),b=new THREE.Geometry;b.vertices.push(a[0]);b.vertices.push(a[1]);this.sceneObject.add(new THREE.Line(b,SS.materials.constructionLineMaterial));b=new THREE.Geometry;b.vertices.push(a[2]);b.vertices.push(a[3]);
this.sceneObject.add(new THREE.Line(b,SS.materials.constructionLineMaterial));for(var a=new THREE.CubicBezierCurve3(a[0],a[1],a[2],a[3]),b=new THREE.Geometry,c=0;100>=c;++c)b.vertices.push(a.getPoint(c/100));a=new THREE.Line(b,SS.materials.lineMaterial);this.sceneObject.add(a);this.postRender()},priority:-1});SS=SS||{};
SS.Ellipse1DCreator=SS.PrimitiveCreator.extend({initialize:function(a){SS.PrimitiveCreator.prototype.initialize.call(this,a);this.views=this.views.concat([new SS.EllipsePreview({model:this}),new SS.DraggableUVCorner({model:this,uKey:"r1",vKey:"r2"}),new SS.Ellipse2DDimensionArrows({model:this}),new SS.Ellipse2DDimensionText({model:this}),new SS.DraggableAngleCorner({model:this,key:"from_angle",priority:2}),new SS.DraggableAngleCorner({model:this,key:"to_angle",priority:3})]);this.trigger("change",this)},
setDefaultParamters:function(){this.node.parameters.r1=20;this.node.parameters.r2=10;this.node.parameters.from_angle=0;this.node.parameters.to_angle=360},mouseDownOnUV:function(a){this.activateCorner(a)},getBoundingBox:function(){var a=this.node.origin,b=this.node.parameters.r1,c=this.node.parameters.r2;return{min:new THREE.Vector3(a.x-b,a.y-c,a.z),max:new THREE.Vector3(a.x+b,a.y+c,a.z)}}});
SS.Ellipse1DPreview=SS.EllipsePreview.extend({initialize:function(){SS.EllipsePreview.prototype.initialize.call(this);this.render()},render:function(){this.clear();SS.EllipsePreview.prototype.render.call(this);this.postRender()}});
SS.DraggableAngleCorner=SS.DraggableCorner.extend({initialize:function(a){SS.DraggableCorner.prototype.initialize.call(this,a);this.render();this.priority=a.priority||1},mouseDown:function(){},cornerPositionFromModel:function(){var a=this.model.node.parameters.r1,b=this.model.node.parameters.r2,c=this.model.node.parameters[this.options.key],a=Math.cos(c/180*Math.PI)*a,b=Math.sin(c/180*Math.PI)*b;return{x:this.model.node.origin.x+a,y:this.model.node.origin.y+b,z:this.model.node.origin.z}},updateModelFromCorner:function(a){a=
Math.atan2(a.y-this.model.node.origin.y,(a.x-this.model.node.origin.x)*this.model.node.parameters.r2/this.model.node.parameters.r1);this.model.node.parameters[this.options.key]=Math.round(180*(a/Math.PI))}});SS=SS||{};
SS.PolylineCreator=SS.PrimitiveCreator.extend({initialize:function(a){SS.PrimitiveCreator.prototype.initialize.call(this,a);this.views=this.views.concat([new SS.PolylinePreview({model:this}),new SS.AddRemovePointChoice({model:this})]);for(a=0;a<this.node.parameters.vertices.length;++a)this.views.push(new SS.DraggableVertexCorner({model:this,vertexIndex:a})),this.views.push(new SS.VertexDimensionText({model:this,vertexIndex:a}))},setDefaultParamters:function(){this.node.parameters.vertices[0]={u:10,
v:0,w:0};this.node.parameters.vertices[1]={u:0,v:10,w:0}},addPoint:function(){var a=this.node.parameters.vertices,b=a.length,c=a[b-1];a.push({u:c.u+10,v:c.v+10,w:c.w});this.setParameters({});this.nodeDOMView.render();this.views.push(new SS.DraggableVertexCorner({model:this,vertexIndex:b}));this.views.push(new SS.VertexDimensionText({model:this,vertexIndex:b}))},removePoint:function(){this.activeCornerView&&this.activeCornerView.remove();this.views.pop().remove();this.views.pop().remove();this.node.parameters.vertices.pop();
this.setParameters({});this.nodeDOMView.render()},mouseDownOnCorner:function(a){this.activateCorner(a,SS.VertexHeightCursoid,{model:this,vertexIndex:a.vertexIndex})},getBoundingBox:function(){var a=this.node.origin,b={},c={};this.node.parameters.vertices.map(function(d){var e={x:"u",y:"v",z:"w"};for(key in e){var f=a[key]+d[e[key]];b[key]=b[key]&&Math.min(f,b[key])||f;c[key]=c[key]&&Math.max(f,c[key])||f}});return{min:new THREE.Vector3(b.x,b.y,b.z),max:new THREE.Vector3(c.x,c.y,c.z)}}});
SS.PolylinePreview=SS.PreviewWithOrigin.extend({initialize:function(){SS.SceneObjectView.prototype.initialize.call(this);this.render()},render:function(){this.clear();SS.PreviewWithOrigin.prototype.render.call(this);var a=new THREE.Geometry,b=this.model.node.origin,c=this.model.node.parameters.vertices;a.vertices=c.map(function(a){return new THREE.Vector3(a.u,a.v,a.w)});a=new THREE.Line(a,SS.materials.lineMaterial);this.sceneObject.add(a);var d=this;c.map(function(a){var b=new THREE.CubeGeometry(0.2,
0.2,0.2),c=[new THREE.MeshBasicMaterial({color:13421772,opacity:0.5,wireframe:!1}),new THREE.MeshBasicMaterial({color:10066329,wireframe:!0})],b=THREE.SceneUtils.createMultiMaterialObject(b,c);b.position=new THREE.Vector3(a.u,a.v,a.w);d.sceneObject.add(b)});b.z&&(c=new THREE.Geometry,a=triangleVertices.concat([triangleVertices[0]]),c.vertices=a.map(function(a){return new THREE.Vector3(a.u,a.v,0)}),c=new THREE.Line(c,SS.materials.lineMaterial),c.position.z=-b.z,this.sceneObject.add(c));this.postRender()},
priority:-1});
SS.AddRemovePointChoice=Backbone.View.extend({initialize:function(){this.render();this.model.on("change",this.render,this)},remove:function(){Backbone.View.prototype.remove.call(this);this.model.off("change",this.update)},render:function(){var a='<table><tr><td><input class="add-point" type="submit" value="+"/>';this.model.node.parameters.vertices.length>SS.schemas.polyline.properties.parameters.properties.vertices.minItems&&(a+='<input class="remove-point" type="submit" value="-"/>');this.$el.html(a+
"</td></tr></table>");$("#floating-dom-view").prepend(this.$el)},events:{"click .add-point":"addPoint","click .remove-point":"removePoint"},addPoint:function(){this.model.addPoint()},removePoint:function(){this.model.removePoint()}});SS=SS||{};
SS.FilletCreator=SS.ParentCreator.extend({initialize:function(a){a.noOriginCorner=!0;SS.ParentCreator.prototype.initialize.call(this,a);this.originalNode?this.boundingBox=SS.boundingBoxForGeomNode(this.editingNode):(this.node.parameters.r=1,this.views.push(new SS.FilletGeomNodeView({model:this})),this.trigger("change:model",this));this.views=this.views.concat([new SS.FilletRadiusDOMView({model:this})]);this.trigger("change",this)},mouseDownOnUV:function(){},getBoundingBox:function(){if(this.boundingBox)return{min:this.boundingBox.min.clone(),max:this.boundingBox.max.clone()}}});
SS.FilletGeomNodeView=SS.SceneObjectView.extend({initialize:function(){SS.SceneObjectView.prototype.initialize.call(this);this.model.on("change:model",this.render,this);this.meshes=SS.createGeometry(this.model.childNode);this.changeToPreviewColor(this.meshes);this.dontApplyWorkplane=!0;this.render()},remove:function(){SS.SceneObjectView.prototype.remove.call(this);this.model.off("change:model",this.render)},render:function(){this.clear();this.sceneObject.add(this.meshes.faces);this.sceneObject.add(this.meshes.edges);
this.model.boundingBox=SS.boundingBoxForSceneObject(this.sceneObject);this.model.center=SS.centerOfGeom(this.model.boundingBox);this.postRender()},changeToPreviewColor:function(a){a.faces.children.map(function(a){a.material=SS.materials.faceMaterial});a.edges.children.map(function(a){a.material=SS.materials.lineMaterial})}});
SS.FilletRadiusDOMView=Backbone.View.extend({initialize:function(){this.render();this.model.on("change",this.update,this)},remove:function(){Backbone.View.prototype.remove.call(this);this.model.off("change",this.update)},render:function(){this.$el.html($.mustache('<input type="number" class="field" id="floating-r" value="{{value}}"/>',{value:this.model.node.parameters.text}));$("#floating-dom-view .params").append(this.$el)},events:{"change .field":"fieldChanged","keyup .field":"fieldChanged","click .field":"fieldChanged"},
update:function(){$("#floating-r").val(this.model.node.parameters.r)},fieldChanged:function(){this.preventUpdate=!0;this.model.setParameters({r:parseFloat($("#floating-r").val())});this.preventUpdate=!1}});SS=SS||{};
SS.TranslateTransformerInitiator=SS.TransformerInitiator.extend({initialize:function(a){SS.TransformerInitiator.prototype.initialize.call(this,a);this.geomNode=a.geomNode;this.translateView=new SS.TranslateTransformerView({model:this});this.views.push(this.translateView)},mouseDownOnTranslate:function(){var a=this.geomNode,b=a.editableCopy(),c=new Transform({type:"translate",editing:!0,origin:{x:Math.round(this.normalizedCenter.x),y:Math.round(this.normalizedCenter.y),z:0},parameters:{u:0,v:0,w:0,
n:0}});b.transforms.push(c);a.originalSceneObjects=a.sceneObjects;SS.selectionManager.deselectID(a.id);geom_doc.replace(a,b);new SS.TranslateTransformer({originalNode:a,editingNode:b,transform:c})}});
SS.TranslateTransformer=SS.Transformer.extend({initialize:function(a){SS.Transformer.prototype.initialize.call(this,a);a.editingExisting||(this.translateView=new SS.TranslateTransformerView({model:this}),SS.sceneView.addToMouseOverAndMouseDown(this.translateView),this.views=this.views.concat([this.translateView,new SS.TranslateHeightCursoid({model:this}),new SS.TranslateGeomNodeView({model:this}),new SS.TranslateDimensionArrows({model:this}),new SS.TranslateDimensionText({model:this})]))}});
SS.TranslateTransformerView=SS.InteractiveSceneView.extend({initialize:function(){SS.InteractiveSceneView.prototype.initialize.call(this);this.on("mouseDown",this.mouseDown,this);this.on("mouseDrag",this.drag);this.model.on("change",this.render,this);this.render()},remove:function(){SS.InteractiveSceneView.prototype.remove.call(this);this.model.off("mouseDown",this.mouseDown);this.off("mouseDrag",this.drag);this.model.off("change",this.render,this)},mouseDown:function(){this.model.mouseDownOnTranslate&&
this.model.mouseDownOnTranslate(this)},render:function(){this.clear();var a=1*this.cameraScale,a=new THREE.CubeGeometry(a,a,a),b=[new THREE.MeshBasicMaterial({color:SS.materials.faceColor,opacity:0.5,wireframe:!1}),new THREE.MeshBasicMaterial({color:SS.materials.lineColor,wireframe:!0})],a=THREE.SceneUtils.createMultiMaterialObject(a,b);a.position.x=this.model.normalizedCenter.x;a.position.y=this.model.normalizedCenter.y;a.position.z=0;this.sceneObject.add(a);this.postRender();return this},drag:function(){var a=
SS.sceneView.determinePositionOnWorkplane(event),b=a.y-this.model.node.origin.y,a={u:parseFloat((a.x-this.model.node.origin.x).toFixed(3)),v:parseFloat(b.toFixed(3))};event.ctrlKey||(a.u=Math.round(10*a.u)/10,a.v=Math.round(10*a.v)/10);this.model.setParameters(a)}});
SS.TranslateGeomNodeView=Backbone.View.extend({initialize:function(){Backbone.View.prototype.initialize.call(this);this.render();this.model.on("beforeChange",this.render,this)},remove:function(){Backbone.View.prototype.remove.call(this);this.model.off("beforeChange",this.render,this)},render:function(){if(this.model.originalNode.originalSceneObjects){var a=SS.objToVector(this.model.node.parameters);SS.translateGeomNodeRendering(this.model.originalNode,this.model.editingNode,a)}}});
SS.TranslateHeightCursoid=SS.HeightCursoid.extend({initialize:function(){SS.HeightCursoid.prototype.initialize.call(this);this.render()},cornerPositionFromModel:function(){return{x:this.model.normalizedCenter.x,y:this.model.normalizedCenter.y,z:this.model.node.parameters.w}},updateModelFromCorner:function(a){this.model.node.parameters.w=a.z-this.model.node.origin.z}});
SS.TranslateDimensionArrows=SS.DimensionArrowsView.extend({render:function(){this.clear();var a=this.model.node.origin,b=this.model.node.parameters.u,c=this.model.node.parameters.v,d=this.model.node.parameters.w;if(b){var e=this.createDimArrow(b,new THREE.Vector3(b,0,0));this.sceneObject.add(e)}c&&(e=this.createDimArrow(c,new THREE.Vector3(0,c,0)),e.position=new THREE.Vector3(b,0,0),this.sceneObject.add(e));d&&(d=this.createDimArrow(c,new THREE.Vector3(0,0,d)),d.position=new THREE.Vector3(b,c,0),
this.sceneObject.add(d));this.sceneObject.position=new THREE.Vector3(a.x,a.y,a.z);this.postRender()}});
SS.TranslateDimensionText=SS.DimensionText.extend({render:function(){this.clear();var a=this.model.node.parameters.u,b=this.model.node.parameters.v,c=this.model.node.parameters.w;a&&(this.$u=this.addElement('<div class="dimension">'+a+"</div>"));b&&(this.$v=this.addElement('<div class="dimension">'+b+"</div>"));c&&(this.$w=this.addElement('<div class="dimension">'+c+"</div>"));this.update()},update:function(){var a=this.model.node.origin,b=this.model.node.parameters.u,c=this.model.node.parameters.v,
d=this.model.node.parameters.w,a={u:new THREE.Vector3(a.x+b/2,a.y,a.z),v:new THREE.Vector3(a.x+b,a.y+c/2,a.z),w:new THREE.Vector3(a.x+b,a.y+c,a.z+d/2)};for(key in a)this["$"+key]&&this.moveToScreenCoordinates(this["$"+key],a[key])}});SS=SS||{};
SS.ScaleTransformerInitiator=SS.TransformerInitiator.extend({initialize:function(a){SS.TransformerInitiator.prototype.initialize.call(this,a);this.arrowViews=[new SS.ScaleArrowViewMaxXMaxY({model:this}),new SS.ScaleArrowViewMaxXMinY({model:this}),new SS.ScaleArrowViewMinXMinY({model:this}),new SS.ScaleArrowViewMinXMaxY({model:this})];this.views=this.views.concat(this.arrowViews);this.views=this.views.concat([new SS.ScaleBoxView({model:this}),new SS.ScaleFootprintView({model:this})])},mouseDownOnArrow:function(a){var b=this.originalNode,
c=b.editableCopy(),d=new Transform({type:"scale",editing:!0,origin:{x:Math.round(this.normalizedCenter.x),y:Math.round(this.normalizedCenter.y),z:0},parameters:{factor:1}});c.transforms.push(d);b.originalSceneObjects=b.sceneObjects;SS.selectionManager.deselectID(b.id);geom_doc.replace(b,c);new SS.ScaleTransformer({originalNode:b,editingNode:c,transform:d,anchorFunction:a.anchorFunction,mouseDownArrowViewIndex:this.arrowViews.indexOf(a)})}});
SS.ScaleTransformer=SS.Transformer.extend({initialize:function(a){SS.Transformer.prototype.initialize.call(this,a);if(!a.editingExisting){this.anchorPosition=a.anchorFunction(this.normalizedBoundingBox);var b=[new SS.ScaleArrowViewMaxXMaxY({model:this}),new SS.ScaleArrowViewMaxXMinY({model:this}),new SS.ScaleArrowViewMinXMinY({model:this}),new SS.ScaleArrowViewMinXMaxY({model:this})];SS.sceneView.addToMouseOverAndMouseDown(b[a.mouseDownArrowViewIndex]);a=[new SS.ScaleGeomNodeView({model:this}),new SS.ScaleFactorText({model:this}),
new SS.ScaleBoxView({model:this}),new SS.ScaleFootprintView({model:this})];this.views=this.views.concat(a);this.views=this.views.concat(b)}},mouseDown:function(a){this.anchorPosition=a.anchorFunction(this.boundingBox)}});SS.ScaleGeomNodeView=Backbone.View.extend({initialize:function(){this.render();this.model.on("beforeChange",this.render,this)},render:function(){var a=SS.objToVector(this.model.node.origin);SS.scaleGeomNodeRendering(this.model.originalNode,this.model.editingNode,a,this.model.node.parameters.factor)}});
SS.ScaleArrowView=SS.InteractiveSceneView.extend({initialize:function(){SS.InteractiveSceneView.prototype.initialize.call(this);this.on("mouseDown",this.mouseDown,this);this.on("mouseDrag",this.drag)},remove:function(){SS.InteractiveSceneView.prototype.remove.call(this);this.off("mouseDown",this.mouseDown);this.off("mouseDrag",this.drag)},mouseDown:function(){this.model.mouseDownOnArrow&&this.model.mouseDownOnArrow(this)},render:function(){this.clear();var a=new THREE.Geometry,b=[[0,0,0],[1,-0.75,
0],[1,-0.25,0],[1.5,-0.25,0],[1.5,-0.75,0],[2.5,0,0],[1.5,0.75,0],[1.5,0.25,0],[1,0.25,0],[1,0.75,0],[0,0,0]],c=this,b=b.map(function(a){return[a[0]*c.cameraScale,a[1]*c.cameraScale,a[2]*c.cameraScale]});a.vertices=b.map(function(a){return new THREE.Vector3(a[0],a[1],a[2])});a.faces.push(new THREE.Face4(2,3,7,8));a.faces.push(new THREE.Face3(0,1,9));a.faces.push(new THREE.Face3(4,5,6));a.computeCentroids();a.computeFaceNormals();b=new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:SS.materials.faceColor,
transparent:!0,opacity:0.5}));b.doubleSided=!0;var d=new THREE.Geometry;d.vertices=a.vertices;a=new THREE.Line(d,new THREE.LineBasicMaterial({color:SS.materials.lineColor,wireframe:!0,linewidth:2,transparent:!0,opacity:0.5}));this.arrowObject=new THREE.Object3D;this.arrowObject.add(b);this.arrowObject.add(a);this.sceneObject.add(this.arrowObject);return this},drag:function(a){var b=this.model.anchorPosition.x-this.model.node.origin.x,c=this.model.anchorPosition.y-this.model.node.origin.y,b=Math.sqrt(b*
b+c*c),d=SS.sceneView.determinePositionOnWorkplane(a),c=d.x-this.model.node.origin.x,d=d.y-this.model.node.origin.y,c=Math.sqrt(c*c+d*d),b=parseFloat((c/b).toFixed(3));a.ctrlKey||(b=Math.round(10*b)/10);this.model.setParameters({factor:b})}});
SS.ScaleArrowViewMaxXMaxY=SS.ScaleArrowView.extend({initialize:function(){SS.ScaleArrowView.prototype.initialize.call(this);this.render()},anchorFunction:function(a){return{x:a.max.x,y:a.max.y}},render:function(){SS.ScaleArrowView.prototype.render.call(this);this.arrowObject.position.x=this.model.normalizedBoundingBox.max.x+1;this.arrowObject.position.y=this.model.normalizedBoundingBox.max.y+1;this.arrowObject.rotation.z=0.25*Math.PI;this.postRender();return this}});
SS.ScaleArrowViewMinXMaxY=SS.ScaleArrowView.extend({initialize:function(){SS.ScaleArrowView.prototype.initialize.call(this);this.render()},anchorFunction:function(a){return{x:a.min.x,y:a.max.y}},render:function(){SS.ScaleArrowView.prototype.render.call(this);this.arrowObject.position.x=this.model.normalizedBoundingBox.min.x-1;this.arrowObject.position.y=this.model.normalizedBoundingBox.max.y+1;this.arrowObject.rotation.z=0.75*Math.PI;this.postRender();return this}});
SS.ScaleArrowViewMinXMinY=SS.ScaleArrowView.extend({initialize:function(){SS.ScaleArrowView.prototype.initialize.call(this);this.render()},anchorFunction:function(a){return{x:a.min.x,y:a.min.y}},render:function(){SS.ScaleArrowView.prototype.render.call(this);this.arrowObject.position.x=this.model.normalizedBoundingBox.min.x-1;this.arrowObject.position.y=this.model.normalizedBoundingBox.min.y-1;this.arrowObject.rotation.z=1.25*Math.PI;this.postRender();return this}});
SS.ScaleArrowViewMaxXMinY=SS.ScaleArrowView.extend({initialize:function(){SS.ScaleArrowView.prototype.initialize.call(this);this.render()},anchorFunction:function(a){return{x:a.max.x,y:a.min.y}},render:function(){SS.ScaleArrowView.prototype.render.call(this);this.arrowObject.position.x=this.model.normalizedBoundingBox.max.x+1;this.arrowObject.position.y=this.model.normalizedBoundingBox.min.y-1;this.arrowObject.rotation.z=1.75*Math.PI;this.postRender();return this}});
SS.ScaleBoxView=SS.SceneObjectView.extend({initialize:function(){SS.SceneObjectView.prototype.initialize.call(this);this.render()},render:function(){this.clear();var a=this.model.normalizedBoundingBox.max.x-this.model.normalizedBoundingBox.min.x,b=this.model.normalizedBoundingBox.max.y-this.model.normalizedBoundingBox.min.y,c=this.model.normalizedBoundingBox.max.z-this.model.normalizedBoundingBox.min.z,d=new THREE.CubeGeometry(a,b,c);cube=new THREE.Mesh(d,new THREE.MeshBasicMaterial({color:SS.materials.lineColor,
wireframe:!0}));cube.position.x=this.model.normalizedBoundingBox.min.x+a/2;cube.position.y=this.model.normalizedBoundingBox.min.y+b/2;cube.position.z=this.model.normalizedBoundingBox.min.z+c/2;this.sceneObject.add(cube);this.postRender();return this}});
SS.ScaleFootprintView=SS.SceneObjectView.extend({initialize:function(){SS.SceneObjectView.prototype.initialize.call(this);this.render()},render:function(){this.clear();var a=this.model.normalizedBoundingBox.max.x-this.model.normalizedBoundingBox.min.x,b=this.model.normalizedBoundingBox.max.y-this.model.normalizedBoundingBox.min.y,c=new THREE.PlaneGeometry(a,b),d=new THREE.Mesh(c,new THREE.MeshBasicMaterial({color:SS.materials.faceColor,transparent:!0,opacity:0.2})),c=new THREE.Mesh(c,new THREE.MeshBasicMaterial({color:SS.materials.lineColor,
wireframe:!0}));d.doubleSided=!0;d.position.x=this.model.normalizedBoundingBox.min.x+a/2;d.position.y=this.model.normalizedBoundingBox.min.y+b/2;d.position.z=-0.05;d.rotation.x=Math.PI/2;c.position=d.position;c.rotation.x=Math.PI/2;this.sceneObject.add(d);this.sceneObject.add(c);this.postRender();return this}});
SS.ScaleFactorText=SS.DimensionText.extend({render:function(){this.clear();this.$factor=this.addElement('<div class="dimension">'+this.model.node.parameters.factor+"</div>");this.update()},update:function(){var a=SS.boundingBoxForGeomNode(this.model.editingNode),b=SS.centerOfGeom(a);this.moveToScreenCoordinates(this.$factor,new THREE.Vector3(a.max.x,b.y,0))}});SS=SS||{};
SS.RotateTransformerInitiator=SS.TransformerInitiator.extend({initialize:function(a){SS.TransformerInitiator.prototype.initialize.call(this,a);this.node={origin:this.normalizedCenter,axis:{x:0,y:0,z:1},angle:0};this.views=this.views.concat([new SS.WorkplaneURotationPreview({model:this,radius:this.normalizedBoundingRadius+10,index:0}),new SS.WorkplaneVRotationPreview({model:this,radius:this.normalizedBoundingRadius+10,index:1}),new SS.WorkplaneWRotationPreview({model:this,radius:this.normalizedBoundingRadius+10,
index:2})])},mouseDownOnArrow:function(a,b){var c=this.originalNode,d=c.editableCopy(),e={u:a.x,v:a.y,w:a.z,angle:0,n:0},e=new Transform({type:"rotate",editing:!0,origin:{x:Math.round(this.normalizedCenter.x),y:Math.round(this.normalizedCenter.y),z:Math.round(this.normalizedCenter.z)},parameters:e});d.transforms.push(e);c.originalSceneObjects=c.sceneObjects;SS.selectionManager.deselectID(c.id);geom_doc.replace(c,d);new SS.RotateTransformer({originalNode:c,editingNode:d,transform:e,mouseDownArrowViewIndex:b});
this.destroy()}});
SS.RotateTransformer=SS.Transformer.extend({initialize:function(a){SS.Transformer.prototype.initialize.call(this,a);if(!a.editingExisting){this.anchorPosition=a.anchorPosition;var b=[new SS.WorkplaneURotationPreview({model:this,radius:this.normalizedBoundingRadius+10}),new SS.WorkplaneVRotationPreview({model:this,radius:this.normalizedBoundingRadius+10}),new SS.WorkplaneWRotationPreview({model:this,radius:this.normalizedBoundingRadius+10})];SS.sceneView.addToMouseOverAndMouseDown(b[a.mouseDownArrowViewIndex]);b[a.mouseDownArrowViewIndex].mouseDown();
a=[new SS.RotateGeomNodeView({model:this})];this.views=this.views.concat(a);this.views=this.views.concat(b)}}});SS.RotateGeomNodeView=Backbone.View.extend({initialize:function(){this.render();this.model.on("beforeChange",this.render,this)},render:function(){SS.rotateGeomNodeRendering(this.model.originalNode,this.model.editingNode,this.model.node)}});SS=SS||{};SS.AxisMirrorTransformCreator=SS.TransformCreator.extend({initialize:function(a){SS.TransformCreator.prototype.initialize.call(this,a);this.node.parameters={u:0,v:0,w:1,n:0};this.views=this.views.concat([new SS.AxisMirrorTransformPreview({model:this}),new SS.XYZAxisChoice({model:this})]);this.trigger("change",this)},getBoundingBox:function(){return this.attributes.editingExisting?void 0:SS.boundingBoxForGeomNode(this.editingNode)}});
SS.AxisMirrorTransformPreview=SS.PreviewWithOrigin.extend({initialize:function(){SS.PreviewWithOrigin.prototype.initialize.call(this);this.render()},render:function(){this.model.originalNode.originalSceneObjects&&(SS.objToVector(this.model.node.parameters),SS.axisMirrorGeomNodeRendering(this.model.originalNode,this.model.editingNode,this.model.node));this.clear();SS.PreviewWithOrigin.prototype.render.call(this);var a=SS.objToVector(this.model.node.parameters).normalize(),b=new THREE.Geometry;b.vertices.push(a.clone().multiplyScalar(1E3));
b.vertices.push(a.clone().multiplyScalar(-1E3));a=new THREE.Line(b,SS.materials.lineMaterial);this.sceneObject.add(a);this.postRender()}});
SS.XYZAxisChoice=Backbone.View.extend({initialize:function(){this.render()},remove:function(){Backbone.View.prototype.remove.call(this)},render:function(){this.$el.html('<table><tr><td><input class="X-axis" type="submit" value="X"/><input class="Y-axis" type="submit" value="Y"/><input class="Z-axis" type="submit" value="Z"/></td></tr></table>');$("#floating-dom-view").prepend(this.$el)},events:{"click .X-axis":"xaxis","click .Y-axis":"yaxis","click .Z-axis":"zaxis"},xaxis:function(){this.model.setParameters({u:1,
v:0,w:0})},yaxis:function(){this.model.setParameters({u:0,v:1,w:0})},zaxis:function(){this.model.setParameters({u:0,v:0,w:1})}});SS=SS||{};SS.PlaneMirrorTransformCreator=SS.TransformCreator.extend({initialize:function(a){SS.TransformCreator.prototype.initialize.call(this,a);this.node.parameters={u:0,v:0,w:1,n:0};this.views=this.views.concat([new SS.PlaneMirrorTransformPreview({model:this}),new SS.PlaneChoice({model:this})]);this.trigger("change",this)},getBoundingBox:function(){return this.attributes.editingExisting?void 0:SS.boundingBoxForGeomNode(this.editingNode)}});
SS.PlaneMirrorTransformPreview=SS.PreviewWithOrigin.extend({initialize:function(){SS.PreviewWithOrigin.prototype.initialize.call(this);this.render()},render:function(){this.model.originalNode.originalSceneObjects&&(SS.objToVector(this.model.node.parameters),SS.planeMirrorGeomNodeRendering(this.model.originalNode,this.model.editingNode,this.model.node));this.clear();SS.PreviewWithOrigin.prototype.render.call(this);var a=SS.objToVector(this.model.node.parameters).normalize(),b=new THREE.PlaneGeometry2(120,
120),b=new THREE.Mesh(b,SS.materials.faceMaterial);b.lookAt(a);b.doubleSided=!0;this.sceneObject.add(b);this.postRender()}});
SS.PlaneChoice=Backbone.View.extend({initialize:function(){this.render()},remove:function(){Backbone.View.prototype.remove.call(this)},render:function(){this.$el.html('<table><tr><td><input class="XY" type="submit" value="XY"/><input class="YZ" type="submit" value="YZ"/><input class="ZX" type="submit" value="ZX"/></td></tr></table>');$("#floating-dom-view").prepend(this.$el)},events:{"click .XY":"xy","click .YZ":"yz","click .ZX":"zx"},xy:function(){this.model.setParameters({u:0,v:0,w:1})},yz:function(){this.model.setParameters({u:1,
v:0,w:0})},zx:function(){this.model.setParameters({u:0,v:1,w:0})}});SS=SS||{};
SS.TransformerManager=function(){var a={DEACTIVATED:0,SCALE:1,ROTATE:2},b=a.DEACTIVATED,c=[];this.selected=function(){if(1===SS.selectionManager.size()&&(node=geom_doc.findById(SS.selectionManager.getSelected()[0]),!node.isEditingOrTransformEditing()&&!SS.geomNodeRenderingManager.isHiddenByUser(node))){var d=node;b===a.SCALE?(c.map(function(a){a.destroy()}),c=[],c.push(new SS.TranslateTransformerInitiator({geomNode:d})),c.push(new SS.RotateTransformerInitiator({geomNode:d})),b=a.ROTATE):(c.map(function(a){a.destroy()}),
c=[],c.push(new SS.TranslateTransformerInitiator({geomNode:d})),c.push(new SS.ScaleTransformerInitiator({geomNode:d})),b=a.SCALE)}};this.deselected=function(){b=a.UNDEFINED};this.clear=function(){c.map(function(a){a.destroy()});b=a.UNDEFINED};SS.selectionManager.on("selected",this.selected,this);SS.selectionManager.on("deselected",this.deselected,this);SS.commandStack.on("beforePop",this.clear,this)};SS=SS||{};SS.objToVector=function(a){return a.hasOwnProperty("x")?new THREE.Vector3(a.x,a.y,a.z):new THREE.Vector3(a.u,a.v,a.w)};SS.rotateAroundAxis=function(a,b,c){return 0!==c?(new THREE.Quaternion).setFromAxisAngle(b,c/180*Math.PI).multiplyVector3(a,new THREE.Vector3):a.clone()};SS.worldPositionFromWorkplanePosition=function(a,b){return(new THREE.Vector3).add(SS.rotateAroundAxis(a,SS.objToVector(b.axis),b.angle),SS.objToVector(b.origin))};
SS.toScreenCoordinates=function(a){var b=new THREE.Matrix4;b.multiply(SS.sceneView.camera.projectionMatrix,SS.sceneView.camera.matrixWorldInverse);b.multiplyVector3(a);return{x:window.innerWidth*((a.x+1)/2),y:window.innerHeight*((-a.y+1)/2)}};
SS.boundingBoxToScreenPosition=function(a){(new THREE.Matrix4).multiply(SS.sceneView.camera.projectionMatrix,SS.sceneView.camera.matrixWorldInverse);for(var b=[a.min.x,a.max.x],c=[a.min.y,a.max.y],d=[a.min.z,a.max.z],e=a=void 0,f=void 0,g=0;2>g;g++)for(var h=0;2>h;++h)for(var j=0;2>j;++j)var l=new THREE.Vector3(b[g],c[h],d[j]),l=SS.toScreenCoordinates(l),a=a?Math.max(l.x,a):l.x,e=e?Math.min(l.y,e):l.y,f=f?Math.max(l.y,f):l.y;b=(f+e)/2;c=Math.max(a,100);b=Math.max(b,100);c=Math.min(c,window.innerWidth-
100-50);b=Math.min(b,window.innerHeight-100-50);return{x:c,y:b}};SS.copyObj=function(a){if(!(null===a||void 0===a)){if("[object Array]"===Object.prototype.toString.call(a))return a.map(function(a){return SS.copyObj(a)});if("object"===typeof a){var b={},c;for(c in a)a.hasOwnProperty(c)&&(b[c]=SS.copyObj(a[c]));return b}return a}};SS=SS||{};
SS.toCSG=function(a){if(!a.mesh)throw"no mesh for geom node "+a.id+":"+a.sha;var b=a.mesh,c,d,e,f,g,h=[];for(c=0;c<b.faces.indices.length/3;++c)a=[0,1,2].map(function(a){f=b.faces.indices[3*c+a];g=3*f;a=CSG.Vector||CSG.Vector3D;d=new a(b.faces.positions[g],b.faces.positions[g+1],b.faces.positions[g+2]);e=new a(b.faces.normals[g],b.faces.normals[g+1],b.faces.normals[g+2]);return new CSG.Vertex(d,e)}),!a[0].pos.equals(a[1].pos)&&(!a[1].pos.equals(a[2].pos)&&!a[0].pos.equals(a[2].pos))&&h.push(new CSG.Polygon(a));return new CSG.fromPolygons(h)};
SS.CSGtoMesh=function(a){var b=[],c=[],d=[],a=a.toPolygons(),e;e=0;a.forEach(function(a){a=a.vertices;if(!(3>a.length)){var g=a[0].pos.minus(a[1].pos),g=a[2].pos.minus(a[1].pos).cross(g).unit();index0=e;pos0=a[0].pos;c.push(pos0.x);c.push(pos0.y);c.push(pos0.z);d.push(g.x);d.push(g.y);d.push(g.z);++e;for(var h=2;h<a.length;++h)b.push(index0),pos1=a[h-1].pos,c.push(pos1.x),c.push(pos1.y),c.push(pos1.z),d.push(g.x),d.push(g.y),d.push(g.z),b.push(e),++e,pos2=a[h].pos,c.push(pos2.x),c.push(pos2.y),c.push(pos2.z),
d.push(g.x),d.push(g.y),d.push(g.z),b.push(e),++e}});return{faces:{indices:b,normals:d,positions:c},edges:{segments:[]}}};SS=SS||{};
SS.SelectionManager=function(){_.extend(this,Backbone.Events);var a=[];this.getSelected=function(){return a.map(function(a){return a})};this.size=function(){return a.length};this.shiftPick=function(b){var c=!1,d;for(d in a)a[d]==b&&(c=!0);c?this.deselectID(b):this.selectID(b)};this.pick=function(a){this.selectOnly(a)};this.selectID=function(b){a.push(b);this.trigger("selected",[b])};this.deselectID=function(b){-1!==a.indexOf(b)&&(a.splice(a.indexOf(b),1),this.trigger("deselected",[b]))};this.selectOnly=
function(b){var c=[],d;for(d in a)a[d]!=b&&c.push(a[d]);a=[b];0<c.length&&this.trigger("deselected",c);this.trigger("selected",[b])};this.deselectAll=function(){if(0<a.length){var b=a;a=[];this.trigger("deselected",b)}}};function Action(a,b,c){this.label=a;this.iconPath=b;this.fn=c;this.render=function(b){var e=$('<img class="action" src="'+this.iconPath+'" title="'+a+'"/>');b.append(e);e.click(function(a){var b=SS.selectionManager.getSelected();SS.sceneView.popupMenu.disposeIfShowing();c(b);a.stopPropagation()})}}function delete_geom(a){0==a.length?alert("please select at least one object"):(a=a.map(function(a){return geom_doc.findById(a)}),delete_geom_nodes(a))}
function delete_geom_nodes(a){var b=new Command(function(){for(var b in a)geom_doc.remove(a[b]);SS.commandStack.commit()},function(){for(var b in a)geom_doc.add(a[b]);SS.commandStack.success()},function(){for(var b in a)geom_doc.remove(a[b]);SS.commandStack.success()});SS.commandStack.execute(b)}SS.creators={};SS.creators.sphere=SS.SphereCreator;SS.creators.cuboid=SS.CuboidCreator;SS.creators.cylinder=SS.CylinderCreator;SS.creators.cone=SS.ConeCreator;SS.creators.wedge=SS.WedgeCreator;
SS.creators.torus=SS.TorusCreator;SS.creators.ellipse2d=SS.Ellipse2DCreator;SS.creators.rectangle2d=SS.Rectangle2DCreator;SS.creators.triangle2d=SS.Triangle2DCreator;SS.creators.text2d=SS.Text2DCreator;SS.creators.prism=SS.PrismCreator;SS.creators.fillet=SS.FilletCreator;SS.creators.revolve=SS.RevolveCreator;SS.creators.bezier=SS.BezierCreator;SS.creators.ellipse1d=SS.Ellipse1DCreator;SS.creators.polyline=SS.PolylineCreator;SS.creators.translate=SS.TranslateTransformer;SS.creators.scale=SS.ScaleTransformer;
SS.creators.rotate=SS.RotateTransformer;SS.creators.mirror=SS.AxisMirrorTransformCreator;SS.creators.axis_mirror=SS.AxisMirrorTransformCreator;SS.creators.plane_mirror=SS.PlaneMirrorTransformCreator;
function create_primitive(a){var b={},c=SS.schemas[a],d=function(a,b,c){if("array"!==c.type)b[a]=null;else{b[a]=[];for(var e=0;e<c.minItems;++e){var l={};for(subKey in c.items.properties)d(subKey,l,c.items.properties[subKey]);b[a].push(l)}}},e;for(e in c.properties.parameters.properties)d(e,b,c.properties.parameters.properties[e]);b=new GeomNode({type:a,editing:!0,origin:{x:SS.sceneView.lastClickedPositionOnWorkplane.x||0,y:SS.sceneView.lastClickedPositionOnWorkplane.y||0,z:0},workplane:SS.workplaneModel.node.editableCopy(),
parameters:b});geom_doc.add(b);new SS.creators[a]({editingNode:b})}function create_modifier(a,b){if(1!=a.length)alert("Only a single object is supported!");else{var c=geom_doc.findById(a[0]),d=SS.schemas[b],e={},f;for(f in d.properties.parameters.properties)e[f]=null;d=new GeomNode({type:b,editing:!0,origin:d.properties.origin?{x:0,y:0,z:0}:null,parameters:e,workplane:SS.workplaneModel.node.editableCopy()},[c]);geom_doc.replace(c,d);return{childNode:c,editingNode:d}}}
function create_transform(a,b){if(1!=a.length)alert("no object selected!");else{var c=SS.schemas[b],d={},e;for(e in c.properties.parameters.properties)d[e]=null;c=geom_doc.findById(a[0]);e=c.editableCopy();d=new Transform({type:b,editing:!0,origin:{x:0,y:0,z:0},parameters:d});e.transforms.push(d);c.originalSceneObjects=c.sceneObjects;geom_doc.replace(c,e);return{originalNode:c,editingNode:e,transform:d}}}
$(document).ready(function(){var a=new Action("Delete","/static/images/trash.png",function(a){delete_geom(a)});a.render($("#edit"));a.render($("#boolean"));(new Action("Copy","/static/images/copy.png",function(a){copy(a)})).render($("#edit"));(new Action("Cuboid","/static/images/cuboid.png",function(){create_primitive("cuboid")})).render($("#3Dprimitives"));(new Action("Sphere","/static/images/sphere.png",function(){create_primitive("sphere")})).render($("#3Dprimitives"));(new Action("Cylinder","/static/images/cylinder.png",
function(){create_primitive("cylinder")})).render($("#3Dprimitives"));(new Action("Cone","/static/images/cone.png",function(){create_primitive("cone")})).render($("#3Dprimitives"));(new Action("Wedge","/static/images/wedge.png",function(){create_primitive("wedge")})).render($("#3Dprimitives"));(new Action("Torus","/static/images/torus.png",function(){create_primitive("torus")})).render($("#3Dprimitives"));(new Action("Ellipse 2D","/static/images/ellipse2d.png",function(){create_primitive("ellipse2d")})).render($("#2Dprimitives"));
(new Action("Rectangle 2D","/static/images/rectangle2d.png",function(){create_primitive("rectangle2d")})).render($("#2Dprimitives"));(new Action("Triangle 2D","/static/images/triangle2d.png",function(){create_primitive("triangle2d")})).render($("#2Dprimitives"));(new Action("Text 2D","/static/images/text2d.png",function(){create_primitive("text2d")})).render($("#2Dprimitives"));(new Action("Ellipse 1D","/static/images/ellipse1d.png",function(){create_primitive("ellipse1d")})).render($("#1Dprimitives"));
(new Action("Polyline","/static/images/polyline.png",function(){create_primitive("polyline")})).render($("#1Dprimitives"));(new Action("Bezier","/static/images/bezier.png",function(){create_primitive("bezier")})).render($("#1Dprimitives"));(new Action("Union","/static/images/union.png",function(a){bool(a,"union")})).render($("#boolean"));(new Action("Subtract","/static/images/diff.png",function(a){bool(a,"subtract")})).render($("#boolean"));(new Action("Intersect","/static/images/intersect.png",function(a){bool(a,
"intersect")})).render($("#boolean"));(new Action("Explode","/static/images/explode.png",function(a){explode(a,"intersect")})).render($("#edit"));(new Action("Loft","/static/images/loft.png",function(a){bool(a,"loft")})).render($("#boolean"));(new Action("Prism","/static/images/prism.png",function(a){new SS.PrismCreator(create_modifier(a,"prism"))})).render($("#modifiers"));(new Action("Revolve","/static/images/revolve.png",function(a){new SS.RevolveCreator(create_modifier(a,"revolve"))})).render($("#modifiers"));
(new Action("Fillet","/static/images/fillet.png",function(a){new SS.FilletCreator(create_modifier(a,"fillet"))})).render($("#modifiers"));var a=new Action("Create Face","/static/images/make_face.png",function(a){bool(a,"make_face")}),b=new Action("Create Solid","/static/images/make_solid.png",function(a){bool(a,"make_solid")});a.render($("#modifiers"));a.render($("#boolean"));b.render($("#modifiers"));b.render($("#boolean"));(new Action("AxisMirror","/static/images/axis_mirror.png",function(a){a=
create_transform(a,"axis_mirror");new SS.AxisMirrorTransformCreator(a)})).render($("#transforms"));(new Action("PlaneMirror","/static/images/plane_mirror.png",function(a){a=create_transform(a,"plane_mirror");new SS.PlaneMirrorTransformCreator(a)})).render($("#transforms"))});$("#action-save").click(function(){SS.save()});$("#action-import-json").click(function(){$("#json-file-select-input").click()});$("#action-import-stl").click(function(){$("#stl-file-select-input").click()});
(function(){var a=function(a,c){if(window.FileReader){var d=new FileReader;d.onload=function(d){2===d.target.readyState&&(a.value="",c(d.target.result))};d.readAsBinaryString(a.files[0])}else alert("No FileReader support yet in this browser. Please try Google Chrome or Firefox")};$("#json-file-select-input").change(function(){a(this,importJSON)});$("#stl-file-select-input").change(function(){a(this,function(a){a=new GeomNode({type:"import_stl",contents:btoa(a)});a=create_geom_command(void 0,a);SS.commandStack.execute(a)})})})();
$("#action-export-stl").click(function(){window.location="/"+SS.session.username+"/"+SS.session.design+"/stl/"+SS.session.commit+"/"});$("#action-export-json").click(function(){window.location="/"+SS.session.username+"/"+SS.session.design+"/json/"+SS.session.commit+"/"});$("#action-export-thingiverse").click(function(){$("#black-overlay").show();$("#thingiverse-export").show()});$("form#thingiverse-export").submit(function(){$("input[type=submit]",this).attr("disabled","disabled")});
$("#thingiverse-export input.ok").click(function(){$("#thingiverse-export input.ok").attr("disabled","disabled");$.ajax({type:"POST",url:"/"+SS.session.username+"/"+SS.session.design+"/stl/publish/"+SS.session.commit,data:JSON.stringify({}),success:function(){var a=SS.session.host+"/"+SS.session.username+"/"+SS.session.design+"/stl/"+SS.session.commit+".stl";$("#public_stl_location_b64").val(window.btoa(a));$("#thingiyverse-export-form").submit();$("#black-overlay").hide();$("#thingiverse-export").hide();
$("#thingiverse-export input.ok").removeAttr("disabled")},error:function(a){alert(a.responseText);$("#thingiverse-export input.ok").removeAttr("disabled")}});return!1});$("#thingiverse-export input.cancel").click(function(){$("#black-overlay").hide();$("#thingiverse-export").hide();return!1});SS=SS||{};
function update_geom_command(a,b,c){var d=function(a,e,f){var g=e[a],h=f[a];h&&$.ajax({type:"POST",url:!(a+1<e.length)?"/"+SS.session.username+"/"+SS.session.design+"/geom?mesh=true":"/"+SS.session.username+"/"+SS.session.design+"/geom/",contentType:"application/json",data:h.toShallowJson(),dataType:"json",success:function(q){h.setSHA(q.SHA);h.editing=!1;for(var r in h.transforms)h.transforms[r].editing=!1;if(a+1<e.length){r=-1;var s=e[a+1],w;for(w in s.children)if(s.children[w]==g||s.children[w]==c)r=
w;if(-1===r)throw"child not found";f[a+1].children.splice(r,1,h)}a+1<e.length?d(a+1,e,f):(h.mesh=q.mesh,0==a?geom_doc.replace(b,h):geom_doc.replace(g,h),SS.commandStack.commit())},error:function(a){SS.commandStack.error(a.responseText)}})},e=geom_doc.ancestors(b),f=e.map(function(a){return a.editableCopy()}),g=[a].concat(e),h=[c.editableCopy()].concat(f);return new Command(function(){d(0,g,h)},function(){geom_doc.replace(h[h.length-1],g[g.length-1]);SS.commandStack.success()},function(){geom_doc.replace(g[h.length-
1],h[g.length-1]);SS.commandStack.success()})}
function create_geom_command(a,b){var c;return new Command(function(){$.ajax({type:"POST",url:"/"+SS.session.username+"/"+SS.session.design+"/geom?mesh=true",contentType:"application/json",data:JSON.stringify(b),dataType:"json",success:function(d){b.sha=d.SHA;c=new GeomNode(b);c.mesh=d.mesh;a?geom_doc.replace(a,c):geom_doc.add(c);SS.commandStack.commit()},error:function(a){SS.commandStack.error(a.responseText)}})},function(){geom_doc.remove(c);SS.commandStack.success()},function(){geom_doc.add(c);
SS.commandStack.success()})}
function explode(a){if(1!==a.length)alert("must have 1 object selected");else{var b=geom_doc.findById(a[0]),c=b.children;0===c.length?alert("You can only explode an item with children (e.g. booleans)"):(a=new Command(function(){var a=c.filter(function(a){return!a.mesh}),e=function(){geom_doc.remove(b);c.map(function(a){geom_doc.add(a)});SS.commandStack.commit()};0==a.length?e():a.slice(0).map(function(b){$.ajax({type:"GET",url:"/"+SS.session.username+"/"+SS.session.design+"/mesh/"+b.sha,success:function(c){b.mesh=
c;a.splice(a.indexOf(b),1);0==a.length&&e()},error:function(a){SS.commandStack.error(a.responseText)}})})},function(){c.map(function(a){geom_doc.remove(a)});geom_doc.add(b);SS.commandStack.success()},function(){geom_doc.remove(b);c.reverse().map(function(a){geom_doc.add(a)});SS.commandStack.success()}),SS.commandStack.execute(a))}}
function bool(a,b){var c,d,e=new Command(function(){var e={type:b,children:a.map(function(a){return a.match(/^([0-9]+)_(.*)$/)[2]}),workplane:SS.workplaneModel.node.editableCopy()};$.ajax({type:"POST",url:"/"+SS.session.username+"/"+SS.session.design+"/geom?mesh=true",contentType:"application/json",data:JSON.stringify(e),success:function(b){e.sha=b.SHA;d=a.map(function(a){a=geom_doc.findById(a);geom_doc.remove(a);return a});c=new GeomNode(e,d);c.mesh=b.mesh;geom_doc.add(c);SS.commandStack.commit()},
error:function(a){SS.commandStack.error(a.responseText)}})},function(){geom_doc.remove(c);d.reverse().map(function(a){geom_doc.add(a)});SS.commandStack.success()},function(){d.map(function(a){geom_doc.remove(a)});geom_doc.add(c);SS.commandStack.success()});SS.commandStack.execute(e)}function copy(a){1!==a.length?alert("must have 1 object selected"):(a=geom_doc.findById(a[0]),copyNode(a))}
function importJSON(a){var b=JSON.parse(a),c=[],d={},e=function(a){for(var g=0;g<a.length;++g){if(a[g].children&&e(a[g].children))return!0;if("string"!==typeof a[g])return $.ajax({type:"POST",url:a===b?"/"+SS.session.username+"/"+SS.session.design+"/geom?mesh=true":"/"+SS.session.username+"/"+SS.session.design+"/geom",contentType:"application/json",data:JSON.stringify(a[g]),dataType:"json",success:function(c){a[g].sha=c.SHA;var j=new GeomNode(a[g],(a[g].children||[]).map(function(a){return d[a]}));
c.mesh&&(j.mesh=c.mesh);d[c.SHA]=j;a[g]=c.SHA;e(b)},error:function(a){SS.commandStack.error(a.responseText)}}),!0}a===b&&(a.map(function(a){a=d[a];c.push(a);geom_doc.add(a)}),SS.commandStack.commit());return!1};SS.commandStack.execute(new Command(function(){e(b)},function(){c.map(function(a){geom_doc.remove(a)});SS.commandStack.success()},function(){c.map(function(a){geom_doc.add(a)});SS.commandStack.success()}))}
function copyNode(a){var b,c=new Command(function(){var c=function(a){var b=a.children.map(function(a){return c(a)});return new GeomNode(a,b)};b=c(a);b.mesh?(geom_doc.add(b),SS.commandStack.commit()):$.ajax({type:"GET",url:"/"+SS.session.username+"/"+SS.session.design+"/mesh/"+b.sha,success:function(a){b.mesh=a;geom_doc.add(b);SS.commandStack.commit()},error:function(a){SS.commandStack.error(a.responseText)}})},function(){geom_doc.remove(b);SS.commandStack.success()},function(){geom_doc.add(b);SS.commandStack.success()});
SS.commandStack.execute(c)}SS.save=function(){SS.spinner.show();$.ajax({type:"PUT",url:"/"+SS.session.username+"/"+SS.session.design+"/refs/heads/master/",contentType:"application/json",data:JSON.stringify(SS.session.commit),success:function(){console.info("SAVE: "+SS.session.commit);SS.renderInfoMessage("Saved");SS.spinner.hide()},error:function(a){SS.spinner.hide();SS.renderErrorMessage(a.responseText)}})};
SS.commit=function(){var a={geoms:geom_doc.rootNodes.filter(function(a){return!a.editing}).map(function(a){return a.sha}),workplane:SS.workplaneModel.node,parent:SS.session.commit};$.ajax({type:"POST",url:"/"+SS.session.username+"/"+SS.session.design+"/commit/",contentType:"application/json",data:JSON.stringify(a),success:function(a){a=a.SHA;console.info("COMMIT: "+a);history.pushState({commit:a},SS.session.design,window.location.pathname+"?commit="+a);SS.session.commit=a;SS.commandStack.success()},
error:function(a){SS.commandStack.error(a.responseText)}})};SS.loadCommitFromStateOrParam=function(a){a=a&&a.commit||$.getQueryParam("commit");SS.session.commit=a;SS.commandStack.pop(a)||SS.load_commit(a)};window.onpopstate=function(a){SS.loadCommitFromStateOrParam(a.state)};
SS.load_commit=function(a){geom_doc.removeAll();SS.session.commit=a;console.log("Load commit: "+a);SS.spinner.show();$.ajax({type:"GET",url:"/"+SS.session.username+"/"+SS.session.design+"/commit/"+a,dataType:"json",success:function(a){SS.spinner.hide();console.log("Load design: "+JSON.stringify(a));a.workplane?SS.workplaneModel.loadNode(new SS.WorkplaneNode(a.workplane)):SS.workplaneModel.loadNode(new SS.WorkplaneNode);a.geoms.map(function(a){SS.load_geom(a)})},error:function(a){SS.spinner.hide();
SS.renderErrorMessage(a.responseText)}})};
SS.load_geom=function(a){console.info("Loading geom: "+a);SS.spinner.show();$.ajax({type:"GET",url:"/"+SS.session.username+"/"+SS.session.design+"/geom/"+a+"?recursive=true",dataType:"json",success:function(b){var c=GeomNode.fromDeepJson(b);$.ajax({type:"GET",url:"/"+SS.session.username+"/"+SS.session.design+"/mesh/"+a,success:function(a){c.mesh=a;geom_doc.add(c);SS.spinner.hide()},error:function(a){SS.spinner.hide();SS.renderErrorMessage(a.responseText)}})},error:function(a){SS.spinner.hide();SS.renderErrorMessage(a.responseText)}})};
